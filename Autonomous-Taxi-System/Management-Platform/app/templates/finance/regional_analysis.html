{% extends "finance/analysis_base.html" %}

{% block analysis_content %}

                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    此页面将包含区域收支对比、城市业绩雷达图等图表。目前为功能预留页面。
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">{{ _("区域收支对比") }}</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <canvas id="regionalIncomeExpenseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">{{ _("城市业绩雷达图") }}</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <canvas id="cityPerformanceRadarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">{{ _("订单数量地理分布") }}</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <div id="orderCountMap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">{{ _("订单金额地理分布") }}</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <div id="orderAmountMap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
      
{% endblock %}

{% block analysis_scripts %}
<script>
// 区域分析页面的图表初始化代码
document.addEventListener('DOMContentLoaded', function() {
    // 检查所需的库是否加载
    function checkAndLoadLibraries() {
        // 定义需要加载的库和它们的URL
        const requiredLibraries = [
            { name: 'Chart', globalVar: 'Chart', url: 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js' },
            { name: 'ECharts', globalVar: 'echarts', url: 'https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js' }
        ];
        
        let allLoaded = true;
        let loadingPromises = [];
        
        // 检查每个库
        for (const lib of requiredLibraries) {
            if (typeof window[lib.globalVar] === 'undefined') {
                allLoaded = false;
                console.error(`${lib.name}未能加载，尝试重新加载`);
                
                // 创建加载Promise
                const loadPromise = new Promise((resolve, reject) => {
                    const scriptElement = document.createElement('script');
                    scriptElement.src = lib.url;
                    scriptElement.onload = () => {
                        console.log(`${lib.name}加载成功`);
                        resolve();
                    };
                    scriptElement.onerror = () => {
                        console.error(`${lib.name}加载失败`);
                        reject(new Error(`Failed to load ${lib.name}`));
                    };
                    document.head.appendChild(scriptElement);
                });
                
                loadingPromises.push(loadPromise);
            }
        }
        
        // 如果所有库都已加载，直接初始化图表
        if (allLoaded) {
            initCharts();
            return;
        }
        
        // 否则等待所有库加载完成后再初始化
        Promise.all(loadingPromises)
            .then(() => {
                console.log('所有图表库加载完成，开始初始化图表');
                initCharts();
            })
            .catch(error => {
                console.error('图表库加载失败:', error);
                alert('图表库加载失败，请刷新页面重试');
            });
    }
    
    // 初始化所有图表
    function initCharts() {
        // 区域收支对比图
        initIncomeExpenseChart();
        // 城市业绩雷达图
        initCityPerformanceChart();
        // 地图相关图表
        initOrderCountMap();
        initOrderAmountMap();
    }

    // 区域收支对比图初始化
    function initIncomeExpenseChart() {
        const ctx = document.getElementById('regionalIncomeExpenseChart');
        if (!ctx) return;
        
        const incomeExpenseCtx = ctx.getContext('2d');
        new Chart(incomeExpenseCtx, {
            type: 'bar',
            data: {
                labels: ['沈阳市', '上海市', '北京市', '广州市', '深圳市'],
                datasets: [
                    {
                        label: '收入',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(40, 167, 69, 0.7)'
                    },
                    {
                        label: '支出',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(220, 53, 69, 0.7)'
                    },
                    {
                        label: '利润',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(0, 123, 255, 0.7)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '区域收支对比 - 功能开发中'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '金额(元)'
                        }
                    }
                }
            }
        });
    }
    
    // 城市业绩雷达图初始化
    function initCityPerformanceChart() {
        const ctx = document.getElementById('cityPerformanceRadarChart');
        if (!ctx) return;
        
        const radarCtx = ctx.getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['订单量', '收入', '平均订单金额', '车辆数', '利润率'],
                datasets: [
                    {
                        label: '沈阳市',
                        data: [0, 0, 0, 0, 0],
                        fill: true,
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderColor: 'rgba(0, 123, 255, 0.8)',
                        pointBackgroundColor: 'rgba(0, 123, 255, 1)'
                    },
                    {
                        label: '上海市',
                        data: [0, 0, 0, 0, 0],
                        fill: true,
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderColor: 'rgba(40, 167, 69, 0.8)',
                        pointBackgroundColor: 'rgba(40, 167, 69, 1)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '城市业绩雷达图 - 功能开发中'
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // 订单数量地图初始化
    function initOrderCountMap() {
        const chartDom = document.getElementById('orderCountMap');
        if (!chartDom || typeof echarts === 'undefined') return;
        
        const myChart = echarts.init(chartDom);
        
        // 使用一个安全的方式获取数据
        let geoData = [];
        try {
            geoData = {{ finance_data.order_geo_data|tojson if finance_data and finance_data.order_geo_data else '[]'|safe }};
            // 确保geoData是数组
            if (!Array.isArray(geoData)) {
                geoData = [];
            }
        } catch (e) {
            console.error("解析订单地理数据失败:", e);
        }
        
        // 确保数据有效
        if (geoData.length === 0) {
            chartDom.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-exclamation-circle"></i><p class="mt-3">{{ _("当月暂无订单数据") }}</p></div>';
            return;
        }
        
        // 初始化地图
        initMapWithData(myChart, geoData, "订单数量分布", false, chartDom);
    }
    
    // 订单金额地图初始化
    function initOrderAmountMap() {
        const chartDom = document.getElementById('orderAmountMap');
        if (!chartDom || typeof echarts === 'undefined') return;
        
        const myChart = echarts.init(chartDom);
        
        // 使用一个安全的方式获取数据
        let geoData = [];
        try {
            geoData = {{ finance_data.order_amount_geo_data|tojson if finance_data and finance_data.order_amount_geo_data else '[]'|safe }};
            // 确保geoData是数组
            if (!Array.isArray(geoData)) {
                geoData = [];
            }
        } catch (e) {
            console.error("解析订单金额地理数据失败:", e);
        }
        
        // 确保数据有效
        if (geoData.length === 0) {
            chartDom.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-exclamation-circle"></i><p class="mt-3">{{ _("当月暂无订单金额数据") }}</p></div>';
            return;
        }
        
        // 初始化地图
        initMapWithData(myChart, geoData, "订单金额分布", true, chartDom);
    }
    
    // 地图数据初始化通用函数
    function initMapWithData(chart, data, title, isAmount, chartDom) {
        if (!chart || !data || !chartDom) return;
        
        // 计算最大值，避免除以0
        const maxValue = Math.max(...data.map(item => item.value)) || 1;
        
        // 使用fetch API加载中国地图数据
        fetch("{{ url_for('static', filename='js/china.json') }}")
            .then(response => response.json())
            .then(chinaJson => {
                if (typeof echarts === 'undefined') {
                    console.error("ECharts库未加载，无法初始化地图");
                    chartDom.innerHTML = '<div class="text-center mt-5">图表加载失败，请刷新页面重试</div>';
                    return;
                }
                
                echarts.registerMap('china', chinaJson);
                
                const option = {
                    title: {
                        text: title,
                        left: 'center',
                        textStyle: {
                            fontSize: 14
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const value = params.value || 0;
                            if (isAmount) {
                                return `${params.name}: ¥${value.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
                            } else {
                                return `${params.name}: ${value}单`;
                            }
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: maxValue,
                        left: 'left',
                        top: 'bottom',
                        text: ['高', '低'],
                        calculable: true,
                        inRange: {
                            color: isAmount ? 
                                ['#e9f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#31a354', '#006d2c'] :
                                ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                        }
                    },
                    series: [{
                        name: isAmount ? '订单金额' : '订单数量',
                        type: 'map',
                        map: 'china',
                        roam: true,
                        emphasis: {
                            label: {
                                show: true
                            }
                        },
                        data: data,
                        itemStyle: {
                            borderColor: '#999',
                            borderWidth: 1,
                            areaColor: '#f3f3f3'
                        }
                    }]
                };
                
                chart.setOption(option);
            })
            .catch(error => {
                console.error('加载地图数据失败:', error);
                if (chartDom) {
                    chartDom.innerHTML = '<div class="text-center mt-5">地图加载失败，请刷新页面重试</div>';
                }
            });
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            if (chart && typeof chart.resize === 'function') {
                chart.resize();
            }
        });
    }
    
    // 开始检查并加载库
    checkAndLoadLibraries();
});
</script>
{% endblock %} 