{% extends "base.html" %}

{% block title %}财务管理 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications/notifications.css') }}">
<style>
  /* 图表悬停提示样式 */
  .card-header {
    position: relative;
  }
  .chart-info-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 0 0 10px 10px;
    font-size: 14px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    line-height: 1.5;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    max-height: 300px;
    overflow-y: auto;
  }
  .card-header:hover .chart-info-tooltip {
    opacity: 1;
    visibility: visible;
  }
  
  /* 选项卡激活状态样式 */
  .nav-tabs .nav-link.active {
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: #fff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    font-weight: 500;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    border-color: transparent;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ _("财务管理") }} 
                <span class="badge bg-primary">
                    {% if finance_data and finance_data.month_display %}{{ finance_data.month_display }}{% else %}{{ _("当前月份") }}{% endif %}
                </span>
            </h2>
            <p class="text-muted">{{ _("管理无人驾驶出租车平台的收入、成本和财务报表") }}</p>
        </div>
        <div class="col-auto d-flex align-items-center">
            <!-- 月份选择器 -->
            <div class="d-flex me-3">
                <input type="month" class="form-control me-2" id="selectedMonth" name="month" 
                       value="{{ selected_month if selected_month else current_month_value }}" 
                       style="height: 38px;" />
                <button type="button" id="viewMonthBtn" class="btn btn-outline-primary" style="height: 38px;width: 75px;">{{ _("查看") }}</button>
            </div>
            
            <a href="{{ url_for('finance.income') }}" class="btn btn-primary me-2"><i class="bi bi-graph-up-arrow"></i> {{ _("收入记录") }}</a>
            <a href="{{ url_for('finance.expense') }}" class="btn btn-warning me-2"><i class="bi bi-graph-down-arrow"></i> {{ _("支出记录") }}</a>

        </div>
    </div>

    <!-- 财务概览卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-primary">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{% if finance_data and finance_data.income %}{{ finance_data.income.formatted }}{% else %}¥0{% endif %}</div>
                        <div class="notification-label">{{ _("总收入") }}</div>
                        <div class="notification-trend {% if finance_data and finance_data.income and finance_data.income.growth_rate >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="bi bi-arrow-{% if finance_data and finance_data.income and finance_data.income.growth_rate >= 0 %}up{% else %}down{% endif %}"></i> 
                            {{ "%.1f"|format(finance_data.income.growth_rate|abs) if finance_data and finance_data.income else "0.0" }}% vs {% if finance_data and finance_data.last_month_display %}{{ finance_data.last_month_display }}{% else %}上月{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-danger">
                        <i class="bi bi-calculator"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{% if finance_data and finance_data.expense %}{{ finance_data.expense.formatted }}{% else %}¥0{% endif %}</div>
                        <div class="notification-label">{{ _("运营成本") }}</div>
                        <div class="notification-trend {% if finance_data and finance_data.expense and finance_data.expense.growth_rate <= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="bi bi-arrow-{% if finance_data and finance_data.expense and finance_data.expense.growth_rate >= 0 %}up{% else %}down{% endif %}"></i> 
                            {{ "%.1f"|format(finance_data.expense.growth_rate|abs) if finance_data and finance_data.expense else "0.0" }}% vs {% if finance_data and finance_data.last_month_display %}{{ finance_data.last_month_display }}{% else %}上月{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-success">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{% if finance_data and finance_data.profit %}{{ finance_data.profit.formatted }}{% else %}¥0{% endif %}</div>
                        <div class="notification-label">{{ _("净利润") }}</div>
                        <div class="notification-trend {% if finance_data and finance_data.profit and finance_data.profit.growth_rate >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="bi bi-arrow-{% if finance_data and finance_data.profit and finance_data.profit.growth_rate >= 0 %}up{% else %}down{% endif %}"></i> 
                            {{ "%.1f"|format(finance_data.profit.growth_rate|abs) if finance_data and finance_data.profit else "0.0" }}% vs {% if finance_data and finance_data.last_month_display %}{{ finance_data.last_month_display }}{% else %}上月{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-info">
                        <i class="bi bi-percent"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{% if finance_data and finance_data.profit_rate %}{{ finance_data.profit_rate.formatted }}{% else %}0.0%{% endif %}</div>
                        <div class="notification-label">{{ _("利润率") }}</div>
                        <div class="notification-trend {% if finance_data and finance_data.profit_rate and finance_data.profit_rate.growth_rate >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="bi bi-arrow-{% if finance_data and finance_data.profit_rate and finance_data.profit_rate.growth_rate >= 0 %}up{% else %}down{% endif %}"></i> 
                            {{ "%.1f"|format(finance_data.profit_rate.growth_rate|abs) if finance_data and finance_data.profit_rate else "0.0" }}% vs {% if finance_data and finance_data.last_month_display %}{{ finance_data.last_month_display }}{% else %}上月{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,150,255,0.3); box-shadow: 0 0 15px rgba(0,100,255,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(25,60,125,0.8), rgba(45,120,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link active text-white" href="#revenue" data-bs-toggle="tab"><i class="fas fa-chart-line me-1"></i>收入趋势</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#costs" data-bs-toggle="tab"><i class="fas fa-chart-line me-1"></i>成本分析</a>
                        </li>
                        <li class="nav-item">  
                            <a class="nav-link text-white" href="#profit" data-bs-toggle="tab"><i class="fas fa-chart-line me-1"></i>利润走势</a>
                        </li>
                    </ul>
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> income表和expense表中的每日收支数据</p>
                        <p><strong>分析目的:</strong> 分析每日财务状况变化，识别特定日期的收支异常</p>
                        <p><strong>图表说明:</strong> 折线图展示每日的收入、支出和利润走势，支持切换不同视图</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane active" id="revenue">
                            <div style="height: 350px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane" id="costs">
                            <div style="height: 350px;">
                                <canvas id="expenseChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane" id="profit">
                            <div style="height: 350px;">
                                <canvas id="profitChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,150,150,0.3); box-shadow: 0 0 15px rgba(255,100,100,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(150,25,60,0.8), rgba(255,60,120,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                    <h5 class="card-title mb-0 text-white">
                        <i class="fas fa-chart-pie me-1"></i>收入来源分布
                    </h5>
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> income表中的收入类型分类统计</p>
                        <p><strong>分析目的:</strong> 了解各类收入来源占比，优化收入结构</p>
                        <p><strong>图表说明:</strong> 环形图直观展示各收入类型占总收入的百分比</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="revenueSourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增地图分布图表行 -->
    <div class="row mb-4">
        <!-- 订单数量分布地图 -->
        <div class="col-lg-6">
            <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(150,200,150,0.3); box-shadow: 0 0 15px rgba(100,200,100,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(25,125,60,0.8), rgba(45,200,120,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-globe me-1"></i>订单数量地理分布
                    </h5>
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表中的地理位置数据统计</p>
                        <p><strong>分析目的:</strong> 识别高需求地区，优化车辆调度和市场推广策略</p>
                        <p><strong>图表说明:</strong> 中国地图热力图展示各省份订单数量，深色区域表示订单量大</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 400px;">
                        <div id="orderCountMap" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 订单金额分布地图 -->
        <div class="col-lg-6">
            <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,200,255,0.3); box-shadow: 0 0 15px rgba(0,150,255,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(25,80,150,0.8), rgba(45,150,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-globe me-1"></i>订单金额地理分布
                    </h5>
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表中的订单金额和地理位置数据</p>
                        <p><strong>分析目的:</strong> 分析不同地区的订单价值，发现高价值市场</p>
                        <p><strong>图表说明:</strong> 中国地图热力图展示各省份订单总金额，绿色深浅代表金额大小</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 400px;">
                        <div id="orderAmountMap" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增财务分析模块导航卡片 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="border-radius:15px; border: 1px solid rgba(150,150,255,0.3); box-shadow: 0 0 15px rgba(100,100,255,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(60,25,150,0.8), rgba(120,60,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                    <h5 class="mb-0 text-white">{{ _("财务详细分析") }}</h5>
                </div>
                <div class="card-body">
                    <div class="row g-6">
                        <!-- 收入分析卡片 -->
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-graph-up-arrow text-primary fs-1 mb-3"></i>
                                    <h5 class="card-title">{{ _("收入分析") }}</h5>
                                    <p class="card-text text-muted">{{ _("深入分析各类收入来源和趋势") }}</p>
                                    <a href="{{ url_for('finance.income_analysis') }}?month={{ selected_month if selected_month else current_month_value }}" class="btn btn-outline-primary mt-2">{{ _("查看详情") }}</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 支出分析卡片 -->
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-graph-down-arrow text-danger fs-1 mb-3"></i>
                                    <h5 class="card-title">{{ _("支出分析") }}</h5>
                                    <p class="card-text text-muted">{{ _("分析成本结构和支出趋势") }}</p>
                                    <a href="{{ url_for('finance.expense_analysis') }}?month={{ selected_month if selected_month else current_month_value }}" class="btn btn-outline-danger mt-2">{{ _("查看详情") }}</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 利润分析卡片 -->
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-currency-yen text-success fs-1 mb-3"></i>
                                    <h5 class="card-title">{{ _("利润分析") }}</h5>
                                    <p class="card-text text-muted">{{ _("分析利润形成和变化趋势") }}</p>
                                    <a href="{{ url_for('finance.profit_analysis') }}?month={{ selected_month if selected_month else current_month_value }}" class="btn btn-outline-success mt-2">{{ _("查看详情") }}</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 用户消费分析卡片 -->
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-people text-info fs-1 mb-3"></i>
                                    <h5 class="card-title">{{ _("用户消费分析") }}</h5>
                                    <p class="card-text text-muted">{{ _("分析用户消费行为和模式") }}</p>
                                    <a href="{{ url_for('finance.user_consumption_analysis') }}?month={{ selected_month if selected_month else current_month_value }}" class="btn btn-outline-info mt-2">{{ _("查看详情") }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/china-map-data@0.1.0/dist/china.js"></script>

<script>
    // 处理日期选择器和查看按钮事件
    document.addEventListener('DOMContentLoaded', function() {
        const monthInput = document.getElementById('selectedMonth');
        const viewMonthBtn = document.getElementById('viewMonthBtn');
        
        viewMonthBtn.addEventListener('click', function() {
            const month = monthInput.value;
            if (month) {
                // 构建URL并跳转
                window.location.href = "{{ url_for('finance.index') }}?month=" + month;
            }
        });
        
        // 添加回车键提交功能
        monthInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                viewMonthBtn.click();
            }
        });
    });

    // 收入趋势图表
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    
    // 生成日期标签
    const currentDate = new Date();
    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    const dateLabels = [];
    
    for (let i = 1; i <= daysInMonth; i++) {
        dateLabels.push(`${i}日`);
    }
    
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: dateLabels,
            datasets: [{
                label: '日收入 (元)',
                data: {{ finance_data.daily_revenues|tojson if finance_data and finance_data.daily_revenues else '[]'|safe }},
                borderColor: 'rgba(0, 123, 255, 1)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // 成本分析图表
    const expenseCtx = document.getElementById('expenseChart').getContext('2d');
    
    const expenseChart = new Chart(expenseCtx, {
        type: 'line',
        data: {
            labels: dateLabels,
            datasets: [
                {
                    label: '日收入 (元)',
                    data: {{ finance_data.daily_revenues|tojson if finance_data and finance_data.daily_revenues else '[]'|safe }},
                    borderColor: 'rgba(0, 123, 255, 1)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    order: 1
                },
                {
                    label: '日支出 (元)',
                    data: {{ finance_data.daily_expenses|tojson if finance_data and finance_data.daily_expenses else '[]'|safe }},
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    order: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        footer: function(tooltipItems) {
                            // 计算当日利润
                            const incomeValue = tooltipItems[0].parsed.y || 0;
                            const expenseValue = tooltipItems[1]?.parsed.y || 0;
                            const profit = incomeValue - expenseValue;
                            
                            return '日利润: ' + (profit >= 0 ? '¥' : '-¥') + 
                                    Math.abs(profit).toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // 利润走势图表
    const profitCtx = document.getElementById('profitChart').getContext('2d');
    
    const profitChart = new Chart(profitCtx, {
        type: 'line',
        data: {
            labels: dateLabels,
            datasets: [{
                label: '日利润 (元)',
                data: {{ finance_data.daily_profits|tojson if finance_data and finance_data.daily_profits else '[]'|safe }},
                borderColor: function(context) {
                    const value = context.raw;
                    return value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)';
                },
                backgroundColor: function(context) {
                    const value = context.raw;
                    return value >= 0 ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';
                },
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            let value = context.parsed.y;
                            if (label) {
                                label += ': ';
                            }
                            if (value < 0) {
                                label += '-¥' + Math.abs(value).toLocaleString();
                            } else {
                                label += '¥' + value.toLocaleString();
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 0) {
                                return 'rgba(0, 0, 0, 0.5)'; // 零线更粗/更暗
                            }
                            return 'rgba(0, 0, 0, 0.1)'; // 其他网格线
                        },
                        lineWidth: function(context) {
                            if (context.tick.value === 0) {
                                return 2; // 零线更粗
                            }
                            return 1; // 其他网格线
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            if (value < 0) {
                                return '-¥' + Math.abs(value).toLocaleString();
                            }
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // 收入来源分布饼图
    const revenueSourceCtx = document.getElementById('revenueSourceChart').getContext('2d');
    
    const backgroundColors = [
        'rgba(0, 123, 255, 0.7)',
        'rgba(40, 167, 69, 0.7)',
        'rgba(255, 193, 7, 0.7)',
        'rgba(220, 53, 69, 0.7)',
        'rgba(108, 117, 125, 0.7)',
        'rgba(23, 162, 184, 0.7)',
        'rgba(111, 66, 193, 0.7)'
    ];
    
    const revenueSourceChart = new Chart(revenueSourceCtx, {
        type: 'doughnut',
        data: {
            labels: {{ finance_data.revenue_sources|tojson if finance_data and finance_data.revenue_sources else '[]'|safe }},
            datasets: [{
                data: {{ finance_data.revenue_amounts|tojson if finance_data and finance_data.revenue_amounts else '[]'|safe }},
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // 初始化订单数量分布地图
    function initOrderCountMap() {
        // 创建地图实例
        const chartDom = document.getElementById('orderCountMap');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        
        // 获取数据
        const geoData = {{ finance_data.order_geo_data|tojson if finance_data and finance_data.order_geo_data else '[]'|safe }};
        
        // 调试
        console.log("订单地理分布数据:", geoData);
        
        // 确保数据有效
        if (!Array.isArray(geoData) || geoData.length === 0) {
            console.error('订单地理分布数据为空或格式错误');
            
            // 显示空数据提示
            chartDom.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-exclamation-circle fs-1"></i><p class="mt-3">{{ finance_data.month_display if finance_data and finance_data.month_display else "当月" }}暂无订单数据</p></div>';
            return;
        }
        
        // 初始化地图
        initMapWithData(myChart, geoData, "{{ finance_data.month_display if finance_data and finance_data.month_display else '当月' }}订单数量分布");
    }
    
    // 初始化订单金额分布地图
    function initOrderAmountMap() {
        // 创建地图实例
        const chartDom = document.getElementById('orderAmountMap');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        
        // 获取数据
        const geoData = {{ finance_data.order_amount_geo_data|tojson if finance_data and finance_data.order_amount_geo_data else '[]'|safe }};
        
        // 调试
        console.log("订单金额地理分布数据:", geoData);
        
        // 确保数据有效
        if (!Array.isArray(geoData) || geoData.length === 0) {
            console.error('订单金额地理分布数据为空或格式错误');
            
            // 显示空数据提示
            chartDom.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-exclamation-circle fs-1"></i><p class="mt-3">{{ finance_data.month_display if finance_data and finance_data.month_display else "当月" }}暂无订单金额数据</p></div>';
            return;
        }
        
        // 初始化地图
        initMapWithData(myChart, geoData, "{{ finance_data.month_display if finance_data and finance_data.month_display else '当月' }}订单金额分布", true);
    }
    
    // 提取公共地图初始化逻辑
    function initMapWithData(chart, data, title, isAmount = false) {
        // 计算最大值，避免除以0
        const maxValue = Math.max(...data.map(item => item.value)) || 1;
        
        // 使用fetch API加载中国地图数据
        fetch("{{ url_for('static', filename='js/china.json') }}")
            .then(response => response.json())
            .then(chinaJson => {
                echarts.registerMap('china', chinaJson);
                
                const option = {
                    title: {
                        text: title,
                        left: 'center',
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const value = params.value || 0;
                            if (isAmount) {
                                return `${params.name}: ¥${value.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
                            } else {
                                return `${params.name}: ${value}单`;
                            }
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: maxValue,
                        left: 'left',
                        top: 'bottom',
                        text: ['高', '低'],
                        calculable: true,
                        inRange: {
                            color: isAmount ? 
                                ['#e9f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#31a354', '#006d2c'] :
                                ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                        }
                    },
                    series: [{
                        name: isAmount ? '订单金额' : '订单数量',
                        type: 'map',
                        map: 'china',
                        roam: true,
                        emphasis: {
                            label: {
                                show: true
                            }
                        },
                        data: data,
                        itemStyle: {
                            borderColor: '#999',
                            borderWidth: 1,
                            areaColor: '#f3f3f3'
                        }
                    }]
                };
                
                chart.setOption(option);
            })
            .catch(error => {
                console.error('加载地图数据失败:', error);
                chartDom.innerHTML = '<div class="text-center mt-5">地图加载失败，请刷新页面重试</div>';
            });
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }

    // 初始化所有地图
    document.addEventListener('DOMContentLoaded', function() {
        initOrderCountMap();
        initOrderAmountMap();
    });
</script>
{% endblock %} 