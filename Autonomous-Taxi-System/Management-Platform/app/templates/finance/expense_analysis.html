{% extends "finance/analysis_base.html" %}

{% block title %}支出分析 - 财务管理{% endblock %}

{% block analysis_content %}

    
    
  

    <!-- 统计概览 -->
    <div class="row mb-4">
        <div class="col-xl-4 col-md-6">
            <div class="card bg-light mb-4" style="height: 100%;">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="text-secondary" data-bs-toggle="tooltip" title="{{ _("显示所选时间范围内的总支出金额，包含所有支出项目如运营成本、维护费用等。") }}">{{ _("总支出") }}</div>
                        <div class="text-primary fw-bold h4" id="total-expense">¥0.00</div>
                    </div>
                </div>
               
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card bg-light mb-4" style="height: 100%;">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="text-secondary" data-bs-toggle="tooltip" title="{{ _("按总支出除以天数计算得出的平均每日支出金额，用于分析日常运营成本水平。") }}">日均支出</div>
                        <div class="text-primary fw-bold h4" id="avg-daily-expense">¥0.00</div>
                    </div>
                </div>
               
            </div>
        </div>
        <div class="col-xl-4 col-md-12">
            <div class="card bg-light mb-4" style="height: 100%;">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="text-secondary" data-bs-toggle="tooltip" title="{{ _("与去年同期相比的支出增长百分比，正值表示增加，负值表示减少，用于评估支出控制情况和趋势变化。") }}">同比增长</div>
                        <div class="d-flex align-items-center">
                            <i id="growth-icon" class="fas fa-arrow-down text-danger me-1"></i>
                            <div class="text-danger fw-bold h4" id="expense-growth">0.00%</div>
                        </div>
                    </div>
                </div>
             
            </div>
        </div>
    </div>

    <!-- 主要图表 -->
    <div class="row">
        <!-- 支出趋势图 -->
        <div class="col-xl-8 col-lg-12">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i>
                    日支出趋势
                    <a href="javascript:void(0);" class="ms-2 text-decoration-none info-tooltip" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       data-bs-html="true"
                       title="{{ _("<div style='text-align:left'>展示所选时间区间内每日支出金额的变化趋势。<br/>数据来源：每日支出记录的累计金额。<br/>统计周期：所选时间范围内的每一天。</div>") }}">
                        <i class="bi bi-info-circle-fill text-primary"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:300px;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
          
            </div>
        </div>
        
        <!-- 支出类别饼图 -->
        <div class="col-xl-4 col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    支出类别分布
                    <a href="javascript:void(0);" class="ms-2 text-decoration-none info-tooltip" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       data-bs-html="true"
                       title="{{ _("<div style='text-align:left'>展示不同类别支出所占总支出的比例。<br/>数据来源：按支出类别分组的金额统计。<br/>计算方法：特定类别支出金额/总支出金额。</div>") }}">
                        <i class="bi bi-info-circle-fill text-primary"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:300px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
       
            </div>
        </div>
    </div>

    <!-- 次要图表 -->
    <div class="row">
        <!-- 车辆维护成本 -->
        <div class="col-xl-6 col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-car me-1"></i>
                    车辆维护成本
                    <a href="javascript:void(0);" class="ms-2 text-decoration-none info-tooltip" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       data-bs-html="true"
                       title="{{ _("<div style='text-align:left'>展示各车辆产生的维护支出情况。<br/>数据来源：按车辆ID分组的维护支出记录。<br/>统计范围：包括保养、维修、配件更换等所有维护相关支出。</div>") }}">
                        <i class="bi bi-info-circle-fill text-primary"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:300px;">
                        <canvas id="maintenanceChart"></canvas>
                    </div>
                </div>
              
            </div>
        </div>
        
        <!-- 能源成本分析 -->
        <div class="col-xl-6 col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i>
                    支出类型月度趋势
                    <a href="javascript:void(0);" class="ms-2 text-decoration-none info-tooltip" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       data-bs-html="true"
                       title="{{ _("<div style='text-align:left'>展示不同类型支出随时间的变化情况。<br/>数据来源：按月份和支出类型汇总的支出记录。<br/>统计维度：横轴为时间（月份），纵轴为不同类型支出金额。</div>") }}">
                        <i class="bi bi-info-circle-fill text-primary"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:300px;">
                        <canvas id="expenseTypeChart"></canvas>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- 支出明细表 -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            支出明细
            <a href="javascript:void(0);" class="ms-2 text-decoration-none info-tooltip" 
               data-bs-toggle="tooltip" 
               data-bs-placement="top" 
               data-bs-html="true"
               title="{{ _("<div style='text-align:left'>展示每日支出的详细记录。<br/>数据源：按日期汇总的支出记录。<br/>包含信息：日期、笔数、金额、占总支出比例。</div>") }}">
                <i class="bi bi-info-circle-fill text-primary"></i>
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-bordered table-hover" id="expense-detail-table">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="text-center">{{ _("日期") }}</th>
                            <th class="text-center">{{ _("笔数") }}</th>
                            <th class="text-center">{{ _("金额") }}</th>
                            <th class="text-center">{{ _("占比") }}</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body">
                        <tr>
                            <td colspan="4" class="text-center">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
  
    </div>
{% endblock %}

{% block analysis_scripts %}
<!-- 引入Chart.js库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // 确保Chart.js正确加载
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function(tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                container: 'body'
            });
        });
        
        // 检查Chart.js是否已加载
        if (typeof Chart === 'undefined') {
            console.error('Chart.js未加载，尝试动态加载...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js';
            script.onload = function() {
                console.log('Chart.js加载成功，开始初始化图表...');
                initializeCharts();
            };
            script.onerror = function() {
                console.error('Chart.js加载失败');
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = '<div class="alert alert-danger">无法加载图表库，请检查网络连接</div>';
                });
            };
            document.head.appendChild(script);
        } else {
            console.log('Chart.js已加载，开始初始化图表...');
            initializeCharts();
        }
    });

    // 初始化图表的主函数
    function initializeCharts() {
        // 不需要设置默认日期，使用父页面的日期设置
        console.log("初始化支出分析图表，使用当前日期设置...");
        
        // 直接使用当前页面加载的日期范围进行数据刷新
        // 不需要传递参数，在 refreshAnalysisData 中会获取最新日期
        refreshAnalysisData();
    }
    
    // 刷新分析数据
    function refreshAnalysisData(startDate, endDate) {
        // 如果没有提供日期参数，从表单中获取
        if (!startDate || !endDate) {
            startDate = document.getElementById('custom-date-from').value;
            endDate = document.getElementById('custom-date-to').value;
            console.log(`使用页面当前日期范围: ${startDate} 至 ${endDate}`);
        }
        
        console.log(`开始刷新数据，日期范围: ${startDate} 至 ${endDate}`);
        
        // 首先确保所有Canvas元素存在
        ensureCanvasElements();
        
        // 显示加载中提示 - 使用覆盖层而不是替换内容
        document.querySelectorAll('.chart-container').forEach(container => {
            // 移除可能存在的之前的加载层或错误提示
            const existingLoader = container.querySelector('.chart-loader-overlay');
            if (existingLoader) {
                existingLoader.remove();
            }
            
            // 创建新的加载层
            const loaderOverlay = document.createElement('div');
            loaderOverlay.className = 'chart-loader-overlay';
            loaderOverlay.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 10;';
            loaderOverlay.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">{{ _("加载中...") }}</span></div>';
            
            // 确保容器有相对定位
            container.style.position = 'relative';
            container.appendChild(loaderOverlay);
        });
        
        // 从API获取数据
        fetch(`/finance/api/expense_data?start_date=${startDate}&end_date=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`网络响应异常: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("API返回数据成功，开始处理...");
                
                // 检查数据有效性
                if (!data || typeof data !== 'object') {
                    throw new Error('API返回的数据格式无效');
                }
                
                // 移除所有加载层
                document.querySelectorAll('.chart-loader-overlay').forEach(loader => {
                    loader.remove();
                });
                
                // 更新统计数据
                try {
                updateExpenseStats(data);
                    console.log("统计数据更新成功");
                } catch (error) {
                    console.error("更新统计数据出错:", error);
                }
                
                // 尝试初始化各个图表
                try {
                    console.log("开始初始化支出趋势图表...");
                initExpenseChart(data);
                    
                    console.log("开始初始化支出类别饼图...");
                initExpenseCategoryChart(data);
                    
                    console.log("开始初始化车辆维护成本图表...");
                initVehicleMaintenanceChart(data);
                    
                    console.log("开始初始化能源成本图表...");
                    initExpenseTypeChart(data);
                    
                    console.log("所有图表初始化完成");
                } catch (error) {
                    console.error("初始化图表出错:", error);
                    showChartError("图表渲染失败: " + error.message);
                }
                
                // 调试数据结构
                console.log("API返回数据:", data);
                if (data.expense_details) {
                    console.log("支出明细数据:", data.expense_details);
                    if (data.expense_details.length > 0) {
                        console.log("第一条支出明细:", data.expense_details[0]);
                    }
                } else {
                    console.log("未找到expense_details数据");
                }
                
                // 更新支出明细表格
                try {
                updateExpenseDetailTable(data.expense_details);
                    console.log("支出明细表格更新成功");
                } catch (error) {
                    console.error("更新支出明细表格出错:", error);
                }
            })
            .catch(error => {
                console.error('获取数据失败:', error);
                showChartError("加载数据失败: " + error.message);
            });
    }
    
    // 确保所有Canvas元素都存在
    function ensureCanvasElements() {
        // 检查并创建支出趋势图canvas
        ensureCanvas('expenseChart');
        
        // 检查并创建支出类别饼图canvas
        ensureCanvas('categoryChart');
        
        // 检查并创建车辆维护成本图canvas
        ensureCanvas('maintenanceChart');
        
        // 检查并创建能源成本分析canvas
        ensureCanvas('expenseTypeChart');
    }
    
    // 确保特定的Canvas元素存在
    function ensureCanvas(canvasId) {
        // 检查canvas是否存在
        let canvas = document.getElementById(canvasId);
        if (canvas) {
            console.log(`Canvas已存在: ${canvasId}`);
            return; // Canvas已存在，不需要创建
        }
        
        // 根据ID找到对应的容器
        let container;
        switch(canvasId) {
            case 'expenseChart':
                container = document.querySelector('.chart-container');
                break;
            case 'categoryChart':
                container = document.querySelectorAll('.chart-container')[1];
                break;
            case 'maintenanceChart':
                container = document.querySelectorAll('.chart-container')[2];
                break;
            case 'expenseTypeChart':
                container = document.querySelectorAll('.chart-container')[3];
                break;
            default:
                console.error(`未知的canvasId: ${canvasId}`);
                return;
        }
        
        if (!container) {
            console.error(`找不到${canvasId}的容器`);
            return;
        }
        
        // 创建新的canvas元素
        canvas = document.createElement('canvas');
        canvas.id = canvasId;
        container.appendChild(canvas);
        console.log(`已创建canvas: ${canvasId}`);
    }
    
    // 显示图表错误信息
    function showChartError(message) {
        document.querySelectorAll('.chart-container').forEach(container => {
            // 移除加载层
            const loader = container.querySelector('.chart-loader-overlay');
            if (loader) {
                loader.remove();
            }
            
            // 添加错误提示
            const errorOverlay = document.createElement('div');
            errorOverlay.className = 'chart-loader-overlay';
            errorOverlay.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorOverlay.innerHTML = `<div class="alert alert-danger">${message}</div>`;
            container.appendChild(errorOverlay);
            });
    }
    
    // 更新支出统计数据
    function updateExpenseStats(data) {
        // 格式化金额为人民币格式
        const formatCurrency = (value) => {
            return '¥' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        };
        
        // 更新总支出
        const totalExpenseEl = document.getElementById('total-expense');
        if (totalExpenseEl) {
            totalExpenseEl.textContent = formatCurrency(data.total_expense);
        }
        
        // 更新日均支出
        const avgDailyExpenseEl = document.getElementById('avg-daily-expense');
        if (avgDailyExpenseEl) {
            avgDailyExpenseEl.textContent = formatCurrency(data.avg_daily_expense);
        }
        
        // 更新同比增长
        const expenseGrowthEl = document.getElementById('expense-growth');
        if (expenseGrowthEl) {
            const growthValue = data.expense_growth;
            const isPositive = growthValue >= 0;
            
            expenseGrowthEl.textContent = (isPositive ? '+' : '') + growthValue.toFixed(2) + '%';
            expenseGrowthEl.className = isPositive ? 'text-success' : 'text-danger';
            
            // 更新增长图标
            const growthIconEl = document.getElementById('growth-icon');
            if (growthIconEl) {
                growthIconEl.className = isPositive ? 'fas fa-arrow-up text-success me-1' : 'fas fa-arrow-down text-danger me-1';
            }
        }
    }
    
    // 初始化支出趋势图表
    function initExpenseChart(data) {
        const ctx = document.getElementById('expenseChart');
        if (!ctx) {
            console.error('找不到支出趋势图表容器');
            return;
        }
        
        // 数据验证
        if (!data.dates || !data.daily_expense || data.dates.length === 0) {
            console.error('支出趋势图表数据无效:', data.dates, data.daily_expense);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-warning">没有可用的支出趋势数据</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.expenseChart instanceof Chart) {
            window.expenseChart.destroy();
        }
        
        try {
        // 创建新的图表实例
        window.expenseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: '日支出',
                    data: data.daily_expense,
                    borderColor: 'rgba(231, 76, 60, 1)',
                    backgroundColor: 'rgba(231, 76, 60, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '¥' + context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '¥' + value;
                            }
                        }
                    }
                }
            }
        });
            console.log('支出趋势图表创建成功');
        } catch (error) {
            console.error('创建支出趋势图表失败:', error);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
        }
    }
    
    // 初始化支出类别饼图
    function initExpenseCategoryChart(data) {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) {
            console.error('找不到支出类别饼图容器');
            return;
        }
        
        // 数据验证
        if (!data.expense_categories || data.expense_categories.length === 0) {
            console.error('支出类别饼图数据无效:', data.expense_categories);
            const container = ctx.parentElement;
            container.innerHTML = '<div class="alert alert-warning">没有可用的支出类别数据</div>';
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.categoryChart instanceof Chart) {
            window.categoryChart.destroy();
        }
        
        try {
        // 准备数据
        const categories = data.expense_categories.map(item => item.name);
        const values = data.expense_categories.map(item => item.value);
        
        // 颜色数组
        const backgroundColors = [
            'rgba(52, 152, 219, 0.7)',
            'rgba(46, 204, 113, 0.7)',
            'rgba(155, 89, 182, 0.7)',
            'rgba(241, 196, 15, 0.7)',
            'rgba(230, 126, 34, 0.7)',
            'rgba(149, 165, 166, 0.7)'
        ];
        
        // 创建新的图表实例
        window.categoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: categories,
                datasets: [{
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ¥${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
            console.log('支出类别饼图创建成功');
        } catch (error) {
            console.error('创建支出类别饼图失败:', error);
            const container = ctx.parentElement;
            container.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
        }
    }
    
    // 初始化车辆维护成本条形图
    function initVehicleMaintenanceChart(data) {
        const ctx = document.getElementById('maintenanceChart');
        if (!ctx) {
            console.error('找不到车辆维护成本图表容器');
            return;
        }
        
        // 数据验证
        if (!data.vehicle_maintenance || data.vehicle_maintenance.length === 0) {
            console.error('车辆维护成本图表数据无效:', data.vehicle_maintenance);
            const container = ctx.parentElement;
            container.innerHTML = '<div class="alert alert-warning">没有可用的车辆维护成本数据</div>';
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.maintenanceChart instanceof Chart) {
            window.maintenanceChart.destroy();
        }
        
        try {
        // 准备数据
        const vehicles = data.vehicle_maintenance.map(item => item.vehicle_name);
        const costs = data.vehicle_maintenance.map(item => item.cost);
        
        // 创建新的图表实例
        window.maintenanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: vehicles,
                datasets: [{
                    label: '维护成本',
                    data: costs,
                    backgroundColor: 'rgba(41, 128, 185, 0.7)',
                    borderColor: 'rgba(41, 128, 185, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',  // 水平条形图
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += '¥' + context.parsed.x.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '¥' + value;
                            }
                        }
                    }
                }
            }
        });
            console.log('车辆维护成本图表创建成功');
        } catch (error) {
            console.error('创建车辆维护成本图表失败:', error);
            const container = ctx.parentElement;
            container.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
        }
    }
    
    // 初始化支出类型月度趋势图表
    function initExpenseTypeChart(data) {
        const ctx = document.getElementById('expenseTypeChart');
        if (!ctx) {
            console.error('找不到支出类型月度趋势图表容器');
            return;
        }
        
        // 数据验证
        if (!data.expense_types || data.expense_types.length === 0) {
            console.error('支出类型月度趋势图表数据无效:', data.expense_types);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-warning">没有可用的支出类型月度趋势数据</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.expenseTypeChart instanceof Chart) {
            window.expenseTypeChart.destroy();
        }
        
        try {
        // 准备数据
            const months = data.expense_types.map(item => item.date);
            
            // 确定不同的支出类型
            const expenseTypes = [];
            if (data.expense_types.length > 0 && data.expense_types[0].expense) {
                for (const type in data.expense_types[0].expense) {
                    if (data.expense_types[0].expense.hasOwnProperty(type)) {
                        expenseTypes.push(type);
                    }
                }
            }
            
            // 为每种支出类型准备数据集
            const datasets = [];
            const colors = [
                { backgroundColor: 'rgba(52, 152, 219, 0.2)', borderColor: 'rgba(52, 152, 219, 1)' },
                { backgroundColor: 'rgba(231, 76, 60, 0.2)', borderColor: 'rgba(231, 76, 60, 1)' },
                { backgroundColor: 'rgba(46, 204, 113, 0.2)', borderColor: 'rgba(46, 204, 113, 1)' }
            ];
            
            expenseTypes.forEach((type, index) => {
                const values = data.expense_types.map(item => item.expense[type] || 0);
                datasets.push({
                    label: type,
                    data: values,
                    backgroundColor: colors[index % colors.length].backgroundColor,
                    borderColor: colors[index % colors.length].borderColor,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                });
            });
            
            // 创建新的图表实例
            window.expenseTypeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '¥' + context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '¥' + value;
                            }
                        }
                    }
                }
            }
        });
            console.log('支出类型月度趋势图表创建成功');
        } catch (error) {
            console.error('创建支出类型月度趋势图表失败:', error);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
        }
    }
    
    // 更新支出明细表格
    function updateExpenseDetailTable(detailsData) {
        const tableBody = document.getElementById('expense-table-body');
        if (!tableBody) return;
        
        // 清空表格
        tableBody.innerHTML = '';
        
        if (!detailsData || detailsData.length === 0) {
            // 没有数据时显示提示行
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="4" class="text-center">暂无支出数据</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // 填充表格数据，使用与后端返回的数据结构对应的字段
        detailsData.forEach(item => {
            try {
            const row = document.createElement('tr');
                
                // 处理后端返回的数据结构（date, expense, expense_count, daily_change）
                const date = item.date || '未知日期';
                // 使用expense字段作为金额，后端返回的字段名是expense而不是amount
                const expense = typeof item.expense === 'number' ? item.expense : 0;
                // 计算占总支出的百分比
                const totalExpense = detailsData.reduce((sum, item) => sum + (item.expense || 0), 0);
                const percentage = totalExpense > 0 ? (expense / totalExpense) * 100 : 0;
            
            row.innerHTML = `
                    <td class="text-center">${date}</td>
                    <td class="text-center">${item.expense_count || 0}笔支出</td>
                    <td class="text-center">¥${expense.toFixed(2)}</td>
                    <td class="text-center">${percentage.toFixed(2)}%</td>
            `;
            
            tableBody.appendChild(row);
            } catch (error) {
                console.error("处理支出明细行时出错:", error, item);
                // 如果处理单行数据出错，添加一个错误提示行但继续处理其他行
                const errorRow = document.createElement('tr');
                errorRow.innerHTML = '<td colspan="4" class="text-center text-danger">数据错误</td>';
                tableBody.appendChild(errorRow);
            }
        });
    }

    // 初始化支出类别分布图表
    function initCategoryChart(data) {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) {
            console.error('找不到支出类别图表容器');
            return;
        }
        
        // 数据验证
        if (!data.categories || !data.category_amounts || data.categories.length === 0) {
            console.error('支出类别图表数据无效:', data.categories, data.category_amounts);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-warning">没有可用的支出类别数据</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.categoryChart instanceof Chart) {
            window.categoryChart.destroy();
        }
        
        try {
            // 创建新的图表实例
            window.categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.categories,
                    datasets: [{
                        data: data.category_amounts,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(230, 126, 34, 0.7)',
                            'rgba(26, 188, 156, 0.7)',
                            'rgba(41, 128, 185, 0.7)',
                            'rgba(192, 57, 43, 0.7)',
                            'rgba(243, 156, 18, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.raw !== null) {
                                        label += '¥' + context.raw.toFixed(2) + 
                                                ' (' + (context.raw / data.category_amounts.reduce((a, b) => a + b, 0) * 100).toFixed(1) + '%)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            console.log('支出类别图表创建成功');
        } catch (error) {
            console.error('创建支出类别图表失败:', error);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
        }
    }

    // 初始化车辆维护支出图表
    function initMaintenanceChart(data) {
        const ctx = document.getElementById('maintenanceChart');
        if (!ctx) {
            console.error('找不到车辆维护图表容器');
            return;
        }
        
        // 数据验证
        if (!data.maintenance_categories || !data.maintenance_amounts || data.maintenance_categories.length === 0) {
            console.error('车辆维护图表数据无效:', data.maintenance_categories, data.maintenance_amounts);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-warning">没有可用的车辆维护支出数据</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.maintenanceChart instanceof Chart) {
            window.maintenanceChart.destroy();
        }
        
        try {
            // 创建新的图表实例
            window.maintenanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.maintenance_categories,
                    datasets: [{
                        label: '维护支出',
                        data: data.maintenance_amounts,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '¥' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
            console.log('车辆维护图表创建成功');
        } catch (error) {
            console.error('创建车辆维护图表失败:', error);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
        }
    }

    // 初始化能源支出图表
    function initEnergyChart(data) {
        const ctx = document.getElementById('energyChart');
        if (!ctx) {
            console.error('找不到能源支出图表容器');
            return;
        }
        
        // 数据验证
        if (!data.energy_categories || !data.energy_amounts || data.energy_categories.length === 0) {
            console.error('能源支出图表数据无效:', data.energy_categories, data.energy_amounts);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-warning">没有可用的能源支出数据</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
            return;
        }
        
        // 清除可能存在的旧图表实例
        if (window.energyChart instanceof Chart) {
            window.energyChart.destroy();
        }
        
        try {
            // 创建新的图表实例
            window.energyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.energy_categories,
                    datasets: [{
                        data: data.energy_amounts,
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.raw !== null) {
                                        label += '¥' + context.raw.toFixed(2) + 
                                                ' (' + (context.raw / data.energy_amounts.reduce((a, b) => a + b, 0) * 100).toFixed(1) + '%)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            console.log('能源支出图表创建成功');
        } catch (error) {
            console.error('创建能源支出图表失败:', error);
            const container = ctx.parentElement;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error-overlay';
            errorDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 10;';
            errorDiv.innerHTML = '<div class="alert alert-danger">图表渲染失败: ' + error.message + '</div>';
            container.style.position = 'relative';
            container.appendChild(errorDiv);
        }
    }
</script>
{% endblock %} 