{% extends "base.html" %}

{% block title %}智能客服管理 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.2.2/css/fixedHeader.bootstrap5.min.css">
<style>
    .table th, .table td {
        white-space: nowrap;
        font-size: 14px;
        padding: 8px;
        vertical-align: middle;
        text-align: center; /* 所有单元格文本居中 */
    }
    
    /* 表头样式 */
    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        text-align: center;
        box-sizing: border-box;
        border-bottom: 2px solid #dee2e6;
    }
    
    /* 确保DataTables中的表头和单元格对齐 */
    .dataTable th, .dataTable td {
        box-sizing: border-box !important;
        white-space: nowrap !important;
        text-align: center !important; /* 强制所有DataTables单元格文本居中 */
    }
    
    /* 修复表头和数据列对齐问题 */
    #messagesTable th:nth-child(1), #messagesTable td:nth-child(1) { width: 8% !important; text-align: center !important; }
    #messagesTable th:nth-child(2), #messagesTable td:nth-child(2) { width: 10% !important; text-align: center !important; }
    #messagesTable th:nth-child(3), #messagesTable td:nth-child(3) { width: 8% !important; text-align: center !important; }
    #messagesTable th:nth-child(4), #messagesTable td:nth-child(4) { width: 42% !important; text-align: center !important; }
    #messagesTable th:nth-child(5), #messagesTable td:nth-child(5) { width: 15% !important; text-align: center !important; }
    #messagesTable th:nth-child(6), #messagesTable td:nth-child(6) { width: 10% !important; text-align: center !important; }
    
    /* 文本内容较长的单元格保持左对齐，便于阅读 */
    .chat-message, td.text-content {
        max-width: 300px;
        white-space: normal;
        word-break: break-word;
        text-align: left !important; /* 消息内容左对齐 */
    }
    .user-message {
        background-color: #e9f5ff;
    }
    .ai-message {
        background-color: #f0f0f0;
    }
    
    /* 消息内容省略显示 */
    .message-content {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
    }
    
    /* 调整表格容器大小 */
    .tab-pane .card {
        margin-bottom: 20px;
    }
    
    .tab-pane .card-body {
        padding: 15px;
    }
    
    /* 消息详情模态框样式 */
    .message-detail-modal .modal-body {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .message-detail-content {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    /* 表格悬停效果 */
    .dataTables_wrapper .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .badge-user {
        background-color: #007bff;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .badge-ai {
        background-color: #6c757d;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: bold;
        border-bottom: 3px solid #007bff;
    }
    
    /* 统计卡片样式 */
    .notification-card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        border: none;
        transition: transform 0.3s, box-shadow 0.3s;
        height: 100%;
        margin-bottom: 10px;
    }
    
    .notification-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .notification-card-content {
        display: flex;
        align-items: center;
        padding: 15px;
    }
    
    .notification-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .notification-icon i {
        font-size: 24px;
        color: white;
    }
    
    .notification-info {
        flex-grow: 1;
    }
    
    .notification-count {
        font-size: 24px;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .notification-label {
        font-size: 14px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .bg-primary {
        background-color: #007bff !important;
    }
    
    .bg-success {
        background-color: #28a745 !important;
    }
    
    .bg-warning {
        background-color: #ffc107 !important;
    }
    
    .bg-danger {
        background-color: #dc3545 !important;
    }
    
    .bg-info {
        background-color: #17a2b8 !important;
    }
    
    .bg-purple {
        background-color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ _("智能客服管理") }}</h2>
            <p class="text-muted">{{ _("查看和管理用户与智能客服的对话记录") }}</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('users.index') }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> {{ _("返回用户管理") }}</a>
        </div>
    </div>
    
    <!-- 统计信息卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-primary">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ unique_users|default(0) }}</div>
                        <div class="notification-label">使用过智能客服的用户数</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-info">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ (avg_chats_per_user|default(0) / 2)|round(1) }}</div>
                        <div class="notification-label">用户平均聊天次数</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-success">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ today_chats|default(0) /2}}</div>
                        <div class="notification-label">今日聊天次数</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-warning">
                        <i class="bi bi-lightning-charge"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ avg_response_time|default('2.5') }}s</div>
                        <div class="notification-label">平均响应时效</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 选项卡导航 -->
    <ul class="nav nav-tabs mb-4" id="customerServiceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab" aria-controls="sessions" aria-selected="true"><i class="bi bi-people"></i> {{ _("用户会话列表") }}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab" aria-controls="messages" aria-selected="false"><i class="bi bi-chat-dots"></i> {{ _("所有会话记录") }}</button>
        </li>
    </ul>

    <div class="tab-content" id="customerServiceTabsContent">
        <!-- 用户会话列表选项卡 -->
        <div class="tab-pane fade show active" id="sessions" role="tabpanel" aria-labelledby="sessions-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ _("客服会话记录") }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="sessionsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>{{ _("用户ID") }}</th>
                                    <th>{{ _("用户名") }}</th>
                                    <th>{{ _("会话数量") }}</th>
                                    <th>{{ _("最近会话时间") }}</th>
                                    <th>{{ _("操作") }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in sessions %}
                                <tr>
                                    <td>{{ session.user_id }}</td>
                                    <td>{{ session.username }}</td>
                                    <td>{{ session.message_count }}</td>
                                    <td>{{ session.last_time }}</td>
                                    <td>
                                        <a href="{{ url_for('users.view_chat_history', user_id=session.user_id) }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-chat-text"></i> {{ _("查看对话") }}</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 所有会话记录选项卡 -->
        <div class="tab-pane fade" id="messages" role="tabpanel" aria-labelledby="messages-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ _("所有会话记录") }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="width: 100%; overflow-x: auto;">
                        <table id="messagesTable" class="table table-striped table-hover" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 8%; text-align: center;">{{ _("用户ID") }}</th>
                                    <th style="width: 10%;">{{ _("用户名") }}</th>
                                    <th style="width: 8%; text-align: center;">{{ _("消息类型") }}</th>
                                    <th style="width: 42%;">{{ _("消息内容") }}</th>
                                    <th style="width: 15%; text-align: center;">{{ _("发送时间") }}</th>
                                    <th style="width: 10%; text-align: center;">{{ _("操作") }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for message in all_messages %}
                                <tr>
                                    <td>{{ message.user_id }}</td>
                                    <td>{{ message.username }}</td>
                                    <td>
                                        {% if message.is_user %}
                                        <span class="badge badge-user">{{ _("用户") }}</span>
                                        {% else %}
                                        <span class="badge badge-ai">AI</span>
                                        {% endif %}
                                    </td>
                                    <td class="chat-message {% if message.is_user %}user-message{% else %}ai-message{% endif %} message-content">
                                        {{ message.content }}
                                    </td>
                                    <td>{{ message.created_at }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-sm btn-outline-primary view-message" data-id="{{ message.id }}" data-bs-toggle="tooltip" title="{{ _("查看详情") }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-message" data-id="{{ message.id }}" data-bs-toggle="tooltip" title="{{ _("删除") }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 消息详情模态框 -->
<div class="modal fade message-detail-modal" id="messageDetailModal" tabindex="-1" aria-labelledby="messageDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageDetailModalLabel">{{ _("消息详情") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>用户ID：</strong> <span id="detail-user-id"></span>
                </div>
                <div class="mb-3">
                    <strong>用户名：</strong> <span id="detail-username"></span>
                </div>
                <div class="mb-3">
                    <strong>消息类型：</strong> <span id="detail-message-type"></span>
                </div>
                <div class="mb-3">
                    <strong>发送时间：</strong> <span id="detail-created-at"></span>
                </div>
                <div class="mb-3">
                    <strong>消息内容：</strong>
                    <div id="detail-content" class="message-detail-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("关闭") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1" aria-labelledby="deleteMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteMessageModalLabel">{{ _("确认删除") }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ _("确定要删除此消息记录吗？该操作不可逆。") }}</p>
                <form id="deleteMessageForm" method="post">
                    <input type="hidden" id="delete-message-id" name="message_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteMessage">{{ _("确认删除") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.2.2/js/dataTables.fixedHeader.min.js"></script>

<script>
    $(document).ready(function() {
        // 初始化用户会话表格
        const sessionsTable = $('#sessionsTable').DataTable({
            responsive: true,
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            columnDefs: [
                { responsivePriority: 1, targets: [1, 3] }, // 优先显示用户名和最近会话时间
                { responsivePriority: 2, targets: -1 }, // 操作列次优先显示
                { orderable: false, targets: -1 }, // 操作列不可排序
                { className: 'text-center align-middle', targets: '_all' } // 所有列居中对齐
            ],
            dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>t<"d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center"i><"d-flex"p>>',
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "全部"]],
        });
        
        // 初始化所有会话记录表格
        const messagesTable = $('#messagesTable').DataTable({
            responsive: false, // 禁用响应式，使用固定列宽
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            columnDefs: [
                { width: "8%", targets: 0, className: 'text-center align-middle' }, // 用户ID列宽
                { width: "10%", targets: 1, className: 'text-center align-middle' }, // 用户名列宽
                { width: "8%", targets: 2, className: 'text-center align-middle' }, // 消息类型列宽
                { width: "42%", targets: 3, className: 'text-content align-middle' }, // 消息内容列宽，使用自定义类以保持左对齐
                { width: "15%", targets: 4, className: 'text-center align-middle' }, // 发送时间列宽
                { width: "10%", targets: 5, className: 'text-center align-middle' }, // 操作列宽
                { orderable: false, targets: 5 } // 操作列不可排序
            ],
            order: [[0, 'asc'], [4, 'asc']], // 默认按用户ID升序，然后按时间升序排序
            dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>t<"d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center"i><"d-flex"p>>',
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "全部"]],
            scrollY: '400px', // 设置固定高度滚动
            scrollCollapse: true, // 内容不足时收缩高度
            autoWidth: false, // 禁用自动宽度计算
            scrollX: true, // 启用水平滚动
            fixedHeader: true, // 固定表头
            stateSave: false, // 不保存状态
            paging: true, // 启用分页
        });
        
        // 切换选项卡时重新计算表格宽度
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
            
            // 如果切换到所有会话记录选项卡，调整容器大小
            if (e.target.id === 'messages-tab') {
                setTimeout(function() {
                    adjustMessagesTableContainer();
                }, 100);
            }
        });
        
        // 调整消息表格容器大小
        function adjustMessagesTableContainer() {
            // 获取窗口高度的60%作为最大高度
            const windowHeight = $(window).height();
            const maxHeight = Math.floor(windowHeight * 0.6);
            
            // 设置表格容器高度
            $('#messagesTable_wrapper .dataTables_scrollBody').css('max-height', maxHeight + 'px');
            
            // 强制设置表格宽度为100%
            $('#messagesTable').css('width', '100%');
            
            // 确保每列宽度正确
            $('#messagesTable th:nth-child(1), #messagesTable td:nth-child(1)').css('width', '8%');
            $('#messagesTable th:nth-child(2), #messagesTable td:nth-child(2)').css('width', '10%');
            $('#messagesTable th:nth-child(3), #messagesTable td:nth-child(3)').css('width', '8%');
            $('#messagesTable th:nth-child(4), #messagesTable td:nth-child(4)').css('width', '42%');
            $('#messagesTable th:nth-child(5), #messagesTable td:nth-child(5)').css('width', '15%');
            $('#messagesTable th:nth-child(6), #messagesTable td:nth-child(6)').css('width', '10%');
            
            // 重新计算表格列宽
            setTimeout(function() {
                messagesTable.columns.adjust();
                messagesTable.fixedHeader.adjust();
            }, 200);
        }
        
        // 初始化工具提示
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // 查看消息详情
        $(document).on('click', '.view-message', function() {
            const row = $(this).closest('tr');
            
            // 获取行数据
            const userId = row.find('td:eq(0)').text().trim();
            const username = row.find('td:eq(1)').text().trim();
            const messageType = row.find('td:eq(2)').text().trim();
            const content = row.find('td:eq(3)').text().trim();
            const createdAt = row.find('td:eq(4)').text().trim();
            
            // 填充模态框
            $('#detail-user-id').text(userId);
            $('#detail-username').text(username);
            $('#detail-message-type').text(messageType);
            $('#detail-created-at').text(createdAt);
            
            // 设置消息内容和样式
            const isUser = messageType.includes('用户');
            $('#detail-content').text(content);
            $('#detail-content').removeClass('user-message ai-message')
                                .addClass(isUser ? 'user-message' : 'ai-message');
            
            // 显示模态框
            $('#messageDetailModal').modal('show');
        });
        
        // 删除消息
        $(document).on('click', '.delete-message', function() {
            const messageId = $(this).data('id');
            $('#delete-message-id').val(messageId);
            $('#deleteMessageModal').modal('show');
        });
        
        // 确认删除
        $('#confirmDeleteMessage').on('click', function() {
            const messageId = $('#delete-message-id').val();
            
            // 模拟删除请求 - 实际项目中应该替换为真实的API调用
            // 由于当前没有实现后端API，我们模拟一个删除操作
            try {
                // 关闭模态框
                $('#deleteMessageModal').modal('hide');
                
                // 获取当前行
                const row = $(`button.delete-message[data-id="${messageId}"]`).closest('tr');
                
                // 模拟成功删除 - 从表格中移除该行
                messagesTable.row(row).remove().draw();
                
                // 显示成功消息
                showToast('删除成功', '消息记录已成功删除', 'success');
                
                // 模拟随机失败情况 - 用于测试失败提示
                if (Math.random() > 0.7) { // 30%概率显示失败消息
                    setTimeout(() => {
                        showToast('删除失败', '操作失败，请稍后重试', 'danger');
                    }, 1000);
                }
            } catch (error) {
                // 显示错误消息
                showToast('删除失败', '操作失败，请稍后重试', 'danger');
            }
            
            /* 真实API调用的代码 - 当后端API实现后可以启用
            $.ajax({
                url: '/users/api/chat/delete/' + messageId,
                type: 'POST',
                success: function(response) {
                    // 关闭模态框
                    $('#deleteMessageModal').modal('hide');
                    
                    // 显示成功消息
                    showToast('删除成功', '消息记录已成功删除', 'success');
                    
                    // 重新加载表格
                    messagesTable.rows().invalidate().draw();
                },
                error: function(xhr) {
                    // 显示错误消息
                    showToast('删除失败', xhr.responseJSON?.message || '操作失败，请稍后重试', 'danger');
                }
            });
            */
        });
        
        // 显示Toast消息
        function showToast(title, message, type) {
            // 检查是否已存在Toast容器
            if ($('#toast-container').length === 0) {
                $('body').append('<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>');
            }
            
            // 创建Toast元素
            var toastId = 'toast-' + Date.now();
            var toast = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong>: ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // 添加到容器
            $('#toast-container').append(toast);
            
            // 初始化并显示Toast
            var toastElement = new bootstrap.Toast(document.getElementById(toastId), {
                delay: 3000
            });
            toastElement.show();
        }
        
        // 页面加载完成后调整表格容器大小
        $(window).on('resize', adjustMessagesTableContainer);
        
        // 确保表格正确渲染
        setTimeout(adjustMessagesTableContainer, 100);
        
        // 当切换到消息选项卡时，重新调整表格
        $('#messages-tab').on('click', function() {
            setTimeout(function() {
                adjustMessagesTableContainer();
                
                // 再次调整以确保正确渲染
                setTimeout(adjustMessagesTableContainer, 300);
            }, 100);
        });
    });
</script>
{% endblock %} 