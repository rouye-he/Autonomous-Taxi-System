{% extends "base.html" %}

{% block title %}信用管理 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<!-- 引入Bootstrap Table CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/bootstrap-table.min.css">
<!-- 引入DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<style>
    .table th, .table td {
        font-size: 14px;
        padding: 8px;
    }
    
    .rules-table td {
        vertical-align: middle;
    }
    
    .credit-level-1 { background-color: #ffebee; }
    .credit-level-2 { background-color: #fff8e1; }
    .credit-level-3 { background-color: #f1f8e9; }
    .credit-level-4 { background-color: #e1f5fe; }
    .credit-level-5 { background-color: #e8f5e9; }
    
    /* 标签页样式 */
    #creditTabs .nav-link {
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        border-radius: 0;
        border-bottom: 3px solid transparent;
    }

    #creditTabs .nav-link.active {
        border-bottom: 3px solid #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }

    #creditTabs .nav-link:hover:not(.active) {
        background-color: rgba(0, 0, 0, 0.03);
        border-bottom: 3px solid #dee2e6;
    }

    /* 标签页内容区域样式 */
    .tab-content {
        padding-top: 20px;
    }

    /* 标签页图标样式 */
    #creditTabs .nav-link i {
        font-size: 1.1rem;
    }

    /* 标签页特定颜色 */
    #credit-levels-tab.active { border-bottom-color: #0d6efd !important; background-color: rgba(13, 110, 253, 0.1) !important; color: #0d6efd !important; }
    #credit-rules-tab.active { border-bottom-color: #198754 !important; background-color: rgba(25, 135, 84, 0.1) !important; color: #198754 !important; }
    #credit-logs-tab.active { border-bottom-color: #fd7e14 !important; background-color: rgba(253, 126, 20, 0.1) !important; color: #fd7e14 !important; }
    
    .level-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        margin-right: 8px;
    }
    
    .badge-level-1 { background-color: #f44336; color: white; }
    .badge-level-2 { background-color: #ff9800; color: white; }
    .badge-level-3 { background-color: #4caf50; color: white; }
    .badge-level-4 { background-color: #2196f3; color: white; }
    .badge-level-5 { background-color: #673ab7; color: white; }
    
    .list-group-item {
        padding: 12px 15px;
    }
    
    .rules-card {
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* 浮动提示框样式 */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .custom-toast {
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        padding: 12px 20px;
        margin-bottom: 10px;
        text-align: center;
        animation: fadeInDown 0.5s;
        opacity: 0.9;
    }
    
    .toast-success { background-color: #28a745; color: white; }
    .toast-danger { background-color: #dc3545; color: white; }
    .toast-warning { background-color: #ffc107; color: #212529; }
    .toast-info { background-color: #17a2b8; color: white; }
    
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 0.9; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 0.9; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
    }
    
    /* 添加状态切换按钮的悬停效果 */
    .toggle-rule-status {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .toggle-rule-status:hover {
        opacity: 0.8;
        transform: scale(1.05);
    }
    
    .toggle-rule-status.loading {
        pointer-events: none;
        opacity: 0.7;
    }
    
    /* 添加禁用规则的透明度效果 */
    .rule-disabled {
        opacity: 0.7;
    }
    
    .credit-amount-positive {
        color: #28a745;
        font-weight: bold;
    }
    
    .credit-amount-negative {
        color: #dc3545;
        font-weight: bold;
    }
    
    .credit-filter-toolbar {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    /* DataTables 自定义样式 */
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 15px;
    }
    
    .dataTables_wrapper .dt-buttons {
        margin-bottom: 10px;
    }
    
    .dataTables_info, .dataTables_paginate {
        margin-top: 15px;
    }
    
    .dt-button-collection {
        width: auto !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- 添加Toast消息容器在页面顶部 -->
<div id="toast-container"></div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ _("信用管理") }}</h2>
            <p class="text-muted">{{ _("管理用户信用等级规则和信用分变动规则") }}</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('users.index') }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> {{ _("返回用户管理") }}</a>
        </div>
    </div>
    
    <!-- 选项卡导航 -->
    <ul class="nav nav-pills mb-4" id="creditTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="credit-levels-tab" data-bs-toggle="tab" 
                    data-bs-target="#credit-levels" type="button" role="tab"><i class="bi bi-bar-chart-steps me-2"></i> {{ _("信用等级规则") }}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="credit-rules-tab" data-bs-toggle="tab" 
                    data-bs-target="#credit-rules" type="button" role="tab"><i class="bi bi-list-check me-2"></i> {{ _("信用分变动规则") }}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="credit-logs-tab" data-bs-toggle="tab" 
                    data-bs-target="#credit-logs" type="button" role="tab"><i class="bi bi-clock-history me-2"></i> {{ _("信用变动记录") }}</button>
        </li>
    </ul>
    
    <!-- 选项卡内容 -->
    <div class="tab-content p-4 bg-white rounded shadow-sm" id="creditTabsContent">
        <!-- 信用等级规则选项卡 -->
        <div class="tab-pane fade show active" id="credit-levels" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card rules-card">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _("信用等级规则列表") }}</h5>
                           
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover rules-table">
                                    <thead>
                                        <tr>
                                            <th>{{ _("等级名称") }}</th>
                                            <th>{{ _("分值范围") }}</th>
                                            <th>{{ _("权益说明") }}</th>
                                            <th>{{ _("限制措施") }}</th>
                                            <th>{{ _("操作") }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for level in credit_levels %}
                                        <tr class="credit-level-{{ loop.index }}">
                                            <td>
                                                <span class="level-badge badge-level-{{ loop.index }}">{{ level.level_name }}</span>
                                            </td>
                                            <td>{{ level.min_score }} - {{ level.max_score }}</td>
                                            <td>
                                                <div style="max-height: 100px; overflow-y: auto;">
                                                    {{ level.benefits|safe }}
                                                </div>
                                            </td>
                                            <td>
                                                <div style="max-height: 100px; overflow-y: auto;">
                                                    {{ level.limitations|safe }}
                                                </div>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary edit-level-btn" 
                                                        data-level-id="{{ level.level_id }}"><i class="bi bi-pencil"></i> {{ _("编辑") }}</button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 信用分变动规则选项卡 -->
        <div class="tab-pane fade" id="credit-rules" role="tabpanel">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> 信用分变动说明</h5>
                        <p class="mb-0">{{ _("用户信用分是评估用户行为可信度的重要指标，初始分值为100分，满分为150分。系统根据以下规则自动调整用户信用分：") }}</p>
                        
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card rules-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">{{ _("加分规则") }}</h5>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                                {% for rule in credit_rules %}
                                {% if rule.rule_type == '奖励' %}
                                <li class="list-group-item d-flex justify-content-between align-items-center {% if rule.is_active == 0 %}text-muted bg-light{% endif %}">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ rule.rule_name }}
                                            {% if rule.is_active == 0 %}<small class="text-danger">(已禁用)</small>{% endif %}
                                        </h6>
                                        <small class="text-muted">{{ rule.description }}</small>
                                    </div>
                                    <div>
                                        {% if rule.is_active == 1 %}
                                        <span class="badge bg-success me-2 toggle-rule-status" data-rule-id="{{ rule.rule_id }}" data-is-active="1" role="button" title="{{ _("点击禁用规则") }}"><i class="bi bi-check-circle-fill"></i> 已激活</span>
                                        {% else %}
                                        <span class="badge bg-secondary me-2 toggle-rule-status" data-rule-id="{{ rule.rule_id }}" data-is-active="0" role="button" title="{{ _("点击激活规则") }}"><i class="bi bi-x-circle-fill"></i> 已禁用</span>
                                        {% endif %}
                                        <span class="badge bg-success rounded-pill me-2">{{ '+' if rule.score_change > 0 }}{{ rule.score_change }}</span>
                                        <button class="btn btn-sm btn-outline-secondary edit-rule-btn" data-rule-id="{{ rule.rule_id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-rule-btn" data-rule-id="{{ rule.rule_id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-success" id="addCreditRuleBtn" data-rule-type="奖励"><i class="bi bi-plus-circle"></i> {{ _("添加加分规则") }}</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card rules-card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">{{ _("减分规则") }}</h5>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                                {% for rule in credit_rules %}
                                {% if rule.rule_type == '惩罚' %}
                                <li class="list-group-item d-flex justify-content-between align-items-center {% if rule.is_active == 0 %}text-muted bg-light{% endif %}">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ rule.rule_name }}
                                            {% if rule.is_active == 0 %}<small class="text-danger">(已禁用)</small>{% endif %}
                                        </h6>
                                        <small class="text-muted">{{ rule.description }}</small>
                                    </div>
                                    <div>
                                        {% if rule.is_active == 1 %}
                                        <span class="badge bg-danger me-2 toggle-rule-status" data-rule-id="{{ rule.rule_id }}" data-is-active="1" role="button" title="{{ _("点击禁用规则") }}"><i class="bi bi-check-circle-fill"></i> 已激活</span>
                                        {% else %}
                                        <span class="badge bg-secondary me-2 toggle-rule-status" data-rule-id="{{ rule.rule_id }}" data-is-active="0" role="button" title="{{ _("点击激活规则") }}"><i class="bi bi-x-circle-fill"></i> 已禁用</span>
                                        {% endif %}
                                        <span class="badge bg-danger rounded-pill me-2">{{ rule.score_change }}</span>
                                        <button class="btn btn-sm btn-outline-secondary edit-rule-btn" data-rule-id="{{ rule.rule_id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-rule-btn" data-rule-id="{{ rule.rule_id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-danger" id="addCreditRuleBtn" data-rule-type="惩罚"><i class="bi bi-plus-circle"></i> {{ _("添加减分规则") }}</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 mt-4">
                    <div class="card rules-card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">{{ _("恢复规则") }}</h5>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                                {% for rule in credit_rules %}
                                {% if rule.rule_type == '恢复' %}
                                <li class="list-group-item d-flex justify-content-between align-items-center {% if rule.is_active == 0 %}text-muted bg-light{% endif %}">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ rule.rule_name }}
                                            {% if rule.is_active == 0 %}<small class="text-danger">(已禁用)</small>{% endif %}
                                        </h6>
                                        <small class="text-muted">{{ rule.description }}</small>
                                    </div>
                                    <div>
                                        {% if rule.is_active == 1 %}
                                        <span class="badge bg-info me-2 toggle-rule-status" data-rule-id="{{ rule.rule_id }}" data-is-active="1" role="button" title="{{ _("点击禁用规则") }}"><i class="bi bi-check-circle-fill"></i> 已激活</span>
                                        {% else %}
                                        <span class="badge bg-secondary me-2 toggle-rule-status" data-rule-id="{{ rule.rule_id }}" data-is-active="0" role="button" title="{{ _("点击激活规则") }}"><i class="bi bi-x-circle-fill"></i> 已禁用</span>
                                        {% endif %}
                                        <span class="badge bg-info rounded-pill me-2">{{ '+' if rule.score_change > 0 }}{{ rule.score_change }}</span>
                                        <button class="btn btn-sm btn-outline-secondary edit-rule-btn" data-rule-id="{{ rule.rule_id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-rule-btn" data-rule-id="{{ rule.rule_id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-info" id="addCreditRuleBtn" data-rule-type="恢复"><i class="bi bi-plus-circle"></i> {{ _("添加恢复规则") }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 信用变动记录选项卡 -->
        <div class="tab-pane fade" id="credit-logs" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _("信用变动记录") }}</h5>
                        </div>
                        <div class="card-body">
                            <!-- 过滤工具栏 -->
                            <div class="credit-filter-toolbar">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="input-group input-group-sm mb-3">
                                            <span class="input-group-text">{{ _("用户ID") }}</span>
                                            <input type="text" class="form-control" id="search-user-id" placeholder="{{ _("输入用户ID搜索") }}">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm mb-3" id="filter-change-type">
                                            <option value="">{{ _("所有变动类型") }}</option>
                                            <option value="订单完成">{{ _("订单完成") }}</option>
                                            <option value="违规行为">{{ _("违规行为") }}</option>
                                            <option value="系统奖励">{{ _("系统奖励") }}</option>
                                            <option value="定期恢复">{{ _("定期恢复") }}</option>
                                            <option value="人工修改">{{ _("人工修改") }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="input-group input-group-sm mb-3">
                                            <span class="input-group-text">{{ _("日期范围") }}</span>
                                            <input type="date" class="form-control" id="date-from">
                                            <span class="input-group-text">{{ _("至") }}</span>
                                            <input type="date" class="form-control" id="date-to">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <button id="apply-filters" class="btn btn-sm btn-primary w-100"><i class="bi bi-funnel"></i> {{ _("应用筛选") }}</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- DataTables 表格 -->
                            <div class="table-responsive">
                                <table id="credit-logs-table" class="table table-striped table-hover" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>{{ _("记录ID") }}</th>
                                            <th>{{ _("用户ID") }}</th>
                                            <th>{{ _("变动分值") }}</th>
                                            <th>{{ _("变动前分值") }}</th>
                                            <th>{{ _("变动后分值") }}</th>
                                            <th>{{ _("变动类型") }}</th>
                                            <th>{{ _("变动原因") }}</th>
                                            <th>{{ _("关联订单ID") }}</th>
                                            <th>{{ _("操作人") }}</th>
                                            <th>{{ _("时间") }}</th>
                                            <th>{{ _("操作") }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 数据将由DataTables动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑信用等级模态框 -->
<div class="modal fade" id="editLevelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("编辑信用等级") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editLevelForm">
                    <input type="hidden" id="level_id" name="level_id">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="level_name" class="form-label">{{ _("等级名称") }}</label>
                            <input type="text" class="form-control" id="level_name" name="level_name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="min_score" class="form-label">{{ _("最低分值") }}</label>
                            <input type="number" class="form-control" id="min_score" name="min_score" required>
                        </div>
                        <div class="col-md-4">
                            <label for="max_score" class="form-label">{{ _("最高分值") }}</label>
                            <input type="number" class="form-control" id="max_score" name="max_score" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="benefits" class="form-label">{{ _("等级权益") }}</label>
                            <textarea class="form-control" id="benefits" name="benefits" rows="6"></textarea>
                            <small class="text-muted">详细描述此信用等级用户可享受的特权</small>
                        </div>
                        <div class="col-md-6">
                            <label for="limitations" class="form-label">{{ _("限制措施") }}</label>
                            <textarea class="form-control" id="limitations" name="limitations" rows="6"></textarea>
                            <small class="text-muted">描述此信用等级可能受到的限制</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="saveLevelBtn">{{ _("保存修改") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加信用规则模态框 -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("添加信用规则") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <input type="hidden" id="rule_type" name="rule_type">
                    <div class="mb-3">
                        <label for="rule_name" class="form-label">{{ _("规则名称") }}</label>
                        <input type="text" class="form-control" id="rule_name" name="rule_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="trigger_event" class="form-label">{{ _("触发事件") }}</label>
                        <input type="text" class="form-control" id="trigger_event" name="trigger_event" required>
                    </div>
                    <div class="mb-3">
                        <label for="score_change" class="form-label">{{ _("分值变动") }}</label>
                        <input type="number" class="form-control" id="score_change" name="score_change" required>
                        <small class="text-muted rule-score-hint"></small>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">{{ _("规则描述") }}</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">{{ _("保存规则") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加编辑规则模态框 -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("编辑信用规则") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRuleForm">
                    <input type="hidden" id="edit_rule_id" name="rule_id">
                    <input type="hidden" id="edit_rule_type" name="rule_type">
                    <div class="mb-3">
                        <label for="edit_rule_name" class="form-label">{{ _("规则名称") }}</label>
                        <input type="text" class="form-control" id="edit_rule_name" name="rule_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_trigger_event" class="form-label">{{ _("触发事件") }}</label>
                        <input type="text" class="form-control" id="edit_trigger_event" name="trigger_event" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_score_change" class="form-label">{{ _("分值变动") }}</label>
                        <input type="number" class="form-control" id="edit_score_change" name="score_change" required>
                        <small class="text-muted edit-rule-score-hint"></small>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">{{ _("规则描述") }}</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="edit_is_active" checked>
                        <label class="form-check-label" for="edit_is_active">{{ _("规则状态（开启/关闭）") }}</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="updateRuleBtn">{{ _("保存修改") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看/编辑信用记录模态框 -->
<div class="modal fade" id="viewCreditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("信用记录详情") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="viewCreditForm">
                    <input type="hidden" id="view_log_id" name="log_id">
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("记录ID") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_log_id_text"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("用户ID") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_user_id"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("变动前分值") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_credit_before"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("变动后分值") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_credit_after"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("变动分值") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_change_amount"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("变动类型") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_change_type"></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="view_reason" class="form-label">{{ _("变动原因") }}</label>
                        <textarea class="form-control" id="view_reason" name="reason" rows="3" readonly></textarea>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("关联订单ID") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_related_order_id"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("操作人") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_operator"></p>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">{{ _("时间") }}</label>
                        <div class="col-sm-8">
                            <p class="form-control-plaintext" id="view_created_at"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("关闭") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入必要的JS依赖 -->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/bootstrap-table.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/locale/bootstrap-table-zh-CN.min.js"></script>

<!-- 引入DataTables相关JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
    // 通用的Toast通知函数
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${type}`;
        toast.innerHTML = message;
        toastContainer.appendChild(toast);
        
        // 显示通知
        setTimeout(() => {
            toast.style.animation = 'fadeInDown 0.3s forwards';
        }, 10);
        
        // 3秒后隐藏
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s forwards';
            // 动画结束后移除元素
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 300);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 页面加载时检查并恢复上次活动的选项卡
        const activeTab = localStorage.getItem('activeCreditTab');
        if (activeTab) {
            // 激活保存的选项卡
            const tabEl = document.querySelector(activeTab);
            if (tabEl) {
                const tab = new bootstrap.Tab(tabEl);
                tab.show();
            }
        }
        
        // 选项卡切换时保存当前选项卡
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabEl => {
            tabEl.addEventListener('shown.bs.tab', function (e) {
                // 保存当前活动的选项卡ID
                localStorage.setItem('activeCreditTab', '#' + e.target.id);
            });
        });
        
        // 编辑信用等级按钮点击事件
        const editLevelBtns = document.querySelectorAll('.edit-level-btn');
        editLevelBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const levelId = this.getAttribute('data-level-id');
                
                // 发送AJAX请求获取信用等级详情
                fetch(`/api/credit/levels/${levelId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('获取信用等级详情失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            const level = data.data;
                            
                            // 填充表单
                            document.getElementById('level_id').value = level.level_id;
                            document.getElementById('level_name').value = level.level_name;
                            document.getElementById('min_score').value = level.min_score;
                            document.getElementById('max_score').value = level.max_score;
                            
                            // 处理换行符
                            if (level.benefits) {
                                document.getElementById('benefits').value = level.benefits.replace(/<br>/g, '\n');
                            }
                            
                            if (level.limitations) {
                                document.getElementById('limitations').value = level.limitations.replace(/<br>/g, '\n');
                            }
                            
                            // 显示模态框
                            const editModal = new bootstrap.Modal(document.getElementById('editLevelModal'));
                            editModal.show();
                        } else {
                            showToast(data.message || '获取信用等级详情失败', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('获取信用等级详情错误:', error);
                        showToast('获取信用等级详情失败: ' + error.message, 'error');
                    });
            });
        });
        
        // 保存信用等级按钮点击事件
        document.getElementById('saveLevelBtn').addEventListener('click', function() {
            // 获取表单数据
            const levelId = document.getElementById('level_id').value;
            const formData = {
                level_name: document.getElementById('level_name').value,
                min_score: document.getElementById('min_score').value,
                max_score: document.getElementById('max_score').value,
                benefits: document.getElementById('benefits').value,
                limitations: document.getElementById('limitations').value
            };
            
            // 发送AJAX请求保存数据
            fetch(`/api/credit/levels/${levelId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('信用等级规则保存成功！', 'success');
                    
                    // 刷新页面以显示更新后的数据
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(data.message || '保存失败', 'error');
                }
            })
            .catch(error => {
                console.error('保存信用等级错误:', error);
                showToast('保存信用等级失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 关闭模态框
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editLevelModal'));
                editModal.hide();
            });
        });
        
        // 添加信用规则按钮点击事件
        const addRuleBtns = document.querySelectorAll('[id="addCreditRuleBtn"]');
        addRuleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const ruleType = this.getAttribute('data-rule-type');
                document.getElementById('rule_type').value = ruleType;
                
                // 根据规则类型设置提示
                const scoreHint = document.querySelector('.rule-score-hint');
                if (ruleType === '奖励' || ruleType === '恢复') {
                    scoreHint.textContent = '请输入正数，表示增加的分值';
                } else if (ruleType === '惩罚') {
                    scoreHint.textContent = '请输入负数，表示扣除的分值';
                }
                
                // 显示模态框
                const addModal = new bootstrap.Modal(document.getElementById('addRuleModal'));
                addModal.show();
            });
        });
        
        // 保存信用规则按钮点击事件
        document.getElementById('saveRuleBtn').addEventListener('click', function() {
            // 获取表单数据
            const ruleType = document.getElementById('rule_type').value;
            const ruleName = document.getElementById('rule_name').value;
            const triggerEvent = document.getElementById('trigger_event').value;
            const scoreChange = document.getElementById('score_change').value;
            const description = document.getElementById('description').value;
            
            // 验证必填字段
            if (!ruleName || !triggerEvent || !scoreChange) {
                showToast('请填写所有必填字段', 'error');
                return;
            }
            
            // 验证分值与规则类型的匹配
            let scoreVal = parseInt(scoreChange, 10);
            if ((ruleType === '奖励' || ruleType === '恢复') && scoreVal <= 0) {
                showToast(`${ruleType}类型的规则分值必须为正数`, 'error');
                return;
            }
            
            if (ruleType === '惩罚' && scoreVal >= 0) {
                showToast('惩罚类型的规则分值必须为负数', 'error');
                return;
            }
            
            // 构建请求数据
            const formData = {
                rule_name: ruleName,
                rule_type: ruleType,
                trigger_event: triggerEvent,
                score_change: scoreVal,
                description: description
            };
            
            // 发送AJAX请求保存数据
            fetch('/api/credit/rules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('信用规则添加成功！', 'success');
                    
                    // 刷新页面以显示新添加的规则
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(data.message || '添加失败', 'error');
                }
            })
            .catch(error => {
                console.error('添加信用规则错误:', error);
                showToast('添加信用规则失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 关闭模态框
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addRuleModal'));
                addModal.hide();
            });
        });
        
        // 格式化变动分值
        function formatChangeAmount(value) {
            if (value > 0) {
                return `<span class="text-success">+${value}</span>`;
            } else if (value < 0) {
                return `<span class="text-danger">${value}</span>`;
            }
            return '0';
        }
        
        // 查看信用变动记录
        function viewCreditRecord(row) {
            // 填充详情模态框
            document.getElementById('view_log_id').value = row.log_id;
            document.getElementById('view_log_id_text').textContent = row.log_id;
            document.getElementById('view_user_id').textContent = row.user_id;
            document.getElementById('view_credit_before').textContent = row.credit_before;
            document.getElementById('view_credit_after').textContent = row.credit_after;
            
            const changeAmount = row.change_amount;
            if (changeAmount > 0) {
                document.getElementById('view_change_amount').textContent = '+' + changeAmount;
                document.getElementById('view_change_amount').className = 'form-control-plaintext text-success';
            } else if (changeAmount < 0) {
                document.getElementById('view_change_amount').textContent = changeAmount;
                document.getElementById('view_change_amount').className = 'form-control-plaintext text-danger';
            } else {
                document.getElementById('view_change_amount').textContent = '0';
                document.getElementById('view_change_amount').className = 'form-control-plaintext';
            }
            
            document.getElementById('view_change_type').textContent = row.change_type;
            document.getElementById('view_reason').value = row.reason;
            document.getElementById('view_related_order_id').textContent = row.related_order_id || '-';
            document.getElementById('view_operator').textContent = row.operator || '系统';
            document.getElementById('view_created_at').textContent = row.created_at;
            
            // 显示模态框
            const viewModal = new bootstrap.Modal(document.getElementById('viewCreditModal'));
            viewModal.show();
        }
        
        // 初始化DataTables
        let creditTable;
        
        // 定义DataTables初始化函数
        function initializeDataTable() {
            if (creditTable) {
                creditTable.destroy();
            }
            
            creditTable = $('#credit-logs-table').DataTable({
                serverSide: true,
                processing: true,
                responsive: true,
                language: {
                    // 使用本地定义的中文翻译而不是从CDN加载
                    "processing": "处理中...",
                    "lengthMenu": "显示 _MENU_ 条记录",
                    "zeroRecords": "没有找到记录",
                    "info": "显示第 _START_ 至 _END_ 条记录，共 _TOTAL_ 条",
                    "infoEmpty": "显示第 0 至 0 条记录，共 0 条",
                    "infoFiltered": "(从 _MAX_ 条记录过滤)",
                    "search": "全局搜索:",
                    "paginate": {
                        "first": "首页",
                        "last": "末页",
                        "next": "下一页",
                        "previous": "上一页"
                    }
                },
                // 设置搜索框延迟和样式
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                searchDelay: 500,  // 搜索延迟500毫秒
                ajax: {
                    url: '/api/credit/logs',
                    type: 'GET',
                    data: function(d) {
                        // 转换DataTables的参数为后端API能识别的格式
                        let params = {
                            limit: d.length,
                            offset: d.start,
                            sort: d.columns[d.order[0].column].data,
                            order: d.order[0].dir,
                            draw: d.draw,  // 传递draw参数
                            user_id: $('#search-user-id').val(),
                            change_type: $('#filter-change-type').val(),
                            date_from: $('#date-from').val(),
                            date_to: $('#date-to').val(),
                            search: d.search.value  // 添加搜索参数
                        };
                        
                        console.log('发送DataTables请求参数:', params);
                        
                        // 返回转换后的参数
                        return params;
                    }
                },
                columns: [
                    { data: 'log_id' },
                    { data: 'user_id' },
                    { 
                        data: 'change_amount',
                        render: function(data) {
                            return formatChangeAmount(data);
                        }
                    },
                    { data: 'credit_before' },
                    { data: 'credit_after' },
                    { data: 'change_type' },
                    { 
                        data: 'reason',
                        render: function(data) {
                            return data ? (data.length > 30 ? data.substring(0, 30) + '...' : data) : '-';
                        }
                    },
                    { 
                        data: 'related_order_id',
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    { 
                        data: 'operator',
                        render: function(data) {
                            return data || '系统';
                        }
                    },
                    { data: 'created_at' },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return '<button type="button" class="btn btn-sm btn-info view-record"><i class="bi bi-eye"></i></button>';
                        }
                    }
                ],
                order: [[0, 'desc']],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-excel"></i> 导出Excel',
                        className: 'btn btn-sm btn-success',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
                        },
                        action: function(e, dt, button, config) {
                            // 自定义导出行为，使用已有的API
                            let url = '/api/credit/logs/export';
                            
                            // 添加筛选参数
                            let params = new URLSearchParams();
                            let user_id = $('#search-user-id').val();
                            let change_type = $('#filter-change-type').val();
                            let date_from = $('#date-from').val();
                            let date_to = $('#date-to').val();
                            
                            if (user_id) params.append('user_id', user_id);
                            if (change_type) params.append('change_type', change_type);
                            if (date_from) params.append('date_from', date_from);
                            if (date_to) params.append('date_to', date_to);
                            
                            // 构建URL
                            if (params.toString()) {
                                url += '?' + params.toString();
                            }
                            
                            // 直接下载
                            window.location.href = url;
                        }
                    },
                    {
                        text: '<i class="bi bi-arrow-clockwise"></i> 刷新',
                        className: 'btn btn-sm btn-primary',
                        action: function(e, dt, node, config) {
                            dt.ajax.reload(null, false);
                            showToast('数据已刷新', 'info');
                        }
                    }
                ],
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                pageLength: 10,
                // 添加错误处理
                error: function(xhr, error, thrown) {
                    console.error('DataTables错误:', error, thrown);
                    showToast('加载数据时发生错误: ' + error, 'error');
                }
            });
            
            // 绑定查看记录按钮事件
            $('#credit-logs-table').on('click', '.view-record', function() {
                const data = creditTable.row($(this).closest('tr')).data();
                viewCreditRecord(data);
            });
        }
        
        // 监听选项卡切换，当切换到信用变动记录选项卡时初始化表格
        $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'credit-logs-tab') {
                if (!creditTable) {
                    initializeDataTable();
                }
            }
        });
        
        // 应用筛选按钮点击事件
        $('#apply-filters').on('click', function() {
            if (creditTable) {
                creditTable.ajax.reload();
            } else {
                initializeDataTable();
            }
        });
        
        // 如果默认显示的是信用变动记录选项卡，则立即初始化表格
        if ($('#credit-logs-tab').hasClass('active')) {
            initializeDataTable();
        }
    });
</script>
{% endblock %} 