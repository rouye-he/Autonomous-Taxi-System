{% extends "base.html" %}

{% block title %}用户管理 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications/notifications.css') }}">
<style>
    .table th, .table td {
        white-space: nowrap;
        font-size: 14px;
        padding: 8px;
    }
    .status-normal { color: green; }
    .status-disabled { color: red; }
    .status-deleted { color: gray; }
    .action-buttons .btn {
        padding: 2px 8px;
        font-size: 12px;
    }
    
    /* 信用分颜色 */
    .credit-level-1 { background-color: #f44336 !important; } /* 极低信用 (0-30) */
    .credit-level-2 { background-color: #ff9800 !important; } /* 低信用 (31-60) */
    .credit-level-3 { background-color: #4caf50 !important; } /* 一般信用 (61-90) */
    .credit-level-4 { background-color: #2196f3 !important; } /* 良好信用 (91-120) */
    .credit-level-5 { background-color: #673ab7 !important; } /* 优秀信用 (121-150) */
    
    /* 浮动提示框样式 */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .custom-toast {
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        padding: 12px 20px;
        margin-bottom: 10px;
        text-align: center;
        animation: fadeInDown 0.5s;
        opacity: 0.9;
    }
    
    .toast-success {
        background-color: #28a745;
        color: white;
    }
    
    .toast-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .toast-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .toast-info {
        background-color: #17a2b8;
        color: white;
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 0.9;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeOut {
        from {
            opacity: 0.9;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }
    
    /* 搜索区域样式 */
    .search-section {
        margin-bottom: 20px;
    }
    
    .search-toggle {
        cursor: pointer;
        user-select: none;
    }
    
    .search-toggle:hover {
        color: #0056b3;
    }
    
    .search-toggle i {
        transition: transform 0.3s;
    }
    
    .search-toggle.collapsed i {
        transform: rotate(-90deg);
    }
    
    .search-form {
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    
    .search-form .form-label {
        font-weight: 500;
    }
    
    /* 搜索标签样式 */
    .search-tags {
        margin-bottom: 15px;
    }
    
    .search-tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 4px;
        padding: 4px 10px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 13px;
    }
    
    .search-tag .badge {
        margin-left: 5px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<!-- 添加Toast消息容器在页面顶部 -->
<div id="toast-container"></div>

<div style="display: none;">
    <div id="indexUrl" data-url="{{ url_for('users.index') }}"></div>
    <div id="searchUrl" data-url="{{ url_for('users.advanced_search') }}"></div>
    {% if search_params %}
        {% for key, value in search_params.items() %}
            <div data-search-param data-param-key="{{ key }}" data-param-value="{{ value }}"></div>
        {% endfor %}
    {% endif %}
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ _("用户管理") }}</h2>
            <p class="text-muted">{{ _("管理平台用户信息、状态和权限") }}</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('users.export_users') }}" class="btn btn-success"><i class="bi bi-file-excel"></i> {{ _("导出Excel") }}</a>
            <a href="{{ url_for('users.analytics') }}" class="btn btn-info"><i class="bi bi-graph-up"></i> {{ _("数据分析") }}</a>
            <a href="{{ url_for('users.user_reviews') }}" class="btn btn-purple" style="background-color: #6f42c1; color: white;"><i class="bi bi-star"></i> {{ _("用户评价") }}</a>
            <a href="{{ url_for('users.ai_customer_service') }}" class="btn btn-teal" style="background-color: #20c997; color: white;"><i class="bi bi-robot"></i> {{ _("智能客服") }}</a>
            <a href="{{ url_for('users.credit_management') }}" class="btn btn-warning"><i class="bi bi-shield-check"></i> {{ _("信用管理") }}</a>
            <a href="{{ url_for('users.add_user') }}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> {{ _("添加用户") }}</a>
        </div>
    </div>

    <!-- 搜索区域 -->
    <div class="search-section">
        <div class="d-flex align-items-center mb-2 search-toggle" id="searchToggle" data-bs-toggle="collapse" data-bs-target="#searchForm" aria-expanded="false">
            <i class="bi bi-chevron-down me-2"></i>
            <h5 class="mb-0">{{ _("高级搜索") }}</h5>
        </div>
        
        <!-- 搜索条件标签 -->
        {% if search_params %}
        <div class="search-tags">
            {% for field, value in search_params.items() %}
                {% if value %}
                <span class="search-tag" data-search-param data-param-key="{{ field }}" data-param-value="{{ value }}">
                    {{ field_names.get(field, field) }}: {{ value }}
                    <span class="badge bg-secondary" onclick="removeSearchParam('{{ field }}')">×</span>
                </span>
                {% endif %}
            {% endfor %}
            {% if search_params %}
            <a href="{{ url_for('users.index') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-x-circle"></i> {{ _("清除所有筛选") }}</a>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="collapse" id="searchForm">
            <div class="search-form">
                <form id="userSearchForm" method="GET" action="{{ url_for('users.advanced_search') }}">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="user_id" class="form-label">{{ _("用户ID") }}</label>
                            <input type="text" class="form-control" id="user_id" name="user_id" value="{{ search_params.user_id if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="username" class="form-label">{{ _("用户名") }}</label>
                            <input type="text" class="form-control" id="username" name="username" value="{{ search_params.username if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="real_name" class="form-label">{{ _("真实姓名") }}</label>
                            <input type="text" class="form-control" id="real_name" name="real_name" value="{{ search_params.real_name if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="phone" class="form-label">{{ _("手机号") }}</label>
                            <input type="text" class="form-control" id="phone" name="phone" value="{{ search_params.phone if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="email" class="form-label">{{ _("邮箱") }}</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ search_params.email if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="id_card" class="form-label">{{ _("身份证号") }}</label>
                            <input type="text" class="form-control" id="id_card" name="id_card" value="{{ search_params.id_card if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">{{ _("状态") }}</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">{{ _("全部") }}</option>
                                <option value="正常" {% if search_params and search_params.status == '正常' %}selected{% endif %}>{{ _("正常") }}</option>
                                <option value="禁用" {% if search_params and search_params.status == '禁用' %}selected{% endif %}>{{ _("禁用") }}</option>
                                <option value="注销" {% if search_params and search_params.status == '注销' %}selected{% endif %}>{{ _("注销") }}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="gender" class="form-label">{{ _("性别") }}</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">{{ _("全部") }}</option>
                                <option value="男" {% if search_params and search_params.gender == '男' %}selected{% endif %}>{{ _("男") }}</option>
                                <option value="女" {% if search_params and search_params.gender == '女' %}selected{% endif %}>{{ _("女") }}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="credit_score_min" class="form-label">{{ _("最低信用分") }}</label>
                            <input type="number" class="form-control" id="credit_score_min" name="credit_score_min" min="0" max="100" value="{{ search_params.credit_score_min if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="credit_score_max" class="form-label">{{ _("最高信用分") }}</label>
                            <input type="number" class="form-control" id="credit_score_max" name="credit_score_max" min="0" max="100" value="{{ search_params.credit_score_max if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="balance_min" class="form-label">{{ _("最低余额") }}</label>
                            <input type="number" class="form-control" id="balance_min" name="balance_min" min="0" step="0.01" value="{{ search_params.balance_min if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="balance_max" class="form-label">{{ _("最高余额") }}</label>
                            <input type="number" class="form-control" id="balance_max" name="balance_max" min="0" step="0.01" value="{{ search_params.balance_max if search_params else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="registration_time_start" class="form-label">{{ _("注册时间 (开始)") }}</label>
                            <input type="date" class="form-control" id="registration_time_start" name="registration_time_start" value="{{ search_params.registration_time_start if search_params else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="registration_time_end" class="form-label">{{ _("注册时间 (结束)") }}</label>
                            <input type="date" class="form-control" id="registration_time_end" name="registration_time_end" value="{{ search_params.registration_time_end if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="registration_city" class="form-label">{{ _("注册城市") }}</label>
                            <input type="text" class="form-control" id="registration_city" name="registration_city" value="{{ search_params.registration_city if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="tags" class="form-label">{{ _("用户标签") }}</label>
                            <input type="text" class="form-control" id="tags" name="tags" value="{{ search_params.tags if search_params else '' }}" placeholder="{{ _("搜索包含的标签") }}">
                        </div>
                        <div class="col-md-3">
                            <label for="registration_channel" class="form-label">{{ _("注册渠道") }}</label>
                            <select class="form-select" id="registration_channel" name="registration_channel">
                                <option value="">{{ _("全部") }}</option>
                                <option value="手机应用" {% if search_params and search_params.registration_channel == '手机应用' %}selected{% endif %}>{{ _("手机应用") }}</option>
                                <option value="网站" {% if search_params and search_params.registration_channel == '网站' %}selected{% endif %}>{{ _("网站") }}</option>
                                <option value="微信小程序" {% if search_params and search_params.registration_channel == '微信小程序' %}selected{% endif %}>{{ _("微信小程序") }}</option>
                                <option value="合作推广" {% if search_params and search_params.registration_channel == '合作推广' %}selected{% endif %}>{{ _("合作推广") }}</option>
                                <option value="其他" {% if search_params and search_params.registration_channel == '其他' %}selected{% endif %}>{{ _("其他") }}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()"><i class="bi bi-eraser"></i> {{ _("清空条件") }}</button>
                        <div>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> {{ _("搜索") }}</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 隐藏原始消息提示 -->
    <div style="display: none;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div data-message="{{ message }}" data-category="{{ category }}"></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- 统计信息卡片 -->
    <div class="row mb-4">
        <div class="col">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-primary">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count" id="userTotalCount">{{ users.total }}</div>
                        <div class="notification-label">用户总数</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 表格容器 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive user-table-container">
                {% include 'users/_user_table.html' %}
            </div>
        </div>
    </div>
</div>

<!-- 用户详情模态框 -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("用户详细信息") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="userDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("关闭") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("确认删除") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                确定要删除这个用户吗？此操作不可撤销。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-danger">{{ _("确认删除") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入新的表格组件 -->
<script src="{{ url_for('static', filename='js/components/dataTable.js') }}"></script>
<script src="{{ url_for('static', filename='js/users/userTable.js') }}"></script>

<script>
    // 浮动提示框函数
    function showToast(message, category = 'info', duration = 1000) {
        const toastContainer = document.getElementById('toast-container');
        
        // 创建提示框元素
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${category}`;
        toast.innerHTML = message;
        
        // 添加到容器
        toastContainer.appendChild(toast);
        
        // 设置自动消失
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => {
                if (toast.parentNode === toastContainer) {
                    toastContainer.removeChild(toast);
                }
            }, 500);
        }, duration);
    }
    
    // 页面跳转函数
    function jumpToPage() {
        const pageInput = document.getElementById('pageJumpInput');
        const page = parseInt(pageInput.value);
        const maxPage = parseInt(pageInput.getAttribute('max'));
        
        if (page && page >= 1 && page <= maxPage) {
            // 获取当前URL
            let url = new URL(window.location.href);
            
            // 检查是否在搜索结果页
            const isSearchPage = url.pathname.includes('/advanced_search') || 
                               Object.keys(url.searchParams).some(key => key !== 'page' && key !== 'per_page');
            
            // 如果当前在搜索结果页，跳转到advanced_search路由
            if (isSearchPage) {
                // 保留所有现有参数，只更新页码
                url.searchParams.set('page', page);
                window.location.href = url.toString();
            } else {
                // 如果是在普通列表页，直接跳转到index路由
                window.location.href = url.pathname + '?page=' + page;
            }
        } else {
            showToast('请输入有效的页码', 'warning');
        }
    }
    
    // 当页面加载时检查是否有闪现消息
    document.addEventListener('DOMContentLoaded', function() {
        const messageElements = document.querySelectorAll('[data-message]');
        messageElements.forEach(element => {
            const message = element.getAttribute('data-message');
            const category = element.getAttribute('data-category');
            if (message) {
                showToast(message, category === 'error' ? 'danger' : category);
            }
        });
        
        // 搜索折叠面板切换状态图标
        const searchToggle = document.getElementById('searchToggle');
        if (searchToggle) {
            const searchFormCollapse = document.getElementById('searchForm');
            searchFormCollapse.addEventListener('shown.bs.collapse', function () {
                searchToggle.classList.remove('collapsed');
            });
            searchFormCollapse.addEventListener('hidden.bs.collapse', function () {
                searchToggle.classList.add('collapsed');
            });
            // 初始状态
            if (!searchFormCollapse.classList.contains('show')) {
                searchToggle.classList.add('collapsed');
            }
        }
        
        // 搜索表单提交事件
        const userSearchForm = document.getElementById('userSearchForm');
        if (userSearchForm) {
            userSearchForm.addEventListener('submit', function() {
                // 找到搜索折叠面板并关闭它
                const searchForm = document.getElementById('searchForm');
                if (searchForm && searchForm.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getInstance(searchForm);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                }
            });
        }
        
        // 添加页码输入框回车键监听
        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    jumpToPage();
                }
            });
        }
    });
    
    // 清空搜索表单
    function clearForm() {
        const form = document.getElementById('userSearchForm');
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.value = '';
        });
    }
    
    // 移除单个搜索参数
    function removeSearchParam(param) {
        // 获取当前URL
        const url = new URL(window.location.href);
        // 删除指定参数
        url.searchParams.delete(param);
        // 重定向到新URL
        window.location.href = url.toString();
    }

    // 全局暴露showToast函数，以便表格组件可以使用
    window.showToast = showToast;
</script>
{% endblock %} 