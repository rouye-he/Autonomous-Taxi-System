{% extends "base.html" %}

{% block title %}用户评价管理 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<style>
    /* 评分星星样式 */
    .rating-stars {
        color: #ffc107;
        font-size: 16px;
        letter-spacing: 2px;
    }
    
    /* 评价内容样式 */
    .review-content {
        max-width: 350px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left !important; /* 评价内容左对齐 */
    }
    
    /* 按钮样式 */
    .btn-review-action {
        width: 32px;
        height: 32px;
        padding: 0;
        line-height: 30px;
        text-align: center;
    }
    
    /* 表格单元格居中样式 */
    .table th, .table td {
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        padding: 10px;
    }
    
    /* 通知卡片样式 */
    .notification-card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        border: none;
        transition: transform 0.3s, box-shadow 0.3s;
        height: 100%;
        margin-bottom: 10px;
    }
    
    .notification-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .notification-card-content {
        display: flex;
        align-items: center;
        padding: 15px;
    }
    
    .notification-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .notification-icon i {
        font-size: 24px;
        color: white;
    }
    
    .notification-info {
        flex-grow: 1;
    }
    
    .notification-count {
        font-size: 24px;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .notification-label {
        font-size: 14px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .bg-primary {
        background-color: #007bff !important;
    }
    
    .bg-success {
        background-color: #28a745 !important;
    }
    
    .bg-warning {
        background-color: #ffc107 !important;
    }
    
    .bg-danger {
        background-color: #dc3545 !important;
    }
    
    .bg-info {
        background-color: #17a2b8 !important;
    }
    
    .bg-purple {
        background-color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h4>{{ _("用户评价管理") }}</h4>
            <p class="text-muted">{{ _("查看和管理用户对出行服务的评价") }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('users.index') }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> {{ _("返回用户管理") }}</a>
            <a href="#" class="btn btn-success" id="exportBtn"><i class="bi bi-file-excel"></i> {{ _("导出评价") }}</a>
        </div>
    </div>

    <!-- 统计信息卡片 - 使用炫酷样式 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-primary">
                        <i class="bi bi-chat-square-text"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ reviews|length }}</div>
                        <div class="notification-label">总评价数</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-info">
                        <i class="bi bi-star"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ avg_rating|default('0.0') }}</div>
                        <div class="notification-label">平均评分</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-success">
                        <i class="bi bi-hand-thumbs-up"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ good_rating_percent|default('0') }}%</div>
                        <div class="notification-label">好评率 (4-5星)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-danger">
                        <i class="bi bi-hand-thumbs-down"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">{{ bad_rating_percent|default('0') }}%</div>
                        <div class="notification-label">差评率 (1-2星)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 评价列表 -->
    <div class="table-responsive">
        <table id="reviewsTable" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>{{ _("用户ID") }}</th>
                    <th>{{ _("用户名") }}</th>
                    <th>{{ _("订单ID") }}</th>
                    <th>{{ _("评分") }}</th>
                    <th>{{ _("评价内容") }}</th>
                    <th>{{ _("评价时间") }}</th>
                    <th>{{ _("操作") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for review in reviews %}
                <tr>
                    <td>{{ review.id }}</td>
                    <td>{{ review.user_id }}</td>
                    <td>{{ review.username }}</td>
                    <td>{{ review.order_id }}</td>
                    <td>
                        <div class="rating-stars">
                            {% for i in range(review.rating) %}★{% endfor %}
                            {% for i in range(5 - review.rating) %}☆{% endfor %}
                        </div>
                    </td>
                    <td class="review-content">{{ review.comment or '无评价内容' }}</td>
                    <td>{{ review.created_at }}</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-review-action" 
                                    onclick="viewReviewDetails({{ review.id }})" data-bs-toggle="tooltip" title="{{ _("查看详情") }}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-review-action" 
                                    onclick="deleteReview({{ review.id }})" data-bs-toggle="tooltip" title="{{ _("删除") }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 查看评价详情模态框 -->
<div class="modal fade" id="reviewDetailModal" tabindex="-1" aria-labelledby="reviewDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewDetailModalLabel">{{ _("评价详情") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reviewDetailContent">
                <!-- 评价详情内容将通过JavaScript动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("关闭") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteReviewModalLabel">{{ _("确认删除") }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ _("确定要删除此评价记录吗？该操作不可逆。") }}</p>
                <form id="deleteReviewForm" method="post">
                    <input type="hidden" id="delete_review_id" name="review_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">{{ _("确认删除") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 导出选项模态框 -->
<div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="exportOptionsModalLabel">{{ _("导出选项") }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="mb-3">
                        <label class="form-label">{{ _("导出格式") }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="formatCsv" value="csv" checked>
                            <label class="form-check-label" for="formatCsv">
                                CSV (.csv)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="formatExcel" value="excel">
                            <label class="form-check-label" for="formatExcel">
                                Excel (.xlsx)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ _("选择要导出的列") }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll" checked>
                            <label class="form-check-label" for="selectAll">
                                <strong>全选</strong>
                            </label>
                        </div>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colId" value="0" checked>
                                    <label class="form-check-label" for="colId">ID</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colUserId" value="1" checked>
                                    <label class="form-check-label" for="colUserId">{{ _("用户ID") }}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colUsername" value="2" checked>
                                    <label class="form-check-label" for="colUsername">{{ _("用户名") }}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colOrderId" value="3" checked>
                                    <label class="form-check-label" for="colOrderId">{{ _("订单ID") }}</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colRating" value="4" checked>
                                    <label class="form-check-label" for="colRating">{{ _("评分") }}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colComment" value="5" checked>
                                    <label class="form-check-label" for="colComment">{{ _("评价内容") }}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input export-column" type="checkbox" id="colTime" value="6" checked>
                                    <label class="form-check-label" for="colTime">{{ _("评价时间") }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-success" id="confirmExport">{{ _("确认导出") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<!-- 添加Excel导出支持 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    $(document).ready(function() {
        // 初始化DataTables
        const table = $('#reviewsTable').DataTable({
            responsive: true,
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            columnDefs: [
                { responsivePriority: 1, targets: [2, 4, 5] }, // 优先显示用户名、评分和评价内容
                { responsivePriority: 2, targets: -1 }, // 操作列次优先显示
                { responsivePriority: 3, targets: 3 }, // 订单ID
                { className: 'text-center align-middle', targets: '_all' }, // 所有单元格居中对齐
                { className: 'text-start', targets: 5 } // 评价内容左对齐
            ],
            dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>t<"d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center"i><"d-flex"p>>',
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "全部"]],
        });

        // 初始化工具提示
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // 导出按钮点击事件
        $('#exportBtn').click(function() {
            // 显示导出选项模态框
            $('#exportOptionsModal').modal('show');
        });
        
        // 全选按钮点击事件
        $('#selectAll').change(function() {
            $('.export-column').prop('checked', $(this).is(':checked'));
        });
        
        // 选择列复选框变化事件
        $('.export-column').change(function() {
            if ($('.export-column:checked').length === $('.export-column').length) {
                $('#selectAll').prop('checked', true);
            } else {
                $('#selectAll').prop('checked', false);
            }
        });
        
        // 确认导出按钮点击事件
        $('#confirmExport').click(function() {
            // 获取选中的列
            const selectedColumns = [];
            $('.export-column:checked').each(function() {
                selectedColumns.push(parseInt($(this).val()));
            });
            
            // 如果没有选中任何列，显示警告并返回
            if (selectedColumns.length === 0) {
                showToast('导出失败', '请至少选择一列进行导出', 'warning');
                return;
            }
            
            // 获取表格数据
            const tableData = [];
            
            // 添加表头（只包含选中的列）
            const allHeaders = ['ID', '用户ID', '用户名', '订单ID', '评分', '评价内容', '评价时间'];
            const headers = selectedColumns.map(index => allHeaders[index]);
            tableData.push(headers);
            
            // 获取表格数据（只包含选中的列）
            $('#reviewsTable tbody tr').each(function() {
                const rowData = [];
                const row = $(this);
                
                selectedColumns.forEach(function(colIndex) {
                    const cell = row.find('td').eq(colIndex);
                    // 对于评分列，需要特殊处理，提取星星数量
                    if (colIndex === 4) {
                        const stars = cell.find('.rating-stars').text().match(/★/g);
                        rowData.push(stars ? stars.length : 0);
                    } else {
                        rowData.push(cell.text().trim());
                    }
                });
                
                tableData.push(rowData);
            });
            
            // 获取选中的导出格式
            const exportFormat = $('input[name="exportFormat"]:checked').val();
            
            // 根据选择的格式导出
            if (exportFormat === 'csv') {
                exportToCSV(tableData);
            } else if (exportFormat === 'excel') {
                exportToExcel(tableData);
            }
            
            // 关闭模态框
            $('#exportOptionsModal').modal('hide');
        });
        
        // 导出为CSV格式
        function exportToCSV(data) {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            data.forEach(row => {
                // 处理内容中可能包含逗号的情况，添加引号
                const processedRow = row.map(cell => {
                    const cellStr = String(cell);
                    // 如果内容包含逗号或引号，则添加引号并处理引号
                    if (cellStr.includes(',') || cellStr.includes('"')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                
                csvContent += processedRow.join(',') + "\r\n";
            });
            
            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "用户评价数据_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            
            // 模拟点击下载
            link.click();
            
            // 移除临时创建的链接
            document.body.removeChild(link);
            
            // 显示成功消息
            showToast('导出成功', '用户评价数据已成功导出为CSV文件', 'success');
        }
        
        // 导出为Excel格式
        function exportToExcel(data) {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(data);
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, ws, "用户评价");
            
            // 生成Excel文件并下载
            XLSX.writeFile(wb, "用户评价数据_" + new Date().toISOString().slice(0,10) + ".xlsx");
            
            // 显示成功消息
            showToast('导出成功', '用户评价数据已成功导出为Excel文件', 'success');
        }

        // 查看评价详情
        window.viewReviewDetails = function(reviewId) {
            // 在实际应用中，这里应该发送AJAX请求获取评价详情
            // 这里简单模拟
            const reviewRow = $(`tr:has(button[onclick="viewReviewDetails(${reviewId})"])`);
            const username = reviewRow.find('td:eq(2)').text();
            const rating = reviewRow.find('td:eq(4)').html();
            const content = reviewRow.find('td:eq(5)').text();
            const time = reviewRow.find('td:eq(6)').text();
            
            // 填充模态框内容
            $('#reviewDetailContent').html(`
                <div class="mb-3">
                    <strong>用户名:</strong> ${username}
                </div>
                <div class="mb-3">
                    <strong>评分:</strong> <div class="rating-stars">${rating}</div>
                </div>
                <div class="mb-3">
                    <strong>评价内容:</strong> 
                    <p class="mt-2">${content}</p>
                </div>
                <div class="mb-3">
                    <strong>评价时间:</strong> ${time}
                </div>
            `);
            
            // 显示模态框
            $('#reviewDetailModal').modal('show');
        };

        // 删除评价
        window.deleteReview = function(reviewId) {
            $('#delete_review_id').val(reviewId);
            $('#deleteReviewModal').modal('show');
        };

        // 确认删除
        $('#confirmDelete').click(function() {
            const reviewId = $('#delete_review_id').val();
            
            // 在实际应用中，这里应该发送AJAX请求删除评价
            // 这里简单模拟
            alert(`将删除评价ID: ${reviewId}`);
            $('#deleteReviewModal').modal('hide');
            
            // 刷新表格（实际应用中应该在AJAX成功回调中执行）
            setTimeout(function() {
                window.location.reload();
            }, 500);
        });
        
        // 显示Toast消息
        function showToast(title, message, type) {
            // 检查是否已存在Toast容器
            if ($('#toast-container').length === 0) {
                $('body').append('<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>');
            }
            
            // 创建Toast元素
            const toastId = 'toast-' + Date.now();
            const toast = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong>: ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // 添加到容器
            $('#toast-container').append(toast);
            
            // 初始化并显示Toast
            const toastElement = new bootstrap.Toast(document.getElementById(toastId), {
                delay: 3000
            });
            toastElement.show();
        }
    });
</script>
{% endblock %} 