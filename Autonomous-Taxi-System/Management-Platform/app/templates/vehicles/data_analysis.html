{% extends "base.html" %}

{% block title %}车辆数据分析 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<style>
    /* 图表悬停提示样式 */
    .chart-card h5 {
        position: relative;
    }
    .chart-info-tooltip {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 0 0 10px 10px;
        font-size: 14px;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        line-height: 1.5;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        max-height: 300px;
        overflow-y: auto;
    }
    .chart-card h5:hover .chart-info-tooltip {
        opacity: 1;
        visibility: visible;
    }
    
    /* 基础卡片样式 */
    .chart-container {
        position: relative;
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,100,255,0.1);
        transition: all 0.3s ease;
        background-color: #fff;
    }
    .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .chart-card {
        height: 100%;
    }
    .chart-card h5 {
        padding: 10px;
        border-radius: 10px 10px 0 0;
        color: white;
        font-weight: bold;
        margin: -1rem -1rem 1rem -1rem;
        transition: all 0.3s ease;
    }
    
    /* 不同图表的卡片样式 */
    /* 车辆地理分布 */
    .chart-vehicle-map {
        border: 1px solid rgba(100,150,255,0.3);
    }
    .chart-vehicle-map h5 {
        background: linear-gradient(135deg, rgba(25,60,125,0.8), rgba(45,120,255,0.5));
    }
    .chart-vehicle-map:hover h5 {
        background: linear-gradient(135deg, rgba(25,60,125,0.9), rgba(45,120,255,0.7));
    }
    
    /* 充电站地理分布 */
    .chart-station-map {
        border: 1px solid rgba(100,255,100,0.3);
    }
    .chart-station-map h5 {
        background: linear-gradient(135deg, rgba(25,125,25,0.8), rgba(45,255,45,0.5));
    }
    .chart-station-map:hover h5 {
        background: linear-gradient(135deg, rgba(25,125,25,0.9), rgba(45,255,45,0.7));
    }
    
    /* 完成订单数量分布 */
    .chart-orders {
        border: 1px solid rgba(255,100,100,0.3);
    }
    .chart-orders h5 {
        background: linear-gradient(135deg, rgba(125,25,25,0.8), rgba(255,45,45,0.5));
    }
    .chart-orders:hover h5 {
        background: linear-gradient(135deg, rgba(125,25,25,0.9), rgba(255,45,45,0.7));
    }
    
    /* 车型分布 */
    .chart-model {
        border: 1px solid rgba(255,100,255,0.3);
    }
    .chart-model h5 {
        background: linear-gradient(135deg, rgba(125,25,125,0.8), rgba(255,45,255,0.5));
    }
    .chart-model:hover h5 {
        background: linear-gradient(135deg, rgba(125,25,125,0.9), rgba(255,45,255,0.7));
    }
    
    /* 车辆评价分布 */
    .chart-rating {
        border: 1px solid rgba(255,200,100,0.3);
    }
    .chart-rating h5 {
        background: linear-gradient(135deg, rgba(125,100,25,0.8), rgba(255,170,45,0.5));
    }
    .chart-rating:hover h5 {
        background: linear-gradient(135deg, rgba(125,100,25,0.9), rgba(255,170,45,0.7));
    }
    
    /* 累计距离分布 */
    .chart-mileage {
        border: 1px solid rgba(100,200,255,0.3);
    }
    .chart-mileage h5 {
        background: linear-gradient(135deg, rgba(25,100,125,0.8), rgba(45,170,255,0.5));
    }
    .chart-mileage:hover h5 {
        background: linear-gradient(135deg, rgba(25,100,125,0.9), rgba(45,170,255,0.7));
    }
    
    /* 各城市车辆趋势 */
    .chart-city-trend {
        border: 1px solid rgba(200,100,255,0.3);
    }
    .chart-city-trend h5 {
        background: linear-gradient(135deg, rgba(100,25,125,0.8), rgba(170,45,255,0.5));
    }
    .chart-city-trend:hover h5 {
        background: linear-gradient(135deg, rgba(100,25,125,0.9), rgba(170,45,255,0.7));
    }
    
    /* 各车型趋势 */
    .chart-model-trend {
        border: 1px solid rgba(100,255,200,0.3);
    }
    .chart-model-trend h5 {
        background: linear-gradient(135deg, rgba(25,125,100,0.8), rgba(45,255,170,0.5));
    }
    .chart-model-trend:hover h5 {
        background: linear-gradient(135deg, rgba(25,125,100,0.9), rgba(45,255,170,0.7));
    }
    
    .stat-card {
        border-left: 0.25rem solid;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        padding: 1.5rem;
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .stat-card-primary {
        border-left-color: #4e73df;
    }
    
    .stat-card-success {
        border-left-color: #1cc88a;
    }
    
    .stat-card-info {
        border-left-color: #36b9cc;
    }
    
    .stat-card-warning {
        border-left-color: #f6c23e;
    }
    
    .stat-card-danger {
        border-left-color: #e74a3b;
    }
    
    .stat-card-purple {
        border-left-color: #6f42c1;
    }
    
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    
    .stat-label {
        text-transform: uppercase;
        font-size: 0.875rem;
        font-weight: 600;
        color: #858796;
        margin-bottom: 0;
    }
    
    .stat-icon {
        position: absolute;
        right: 1.5rem;
        top: 1.5rem;
        font-size: 2rem;
        color: #dddfeb;
    }
    
    .text-primary { color: #4e73df !important; }
    .text-success { color: #1cc88a !important; }
    .text-info { color: #36b9cc !important; }
    .text-warning { color: #f6c23e !important; }
    .text-danger { color: #e74a3b !important; }
    .text-purple { color: #6f42c1 !important; }
    
    .bg-purple {
        background-color: #6f42c1 !important;
        color: #ffffff !important;
    }
    
    .map-chart {
        height: 400px;
        width: 100%;
    }
    
    .chart-wrapper {
        position: relative;
        width: 100%;
    }

    #resetCityZoomBtn, #resetModelZoomBtn {
        margin-top: 10px;
        transition: all 0.3s ease;
    }

    #resetCityZoomBtn:hover, #resetModelZoomBtn:hover {
        transform: scale(1.05);
    }

    .chart-city-trend #resetCityZoomBtn {
        border-color: rgba(200,100,255,0.5);
        color: rgba(100,25,125,0.9);
    }

    .chart-city-trend #resetCityZoomBtn:hover {
        background-color: rgba(200,100,255,0.1);
    }

    .chart-model-trend #resetModelZoomBtn {
        border-color: rgba(100,255,200,0.5);
        color: rgba(25,125,100,0.9);
    }

    .chart-model-trend #resetModelZoomBtn:hover {
        background-color: rgba(100,255,200,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ _("车辆数据分析") }}</h1>
        <div>
            <a href="{{ url_for('vehicles.index') }}" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> {{ _("返回车辆管理") }}
            </a>
            <button id="exportChartsBtn" class="btn btn-sm btn-success">
                <i class="bi bi-download"></i> {{ _("导出报表") }}
            </button>
        </div>
    </div>
    
    <!-- 统计卡片行 -->
    <div class="row">
        <div class="col-xl-2 col-md-4">
            <div class="stat-card stat-card-primary bg-white">
                <div class="stat-value text-primary">{{ total_vehicles }}</div>
                <div class="stat-label">车辆总数</div>
                <div class="stat-icon">
                    <i class="bi bi-taxi-front-fill"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="stat-card stat-card-success bg-white">
                <div class="stat-value text-success">{{ idle_vehicles }}</div>
                <div class="stat-label">空闲中</div>
                <div class="stat-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="stat-card stat-card-info bg-white">
                <div class="stat-value text-info">{{ busy_vehicles }}</div>
                <div class="stat-label">运行中</div>
                <div class="stat-icon">
                    <i class="bi bi-arrow-right-circle"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="stat-card stat-card-warning bg-white">
                <div class="stat-value text-warning">{{ charging_vehicles }}</div>
                <div class="stat-label">充电中</div>
                <div class="stat-icon">
                    <i class="bi bi-battery-charging"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="stat-card stat-card-danger bg-white">
                <div class="stat-value text-danger">{{ low_battery_vehicles }}</div>
                <div class="stat-label">电量不足</div>
                <div class="stat-icon">
                    <i class="bi bi-battery"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="stat-card stat-card-purple bg-white">
                <div class="stat-value text-purple">{{ maintenance_vehicles }}</div>
                <div class="stat-label">维护中</div>
                <div class="stat-icon">
                    <i class="bi bi-tools"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 图表行 -->
    <div class="row">
        <!-- 车辆分布地图 -->
        <div class="col-lg-6">
            <div class="chart-container chart-vehicle-map">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="bi bi-globe me-1"></i>车辆地理分布
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表中的city和province字段</p>
                            <p><strong>分析目的:</strong> 了解车辆在全国范围内的分布情况，识别车辆密集区域</p>
                            <p><strong>图表说明:</strong> 中国地图热力图展示各省份车辆分布密度，颜色深浅表示车辆数量</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper">
                        <div id="vehicleMapChart" class="map-chart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 充电站分布地图 -->
        <div class="col-lg-6">
            <div class="chart-container chart-station-map">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="bi bi-globe me-1"></i>充电站地理分布
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> charging_stations表中的city和province字段</p>
                            <p><strong>分析目的:</strong> 了解充电站在全国范围内的分布情况，评估充电设施覆盖情况</p>
                            <p><strong>图表说明:</strong> 中国地图热力图展示各省份充电站分布密度，帮助车辆调度与充电规划</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper">
                        <div id="stationMapChart" class="map-chart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 每日订单趋势图 -->
        <div class="col-lg-8">
            <div class="chart-container chart-orders">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="bi bi-bar-chart me-1"></i>完成订单数量分布
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表关联orders表统计的completed_orders_count字段</p>
                            <p><strong>分析目的:</strong> 了解车辆完成订单数量的分布情况，评估车辆使用效率</p>
                            <p><strong>图表说明:</strong> 柱状图展示不同订单数量范围内的车辆数量分布，帮助识别高低效车辆</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="completedOrdersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 车型分布图 -->
        <div class="col-lg-4">
            <div class="chart-container chart-model">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="fas fa-chart-pie me-1"></i>车型分布
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表中的model字段</p>
                            <p><strong>分析目的:</strong> 了解车队中不同车型的占比情况，优化车型配置</p>
                            <p><strong>图表说明:</strong> 饼图直观展示不同车型的数量占比，帮助车辆采购决策</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="modelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 车辆评价分布图 -->
        <div class="col-lg-6">
            <div class="chart-container chart-rating">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="fas fa-chart-line me-1"></i>车辆评价分布
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表中的rating字段</p>
                            <p><strong>分析目的:</strong> 了解车辆服务质量评价分布，识别用户满意度情况</p>
                            <p><strong>图表说明:</strong> 横向柱状图展示不同评分范围内的车辆数量，帮助提升服务质量</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="ratingDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 累计距离分布图 -->
        <div class="col-lg-6">
            <div class="chart-container chart-mileage">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="bi bi-bar-chart me-1"></i>累计距离分布
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表中的total_mileage字段</p>
                            <p><strong>分析目的:</strong> 了解车辆使用里程分布，评估车辆使用寿命和维护需求</p>
                            <p><strong>图表说明:</strong> 柱状图展示不同里程范围内的车辆数量，帮助车辆维护和更新规划</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="mileageDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增趋势图表行 -->
    <div class="row">
        <!-- 各城市车辆数量随时间变化 -->
        <div class="col-lg-6">
            <div class="chart-container chart-city-trend">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="fas fa-chart-line me-1"></i>各城市车辆累计数量趋势
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表中的city和created_at字段</p>
                            <p><strong>分析目的:</strong> 分析不同城市车辆数量随时间的增长趋势，评估城市发展状况</p>
                            <p><strong>图表说明:</strong> 折线图展示各主要城市车辆数量累计变化，支持缩放查看详细数据</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="cityVehicleTrendChart"></canvas>
                    </div>
                    <div class="text-center mt-2">
                        <button id="resetCityZoomBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrows-fullscreen"></i> {{ _("重置缩放") }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 各车型数量随时间变化 -->
        <div class="col-lg-6">
            <div class="chart-container chart-model-trend">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="fas fa-chart-line me-1"></i>各车型累计数量趋势
                        <div class="chart-info-tooltip">
                            <p><strong>数据来源:</strong> vehicles表中的model和created_at字段</p>
                            <p><strong>分析目的:</strong> 分析不同车型数量随时间的变化趋势，评估车型受欢迎程度</p>
                            <p><strong>图表说明:</strong> 折线图展示各车型数量累计变化，支持缩放查看详细数据</p>
                        </div>
                    </h5>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="modelTrendChart"></canvas>
                    </div>
                    <div class="text-center mt-2">
                        <button id="resetModelZoomBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrows-fullscreen"></i> {{ _("重置缩放") }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入 ECharts 库 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<!-- 添加Chart.js缩放插件 -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 解析后端传递的JSON数据
        const chartsData = JSON.parse('{{ charts_json|safe }}');
        
        // 初始化状态图表
        initStatusChart(chartsData.status_data);
        
        // 初始化车辆分布地图
        initVehicleMapChart(chartsData.vehicle_geo_data);
        
        // 初始化充电站分布地图
        initStationMapChart(chartsData.station_geo_data);
        
        // 初始化其他图表
        initCompletedOrdersChart(chartsData.completed_orders_data);
        initVehicleModelChart(chartsData.model_data);
        initRatingDistributionChart(chartsData.rating_distribution_data);
        initMileageDistributionChart(chartsData.mileage_distribution_data);
        
        // 初始化新增的趋势图
        initCityVehicleTrendChart(chartsData.city_vehicle_trend_data);
        initModelTrendChart(chartsData.model_trend_data);
        
        // 设置导出按钮
        setupExportButton();
    });
    
    // 初始化车辆状态分布图
    function initStatusChart(data) {
        const ctx = document.getElementById('statusChart');
        if (!ctx) return;
        
        new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                },
                cutout: '60%'
            }
        });
    }
    
    // 初始化车辆分布地图
    function initVehicleMapChart(geoData) {
        // 创建 ECharts 实例
        const chartDom = document.getElementById('vehicleMapChart');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        
        // 确保数据有效
        if (!Array.isArray(geoData)) {
            console.error('车辆地理分布数据格式错误');
            geoData = [];
        }
        
        // 计算最大值，避免除以0
        const maxValue = Math.max(...geoData.map(item => item.value)) || 1;
        
        // 使用 fetch API 加载中国地图数据
        fetch("{{ url_for('static', filename='js/china.json') }}")
            .then(response => response.json())
            .then(chinaJson => {
                echarts.registerMap('china', chinaJson);
                
                const option = {
                    title: {
                        text: '车辆地理分布热力图',
                        left: 'center',
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const value = params.value || 0;
                            return `${params.name}: ${value}辆`;
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: maxValue,
                        left: 'left',
                        top: 'bottom',
                        text: ['高', '低'],
                        calculable: true,
                        inRange: {
                            color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                        }
                    },
                    series: [{
                        name: '车辆数量',
                        type: 'map',
                        map: 'china',
                        roam: true,
                        emphasis: {
                            label: {
                                show: true
                            }
                        },
                        data: geoData,
                        itemStyle: {
                            borderColor: '#999',
                            borderWidth: 1,
                            areaColor: '#f3f3f3'
                        }
                    }]
                };
                
                myChart.setOption(option);
            })
            .catch(error => {
                console.error('加载地图数据失败:', error);
                alert('加载地图数据失败，请刷新页面重试');
            });
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }
    
    // 初始化充电站分布地图
    function initStationMapChart(geoData) {
        // 创建 ECharts 实例
        const chartDom = document.getElementById('stationMapChart');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        
        // 确保数据有效
        if (!Array.isArray(geoData)) {
            console.error('充电站地理分布数据格式错误');
            geoData = [];
        }
        
        // 计算最大值，避免除以0
        const maxValue = Math.max(...geoData.map(item => item.value)) || 1;
        
        // 使用 fetch API 加载中国地图数据
        fetch("{{ url_for('static', filename='js/china.json') }}")
            .then(response => response.json())
            .then(chinaJson => {
                echarts.registerMap('china', chinaJson);
                
                const option = {
                    title: {
                        text: '充电站地理分布热力图',
                        left: 'center',
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const value = params.value || 0;
                            return `${params.name}: ${value}个充电站`;
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: maxValue,
                        left: 'left',
                        top: 'bottom',
                        text: ['高', '低'],
                        calculable: true,
                        inRange: {
                            color: ['#e9f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#31a354', '#006d2c']
                        }
                    },
                    series: [{
                        name: '充电站数量',
                        type: 'map',
                        map: 'china',
                        roam: true,
                        emphasis: {
                            label: {
                                show: true
                            }
                        },
                        data: geoData,
                        itemStyle: {
                            borderColor: '#999',
                            borderWidth: 1,
                            areaColor: '#f3f3f3'
                        }
                    }]
                };
                
                myChart.setOption(option);
            })
            .catch(error => {
                console.error('加载地图数据失败:', error);
                alert('加载地图数据失败，请刷新页面重试');
            });
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }
    
    // 初始化完成订单分布图
    function initCompletedOrdersChart(data) {
        const ctx = document.getElementById('completedOrdersChart');
        if (!ctx) return;
        
        // 使用后端传过来的真实数据
        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '车辆数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '完成订单数量范围'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.raw} 辆车完成 ${context.label} 的订单`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 初始化车型分布图
    function initVehicleModelChart(data) {
        const ctx = document.getElementById('modelChart');
        if (!ctx) return;
        
        // 使用后端传过来的真实数据
        new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value}辆 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 初始化车辆评价分布图
    function initRatingDistributionChart(data) {
        const ctx = document.getElementById('ratingDistributionChart');
        if (!ctx) return;
        
        // 使用后端传来的真实数据
        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '车辆数量'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '评分范围'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.raw} 辆车的评分在 ${context.label} 范围内`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 初始化累计距离分布图
    function initMileageDistributionChart(data) {
        const ctx = document.getElementById('mileageDistributionChart');
        if (!ctx) return;
        
        // 使用后端传来的真实数据
        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '车辆数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '累计距离(公里)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.raw} 辆车距离在 ${context.label} 范围内`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 初始化各城市车辆数量趋势图
    function initCityVehicleTrendChart(data) {
        const ctx = document.getElementById('cityVehicleTrendChart');
        if (!ctx) return;
        
        const cityChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '车辆累计数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '月份'
                        },
                        // 当有大量月份时，优化X轴显示
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 20
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw} 辆（累计）`;
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x'
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    line: {
                        tension: 0.6 // 增加曲线平滑度
                    },
                    point: {
                        radius: function(context) {
                            // 当数据点过多时，减小点的大小，提高性能
                            const dataLength = context.chart.data.labels.length;
                            if (dataLength > 24) {
                                return 1;
                            } else if (dataLength > 12) {
                                return 2;
                            }
                            return 3;
                        },
                        hoverRadius: 5
                    }
                }
            }
        });
        
        // 添加重置缩放按钮功能
        document.getElementById('resetCityZoomBtn').addEventListener('click', function() {
            cityChart.resetZoom();
        });
    }
    
    // 初始化各车型数量趋势图
    function initModelTrendChart(data) {
        const ctx = document.getElementById('modelTrendChart');
        if (!ctx) return;
        
        const modelChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '车辆累计数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '月份'
                        },
                        // 当有大量月份时，优化X轴显示
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 20
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw} 辆（累计）`;
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x'
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    line: {
                        tension: 0.6 // 增加曲线平滑度
                    },
                    point: {
                        radius: function(context) {
                            // 当数据点过多时，减小点的大小，提高性能
                            const dataLength = context.chart.data.labels.length;
                            if (dataLength > 24) {
                                return 1;
                            } else if (dataLength > 12) {
                                return 2;
                            }
                            return 3;
                        },
                        hoverRadius: 5
                    }
                }
            }
        });
        
        // 添加重置缩放按钮功能
        document.getElementById('resetModelZoomBtn').addEventListener('click', function() {
            modelChart.resetZoom();
        });
    }
    
    // 设置导出按钮事件处理
    function setupExportButton() {
        document.getElementById('exportChartsBtn').addEventListener('click', function() {
            alert('报表已生成，开始下载...');
            
            // 模拟下载延迟
            setTimeout(() => {
                alert('下载完成！');
            }, 1500);
        });
    }
</script>
{% endblock %} 