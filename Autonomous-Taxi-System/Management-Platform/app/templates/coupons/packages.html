{% extends "coupons/index.html" %}

{% block content_area %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h5>{{ _("优惠券套餐列表") }}</h5>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPackageModal">
            <i class="bi bi-plus-circle"></i> 添加套餐
        </button>
    </div>
</div>

<div class="row">
    {% for package in packages %}
    <div class="col-md-4 mb-4">
        <div class="card h-100 card-hover package-card package-card-{{ loop.index % 5 + 1 }}" data-package-id="{{ package['id'] }}">
            <div class="card-status-badge {% if package.get('status') == 1 %}bg-success{% else %}bg-secondary{% endif %}">
                {{ '在售中' if package.get('status') == 1 else '已下架' }}
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ package.get('name', '未命名套餐') }}</h5>
                <p class="card-text text-truncate">{{ package.get('description', '暂无描述') }}</p>
                
                <div class="d-flex justify-content-between align-items-center my-3">
                    <div>
                        <span class="fs-4 fw-bold text-primary">¥{{ package.get('price', 0) }}</span>
                        {% if 'original_price' in package %}
                        <span class="text-muted text-decoration-line-through ms-2">¥{{ package.get('original_price', 0) }}</span>
                        {% endif %}
                    </div>
                    {% if 'price' in package and 'original_price' in package and package['original_price'] > 0 %}
                    <span class="badge bg-warning">{{ ((1 - package['price'] / package['original_price']) * 100) | round }}% OFF</span>
                    {% endif %}
                </div>
                
                <div class="mt-2">
                    <div class="coupon-tags mb-3">
                        <span class="badge bg-info">共{{ package.get('coupon_count', '-') }}张优惠券</span>
                        <span class="badge bg-secondary">有效期{{ package.get('validity_days', 30) }}天</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted"><i class="bi bi-bag-check"></i> 已售出：{{ package.get('sale_count', 0) }}</small>
                        <div>
                            <button class="btn btn-sm btn-outline-primary view-package-btn me-2" data-package-id="{{ package['id'] }}">{{ _("查看详情") }}</button>
                            <button class="btn btn-sm btn-success buy-package-btn" data-package-id="{{ package['id'] }}" data-package-name="{{ package.get('name', '未命名套餐') }}">
                                <i class="bi bi-cart-plus"></i> 用户购买
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle-fill me-2"></i>
            目前还没有创建优惠券套餐，点击上方"添加套餐"按钮创建新的套餐
        </div>
    </div>
    {% endfor %}
</div>

<!-- 套餐详情模态框 -->
<div class="modal fade" id="packageDetailModal" tabindex="-1" aria-labelledby="packageDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packageDetailModalLabel">{{ _("套餐详情") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="packageDetailContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">{{ _("加载中...") }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("关闭") }}</button>
                <button type="button" class="btn btn-success detail-buy-package-btn">
                    <i class="bi bi-cart-plus me-1"></i> 购买此套餐
                </button>
                <button type="button" class="btn btn-primary edit-package-btn">{{ _("编辑套餐") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑套餐模态框 -->
<div class="modal fade" id="addPackageModal" tabindex="-1" aria-labelledby="addPackageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPackageModalLabel">{{ _("添加新套餐") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="packageForm">
                    <input type="hidden" id="packageId" name="id" value="0">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="packageName" class="form-label">{{ _("套餐名称") }}</label>
                            <input type="text" class="form-control" id="packageName" name="name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="packageStatus" class="form-label">{{ _("状态") }}</label>
                            <select class="form-select" id="packageStatus" name="status">
                                <option value="1">{{ _("上架") }}</option>
                                <option value="0">{{ _("下架") }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="packageDescription" class="form-label">{{ _("套餐描述") }}</label>
                        <textarea class="form-control" id="packageDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="packagePrice" class="form-label">{{ _("套餐价格") }}</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="packagePrice" name="price" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="packageOriginalPrice" class="form-label">{{ _("原价") }}</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="packageOriginalPrice" name="original_price" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="packageValidityDays" class="form-label">{{ _("有效期(天)") }}</label>
                            <input type="number" class="form-control" id="packageValidityDays" name="validity_days" min="1" value="30" required>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">{{ _("优惠券配置") }}</h6>
                    <div id="couponConfigContainer">
                        <!-- 动态添加的优惠券配置行 -->
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addCouponRowBtn">
                        <i class="bi bi-plus-circle"></i> 添加优惠券
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="savePackageBtn">{{ _("保存套餐") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 用户购买套餐模态框 -->
<div class="modal fade" id="buyPackageModal" tabindex="-1" aria-labelledby="buyPackageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyPackageModalLabel">{{ _("用户购买优惠券套餐") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="buyPackageForm">
                    <input type="hidden" id="buy_package_id" name="package_id" value="">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">{{ _("套餐名称") }}</label>
                        <p id="buy_package_name" class="mb-1">-</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="buy_user_type" class="form-label">{{ _("购买用户") }}</label>
                        <select class="form-select mb-3" id="buy_user_type" name="user_type">
                            <option value="single">{{ _("指定用户") }}</option>
                            <option value="all">{{ _("所有用户") }}</option>
                        </select>
                        
                        <div id="single_user_section">
                            <label for="buy_user_id" class="form-label">{{ _("选择用户") }}</label>
                            <select class="form-select" id="buy_user_id" name="user_id">
                                <option value="">{{ _("选择用户...") }}</option>
                                <!-- 用户选项将通过AJAX加载 -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <span id="buy_info_text">{{ _("购买后将为选定用户发放此套餐中包含的所有优惠券。") }}</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="confirmBuyBtn">
                    <i class="bi bi-check2-circle me-1"></i> 确认购买
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 查看套餐详情
        const viewButtons = document.querySelectorAll('.view-package-btn');
        const packageCards = document.querySelectorAll('.package-card');
        const detailModal = new bootstrap.Modal(document.getElementById('packageDetailModal'));
        const detailContent = document.getElementById('packageDetailContent');
        const editPackageBtn = document.querySelector('.edit-package-btn');
        const addPackageModal = new bootstrap.Modal(document.getElementById('addPackageModal'));
        const packageForm = document.getElementById('packageForm');
        const addPackageModalLabel = document.getElementById('addPackageModalLabel');
        const couponConfigContainer = document.getElementById('couponConfigContainer');
        const savePackageBtn = document.getElementById('savePackageBtn');
        const addCouponRowBtn = document.getElementById('addCouponRowBtn');
        
        // 全局变量，保存所有优惠券类型
        let allCouponTypes = [];
        
        // 初始化加载优惠券类型数据
        loadCouponTypes();
        
        // 获取用户购买相关元素
        const buyPackageModal = new bootstrap.Modal(document.getElementById('buyPackageModal'));
        const buyPackageForm = document.getElementById('buyPackageForm');
        const buyUserType = document.getElementById('buy_user_type');
        const singleUserSection = document.getElementById('single_user_section');
        const buyUserSelect = document.getElementById('buy_user_id');
        const buyPackageId = document.getElementById('buy_package_id');
        const buyPackageName = document.getElementById('buy_package_name');
        const buyInfoText = document.getElementById('buy_info_text');
        const confirmBuyBtn = document.getElementById('confirmBuyBtn');
        
        // 卡片和按钮点击事件
        function bindViewEvents() {
            viewButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const packageId = this.getAttribute('data-package-id');
                    loadPackageDetails(packageId);
                });
            });
            
            packageCards.forEach(card => {
                card.addEventListener('click', function() {
                    const packageId = this.getAttribute('data-package-id');
                    loadPackageDetails(packageId);
                });
            });
        }
        
        // 加载所有优惠券类型数据
        function loadCouponTypes() {
            fetch('/admin/coupons/api/coupon_types')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        allCouponTypes = result.data;
                        console.log('加载了优惠券类型:', allCouponTypes.length);
                    } else {
                        console.error('无法加载优惠券类型');
                    }
                })
                .catch(error => {
                    console.error('获取优惠券类型出错:', error);
                });
        }
        
        // 加载套餐详情
        function loadPackageDetails(packageId) {
            detailContent.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">{{ _("加载中...") }}</p>
                </div>
            `;
            
            editPackageBtn.setAttribute('data-package-id', packageId);
            detailModal.show();
            
            // 从后端API获取套餐详情
            fetch(`/admin/coupons/api/packages/${packageId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        renderPackageDetails(result.data);
                    } else {
                        detailContent.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                ${result.message || '加载套餐详情失败'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('获取套餐详情出错:', error);
                    detailContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            获取套餐详情时出错
                        </div>
                    `;
                });
        }
        
        // 渲染套餐详情
        function renderPackageDetails(data) {
            const package = data.package;
            const couponTypes = data.coupon_types;
            
            // 将优惠券类型转换为以ID为键的对象，方便查找
            const couponTypeMap = {};
            couponTypes.forEach(type => {
                couponTypeMap[type.id] = type;
            });
            
            // 计算折扣率
            const discountRate = ((1 - parseFloat(package.price) / parseFloat(package.original_price)) * 100).toFixed(0);
            
            // 计算总优惠券数量
            let totalCoupons = 0;
            for (const [typeId, count] of Object.entries(package.coupon_details)) {
                totalCoupons += parseInt(count);
            }
            
            // 渲染优惠券详情
            let couponDetailsHtml = '';
            for (const [typeId, count] of Object.entries(package.coupon_details)) {
                const couponType = couponTypeMap[typeId];
                if (couponType) {
                    // 根据优惠券类型确定如何显示面值
                    let valueDisplay = '';
                    if (couponType.type_name.includes('折')) {
                        valueDisplay = (couponType.value * 10) + '折';
                    } else if (couponType.min_amount > 0) {
                        valueDisplay = '¥' + couponType.value;
                    } else {
                        valueDisplay = '¥' + couponType.value;
                    }
                    
                    couponDetailsHtml += `
                        <tr>
                            <td>${couponType.type_name}</td>
                            <td>${valueDisplay}</td>
                            <td>${couponType.min_amount > 0 ? '满' + couponType.min_amount + '元可用' : '无门槛'}</td>
                            <td class="text-center">${count}张</td>
                        </tr>
                    `;
                }
            }
            
            // 如果没有找到优惠券详情
            if (couponDetailsHtml === '') {
                couponDetailsHtml = `
                    <tr>
                        <td colspan="4" class="text-center">暂无优惠券详情</td>
                    </tr>
                `;
            }
            
            // 渲染详情内容
            detailContent.innerHTML = `
                <div class="package-detail-header mb-4 p-3 rounded" style="background-color: rgba(13, 110, 253, 0.1);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4>${package.name}</h4>
                            <p class="text-muted mb-0">${package.description || '暂无描述'}</p>
                        </div>
                        <span class="badge ${package.status == 1 ? 'bg-success' : 'bg-secondary'} fs-6">
                            ${package.status == 1 ? '在售中' : '已下架'}
                        </span>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                价格信息
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{{ _("当前价格:") }}</span>
                                    <span class="fw-bold text-primary">¥${package.price}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{{ _("原价:") }}</span>
                                    <span class="text-decoration-line-through">¥${package.original_price}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>{{ _("折扣率:") }}</span>
                                    <span class="text-danger">${discountRate}% OFF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                套餐信息
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{{ _("优惠券总数:") }}</span>
                                    <span>${totalCoupons}张</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{{ _("有效期:") }}</span>
                                    <span>${package.validity_days}天</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>{{ _("已售数量:") }}</span>
                                    <span>${package.sale_count}份</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        包含优惠券
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ _("优惠券类型") }}</th>
                                        <th>{{ _("面值") }}</th>
                                        <th>{{ _("使用条件") }}</th>
                                        <th class="text-center">{{ _("数量") }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${couponDetailsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 text-muted small">
                    <p class="mb-0">创建时间: ${package.created_at || '未知'}</p>
                    <p class="mb-0">套餐ID: ${package.id}</p>
                </div>
            `;
        }
        
        // 编辑套餐
        editPackageBtn.addEventListener('click', function() {
            const packageId = this.getAttribute('data-package-id');
            loadPackageForEdit(packageId);
        });
        
        // 打开添加套餐模态框
        document.querySelector('[data-bs-target="#addPackageModal"]').addEventListener('click', function() {
            resetPackageForm();
        });
        
        // 加载套餐数据进入编辑表单
        function loadPackageForEdit(packageId) {
            // 关闭详情模态框
            detailModal.hide();
            
            // 重置表单
            resetPackageForm();
            
            // 设置标题为编辑模式
            addPackageModalLabel.textContent = '编辑套餐';
            
            // 从API加载套餐数据
            fetch(`/admin/coupons/api/packages/${packageId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const package = result.data.package;
                        
                        // 填充表单
                        document.getElementById('packageId').value = package.id;
                        document.getElementById('packageName').value = package.name;
                        document.getElementById('packageDescription').value = package.description || '';
                        document.getElementById('packagePrice').value = package.price;
                        document.getElementById('packageOriginalPrice').value = package.original_price;
                        document.getElementById('packageStatus').value = package.status;
                        document.getElementById('packageValidityDays').value = package.validity_days;
                        
                        // 添加优惠券配置行
                        if (package.coupon_details) {
                            Object.entries(package.coupon_details).forEach(([typeId, count]) => {
                                addCouponConfigRow(typeId, count);
                            });
                        }
                        
                        // 打开编辑模态框
                        addPackageModal.show();
                    } else {
                        alert('加载套餐数据失败');
                    }
                })
                .catch(error => {
                    console.error('获取套餐数据出错:', error);
                    alert('获取套餐数据时发生错误');
                });
        }
        
        // 添加一行优惠券配置
        function addCouponConfigRow(selectedTypeId = '', count = 1) {
            // 生成唯一ID
            const rowId = 'coupon-row-' + Date.now();
            
            // 创建优惠券类型选择器HTML
            let typeOptionsHtml = '<option value="">{{ _("请选择优惠券类型") }}</option>';
            if (allCouponTypes && allCouponTypes.length > 0) {
                allCouponTypes.forEach(type => {
                    const selected = (type.id == selectedTypeId) ? 'selected' : '';
                    typeOptionsHtml += `<option value="${type.id}" ${selected}>${type.type_name} (${type.min_amount > 0 ? '满' + type.min_amount + '元可用' : '无门槛'})</option>`;
                });
            } else {
                typeOptionsHtml += '<option value="" disabled>{{ _("加载优惠券类型失败") }}</option>';
            }
            
            // 创建行HTML
            const rowHtml = `
                <div class="row mb-2 coupon-config-row" id="${rowId}">
                    <div class="col-md-8">
                        <select class="form-select coupon-type-select" name="coupon_type">
                            ${typeOptionsHtml}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control coupon-count-input" name="coupon_count" min="1" value="${count}">
                            <span class="input-group-text">{{ _("张") }}</span>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-coupon-row" data-row-id="${rowId}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // 添加到容器
            couponConfigContainer.insertAdjacentHTML('beforeend', rowHtml);
            
            // 绑定删除行事件
            document.querySelector(`#${rowId} .remove-coupon-row`).addEventListener('click', function() {
                document.getElementById(rowId).remove();
            });
        }
        
        // 重置套餐表单
        function resetPackageForm() {
            packageForm.reset();
            document.getElementById('packageId').value = '0';
            addPackageModalLabel.textContent = '添加新套餐';
            couponConfigContainer.innerHTML = '';
            // 默认添加一行
            addCouponConfigRow();
        }
        
        // 添加优惠券配置行按钮
        addCouponRowBtn.addEventListener('click', function() {
            addCouponConfigRow();
        });
        
        // 保存套餐
        savePackageBtn.addEventListener('click', function() {
            // 获取表单数据
            const formData = {
                id: document.getElementById('packageId').value,
                name: document.getElementById('packageName').value,
                description: document.getElementById('packageDescription').value,
                price: parseFloat(document.getElementById('packagePrice').value),
                original_price: parseFloat(document.getElementById('packageOriginalPrice').value),
                status: parseInt(document.getElementById('packageStatus').value),
                validity_days: parseInt(document.getElementById('packageValidityDays').value),
                coupon_details: {}
            };
            
            // 验证表单
            if (!formData.name || isNaN(formData.price) || formData.price <= 0 || 
                isNaN(formData.original_price) || formData.original_price <= 0) {
                alert('请填写完整的套餐信息，价格必须大于0');
                return;
            }
            
            // 收集优惠券配置
            const couponRows = document.querySelectorAll('.coupon-config-row');
            let hasCouponConfig = false;
            
            couponRows.forEach(row => {
                const typeSelect = row.querySelector('.coupon-type-select');
                const countInput = row.querySelector('.coupon-count-input');
                
                const typeId = typeSelect.value;
                const count = parseInt(countInput.value);
                
                if (typeId && !isNaN(count) && count > 0) {
                    formData.coupon_details[typeId] = count;
                    hasCouponConfig = true;
                }
            });
            
            if (!hasCouponConfig) {
                alert('请至少添加一种优惠券类型');
                return;
            }
            
            // 提交数据到服务器
            fetch('/admin/coupons/api/packages/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 关闭模态框
                    addPackageModal.hide();
                    
                    // 刷新页面
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('保存数据出错:', error);
                alert('保存数据时发生错误');
            });
        });
        
        // 绑定事件
        bindViewEvents();
        
        // 绑定购买按钮事件
        document.querySelectorAll('.buy-package-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const packageId = this.getAttribute('data-package-id');
                const packageName = this.getAttribute('data-package-name');
                
                // 设置模态框数据
                buyPackageId.value = packageId;
                buyPackageName.textContent = packageName;
                
                // 加载用户数据
                loadUsers();
                
                // 显示模态框
                buyPackageModal.show();
            });
        });
        
        // 切换用户类型事件
        buyUserType.addEventListener('change', function() {
            if (this.value === 'all') {
                singleUserSection.style.display = 'none';
                buyInfoText.textContent = '购买后将为所有用户发放此套餐中包含的所有优惠券。';
            } else {
                singleUserSection.style.display = 'block';
                buyInfoText.textContent = '购买后将为选定用户发放此套餐中包含的所有优惠券。';
                
                // 如果切换回单用户模式但还没有加载用户，则加载用户
                if (buyUserSelect.options.length <= 1) {
                    loadUsers();
                }
            }
        });
        
        // 加载用户数据
        function loadUsers() {
            // 清空当前选项（保留第一个）
            while (buyUserSelect.options.length > 1) {
                buyUserSelect.remove(1);
            }
            
            // 从后端API获取用户列表
            fetch('/admin/users/api/list')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        // 添加用户选项
                        result.data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.user_id;
                            option.textContent = `${user.username}${user.real_name ? ' (' + user.real_name + ')' : ''}`;
                            buyUserSelect.appendChild(option);
                        });
                    } else {
                        console.error('无法加载用户列表');
                    }
                })
                .catch(error => {
                    console.error('获取用户列表出错:', error);
                });
        }
        
        // 确认购买事件
        confirmBuyBtn.addEventListener('click', function() {
            // 获取表单数据
            const packageId = buyPackageId.value;
            const userType = buyUserType.value;
            const userId = userType === 'single' ? buyUserSelect.value : null;
            
            // 验证表单
            if (userType === 'single' && !userId) {
                showToast('请选择购买用户', 'warning');
                return;
            }
            
            // 构建提交数据
            const data = {
                package_id: packageId,
                user_type: userType,
                user_id: userId
            };
            
            // 提交购买请求
            fetch('/admin/coupons/buy_package', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 关闭模态框
                    buyPackageModal.hide();
                    
                    // 显示成功消息
                    showToast(result.message, 'success');
                    
                    // 刷新页面以更新售出数量
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(result.message || '购买失败', 'danger');
                }
            })
            .catch(error => {
                console.error('购买处理出错:', error);
                showToast('处理购买请求时发生错误', 'danger');
            });
        });

        // 添加详情页购买按钮事件
        const detailBuyBtn = document.querySelector('.detail-buy-package-btn');
        detailBuyBtn.addEventListener('click', function() {
            const packageId = document.querySelector('.edit-package-btn').getAttribute('data-package-id');
            const packageName = document.querySelector('#packageDetailContent h4').textContent;
            
            // 设置购买模态框数据
            buyPackageId.value = packageId;
            buyPackageName.textContent = packageName;
            
            // 加载用户数据
            loadUsers();
            
            // 关闭详情模态框，显示购买模态框
            detailModal.hide();
            buyPackageModal.show();
        });
    });
</script>

<style>
    /* 套餐卡片样式 */
    .package-card {
        transition: transform 0.3s, box-shadow 0.3s;
        overflow: hidden;
        border: none;
        position: relative;
    }
    
    .package-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        cursor: pointer;
    }
    
    /* 不同颜色的卡片样式 */
    .package-card-1 {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
    }
    
    .package-card-2 {
        background: linear-gradient(135deg, #13547a 0%, #80d0c7 100%);
        color: white;
    }
    
    .package-card-3 {
        background: linear-gradient(135deg, #ff8008 0%, #ffc837 100%);
        color: white;
    }
    
    .package-card-4 {
        background: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
        color: white;
    }
    
    .package-card-5 {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        color: white;
    }
    
    /* 卡片内文字颜色调整 */
    .package-card .text-muted {
        color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .package-card .text-primary {
        color: #ffffff !important;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    /* 状态徽章 */
    .card-status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1;
    }
    
    /* 优惠券标签 */
    .coupon-tags .badge {
        margin-right: 5px;
    }
</style>
{% endblock %} 