{% extends "coupons/index.html" %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<style>
    /* 表格单元格居中样式 */
    .table th, .table td {
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        padding: 8px;
    }
    
    .btn-coupon-type {
        width: 32px;
        height: 32px;
        padding: 0;
        line-height: 32px;
        text-align: center;
        border-radius: 4px;
    }
    
    .coupon-type-value {
        font-weight: bold;
        color: #dc3545;
    }
    
    .modal-header.bg-coupon {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border-bottom: 2px solid rgba(220, 53, 69, 0.3);
    }
    
    /* 表格悬停效果 */
    #couponTypesTable tbody tr:hover {
        background-color: rgba(220, 53, 69, 0.05);
    }

    .badge-coupon-category {
        font-size: 0.85em;
        padding: 5px 8px;
    }
    
    .badge-discount {
        background-color: #6f42c1;
    }
    
    .badge-minus {
        background-color: #20c997;
    }
</style>
{% endblock %}

{% block content_area %}
<div class="row mb-4">
    <div class="col-md-8">
        <h4>{{ _("优惠券种类列表") }}</h4>
        <p class="text-muted">{{ _("管理系统中可用的优惠券类型") }}</p>
    </div>
    <div class="col-md-4 text-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponTypeModal">
            <i class="bi bi-plus-circle me-1"></i> 添加优惠券种类
        </button>
    </div>
</div>

<!-- 优惠券种类表格 -->
<div class="table-responsive">
    <table id="couponTypesTable" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>{{ _("类型名称") }}</th>
                <th>{{ _("优惠券种类") }}</th>
                <th>{{ _("面值(元/折扣率)") }}</th>
                <th>{{ _("使用门槛(元)") }}</th>
                <th>{{ _("描述") }}</th>
                <th>{{ _("创建时间") }}</th>
                <th>{{ _("操作") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for type in coupon_types %}
            <tr>
                <td>{{ type.id }}</td>
                <td>{{ type.type_name }}</td>
                <td>
                    {% if type.coupon_category == '满减券' %}
                    <span class="badge badge-coupon-category badge-minus">{{ _("满减券") }}</span>
                    {% elif type.coupon_category == '折扣券' %}
                    <span class="badge badge-coupon-category badge-discount">{{ _("折扣券") }}</span>
                    {% else %}
                    <span class="badge badge-coupon-category bg-secondary">{{ _("未设置") }}</span>
                    {% endif %}
                </td>
                <td class="coupon-type-value">{{ type.value }}</td>
                <td>{{ type.min_amount }}</td>
                <td>{{ type.description }}</td>
                <td>{{ type.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary btn-coupon-type edit-type" 
                                data-id="{{ type.id }}" data-bs-toggle="tooltip" title="{{ _("编辑") }}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-coupon-type delete-type"
                                data-id="{{ type.id }}" data-bs-toggle="tooltip" title="{{ _("删除") }}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 添加优惠券种类模态框 -->
<div class="modal fade" id="addCouponTypeModal" tabindex="-1" aria-labelledby="addCouponTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-coupon">
                <h5 class="modal-title" id="addCouponTypeModalLabel">{{ _("添加优惠券种类") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCouponTypeForm" method="post" action="{{ url_for('admin.coupons.add_type') }}">
                    <div class="mb-3">
                        <label for="type_name" class="form-label">类型名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="type_name" name="type_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="coupon_category" class="form-label">优惠券种类 <span class="text-danger">*</span></label>
                        <select class="form-select" id="coupon_category" name="coupon_category" required>
                            <option value="" selected disabled>{{ _("请选择优惠券种类") }}</option>
                            <option value="满减券">{{ _("满减券") }}</option>
                            <option value="折扣券">{{ _("折扣券") }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="value" class="form-label">面值(元) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="value" name="value" min="0" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="min_amount" class="form-label">{{ _("使用门槛(元)") }}</label>
                        <input type="number" class="form-control" id="min_amount" name="min_amount" min="0" step="0.01" value="0">
                        <div class="form-text">0表示无使用门槛</div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">{{ _("描述") }}</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="saveNewType">{{ _("保存") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑优惠券种类模态框 -->
<div class="modal fade" id="editCouponTypeModal" tabindex="-1" aria-labelledby="editCouponTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-coupon">
                <h5 class="modal-title" id="editCouponTypeModalLabel">{{ _("编辑优惠券种类") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCouponTypeForm" method="post" action="{{ url_for('admin.coupons.update_type') }}">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="mb-3">
                        <label for="edit_type_name" class="form-label">类型名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit_type_name" name="type_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_coupon_category" class="form-label">优惠券种类 <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_coupon_category" name="coupon_category" required>
                            <option value="满减券">{{ _("满减券") }}</option>
                            <option value="折扣券">{{ _("折扣券") }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_value" class="form-label">面值(元) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="edit_value" name="value" min="0" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_min_amount" class="form-label">{{ _("使用门槛(元)") }}</label>
                        <input type="number" class="form-control" id="edit_min_amount" name="min_amount" min="0" step="0.01">
                        <div class="form-text">0表示无使用门槛</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">{{ _("描述") }}</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-primary" id="updateType">{{ _("保存修改") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteCouponTypeModal" tabindex="-1" aria-labelledby="deleteCouponTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCouponTypeModalLabel">{{ _("确认删除") }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ _("确定要删除此优惠券种类吗？该操作不可逆。") }}</p>
                <form id="deleteCouponTypeForm" method="post" action="{{ url_for('admin.coupons.delete_type') }}">
                    <input type="hidden" id="delete_id" name="id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("取消") }}</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">{{ _("确认删除") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

<script>
    $(document).ready(function() {
        // 初始化DataTables
        const table = $('#couponTypesTable').DataTable({
            responsive: true,
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            columnDefs: [
                { responsivePriority: 1, targets: [1, 2, 3] }, // 优先显示类型名称、优惠券种类和面值列
                { responsivePriority: 2, targets: -1 }, // 操作列次优先显示
                { responsivePriority: 3, targets: 4 }, // 使用门槛
                { responsivePriority: 4, targets: 5 }, // 描述
                { className: 'text-center align-middle', targets: '_all' }, // 所有单元格居中对齐
                { className: 'text-start align-middle', targets: [5] } // 描述列左对齐
            ],
            dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>t<"d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center"i><"d-flex"p>>',
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "全部"]],
        });

        // 初始化工具提示
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // 添加新优惠券种类
        $('#saveNewType').click(function() {
            const form = $('#addCouponTypeForm');
            if (form[0].checkValidity() === false) {
                form.addClass('was-validated');
                return;
            }
            
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: form.serialize(),
                success: function(response) {
                    if (response.status === 'success') {
                        $('#addCouponTypeModal').modal('hide');
                        showToast(response.message, 'success');
                        // 刷新表格
                        setTimeout(function() {
                            window.location.reload();
                        }, 500);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('操作失败，请稍后重试', 'danger');
                }
            });
        });

        // 打开编辑模态框并填充数据
        $(document).on('click', '.edit-type', function() {
            const id = $(this).data('id');
            const row = $(this).closest('tr');
            const typeName = row.find('td:eq(1)').text();
            const couponCategory = row.find('td:eq(2)').text().trim();
            const value = row.find('td:eq(3)').text();
            const minAmount = row.find('td:eq(4)').text();
            const description = row.find('td:eq(5)').text();

            $('#edit_id').val(id);
            $('#edit_type_name').val(typeName);
            $('#edit_value').val(value);
            $('#edit_min_amount').val(minAmount);
            $('#edit_description').val(description);
            
            // 设置优惠券种类选择值
            if (couponCategory.includes('满减券')) {
                $('#edit_coupon_category').val('满减券');
            } else if (couponCategory.includes('折扣券')) {
                $('#edit_coupon_category').val('折扣券');
            }

            $('#editCouponTypeModal').modal('show');
        });

        // 更新优惠券种类
        $('#updateType').click(function() {
            const form = $('#editCouponTypeForm');
            if (form[0].checkValidity() === false) {
                form.addClass('was-validated');
                return;
            }
            
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: form.serialize(),
                success: function(response) {
                    if (response.status === 'success') {
                        $('#editCouponTypeModal').modal('hide');
                        showToast(response.message, 'success');
                        // 刷新表格
                        setTimeout(function() {
                            window.location.reload();
                        }, 500);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('操作失败，请稍后重试', 'danger');
                }
            });
        });

        // 打开删除确认模态框
        $(document).on('click', '.delete-type', function() {
            const id = $(this).data('id');
            $('#delete_id').val(id);
            $('#deleteCouponTypeModal').modal('show');
        });

        // 确认删除
        $('#confirmDelete').click(function() {
            const form = $('#deleteCouponTypeForm');
            
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: form.serialize(),
                success: function(response) {
                    if (response.status === 'success') {
                        $('#deleteCouponTypeModal').modal('hide');
                        showToast(response.message, 'success');
                        // 刷新表格
                        setTimeout(function() {
                            window.location.reload();
                        }, 500);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('操作失败，请稍后重试', 'danger');
                }
            });
        });

        // 模态框关闭时重置表单
        $('#addCouponTypeModal').on('hidden.bs.modal', function () {
            $('#addCouponTypeForm')[0].reset();
            $('#addCouponTypeForm').removeClass('was-validated');
        });

        $('#editCouponTypeModal').on('hidden.bs.modal', function () {
            $('#editCouponTypeForm').removeClass('was-validated');
        });
    });
</script>
{% endblock %} 