{% extends "analytics/index.html" %}

{% block content_area %}
<style>
/* 图表操作按钮样式 */
.chart-actions .btn {
    padding: 0.25rem 0.5rem;
    margin-left: 5px;
}

.chart-actions .btn i {
    font-size: 0.9rem;
}

/* 图表加载效果 */
.chart-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 10;
}

/* 图表提示样式 */
.card-header {
    position: relative;
}
.chart-info-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 0 0 10px 10px;
    font-size: 14px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    line-height: 1.5;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    max-height: 300px;
    overflow-y: auto;
}
.card-header:hover .chart-info-tooltip {
    opacity: 1;
    visibility: visible;
}
</style>

<!-- 订单和服务质量指标卡片 -->
<div class="category-title">订单和服务质量</div>
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon" style="background-color: #20c997;">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ completion_rate }}%</div>
                    <div class="metric-label">订单完成率</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，已完成订单数 ÷ 总订单数 × 100%（%）
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon" style="background-color: #fd7e14;">
                    <i class="bi bi-currency-exchange"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">￥{{ avg_amount }}</div>
                    <div class="metric-label">平均订单金额</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，订单明细表中所有订单的平均金额（元/单）
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon" style="background-color: #e83e8c;">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ avg_duration }}</div>
                    <div class="metric-label">平均订单完成时长</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，已结束订单从创建时间到到达时间的平均分钟数（分钟）
            </div>
        </div>
    </div>
</div>

<!-- 卡片布局区域 -->
<div class="row mb-4">
    <!-- 各城市平均订单完成时长 (动态条形图) -->
    <div class="col-md-12 mb-4">
        <div class="card" style="border-radius:15px; border: 1px solid rgba(100,100,255,0.3); box-shadow: 0 0 15px rgba(0,100,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,35,125,0.8), rgba(45,85,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-bar-chart-fill me-2"></i>各城市平均订单完成时长</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="city-order-duration" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="city-order-duration" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表中已完成订单的create_time和complete_time字段计算时长，按城市分组</p>
                    <p><strong>分析目的:</strong> 对比不同城市的服务效率，识别运营较慢的城市以进行优化</p>
                    <p><strong>图表说明:</strong> 条形图展示各城市平均订单完成时长，颜色深浅表示完成时长大小，会进行动态排序</p>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="chart-loading" id="city-order-durationLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="city-order-duration" class="chart-container" style="height: 540px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 订单高峰时段热力图 (周/时) -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,100,100,0.3); box-shadow: 0 0 15px rgba(255,0,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(125,35,35,0.8), rgba(255,85,85,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-grid-3x3-gap-fill me-2"></i>订单高峰时段热力图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="order-peak-heatmap" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="order-peak-heatmap" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表中按周几和小时统计订单数量的二维分布</p>
                    <p><strong>分析目的:</strong> 识别订单高峰时段，优化车辆调度，合理安排充电时间</p>
                    <p><strong>图表说明:</strong> 热力图展示一周内不同时段的订单密度，颜色越深表示订单量越大</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="order-peak-heatmapLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="order-peak-heatmap" class="chart-container" style="height: 380px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 订单行驶里程分布 (直方图/核密度图) -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,255,100,0.3); box-shadow: 0 0 15px rgba(0,255,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(35,125,35,0.8), rgba(85,255,85,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-distribute-horizontal me-2"></i>订单行驶里程分布</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="order-distance-distribution" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="order-distance-distribution" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表和order_details表中计算的行驶里程数据</p>
                    <p><strong>分析目的:</strong> 了解订单里程分布特征，为车型配置和电池规划提供依据</p>
                    <p><strong>图表说明:</strong> 柱状图表示不同里程区间的订单数量，曲线为核密度估计，展示里程的连续分布特征</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="order-distance-distributionLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="order-distance-distribution" class="chart-container" style="height: 380px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 订单金额分布云图 (定制词云) -->
    <div class="col-md-6 mb-4">
        <div class="card" style="border-radius:15px; border: 1px solid rgba(255,200,100,0.3); box-shadow: 0 0 15px rgba(255,150,0,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(125,85,25,0.8), rgba(255,165,45,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-cloud-fill me-2"></i>订单金额分布云图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="order-amount-wordcloud" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="order-amount-wordcloud" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表中amount字段分区统计的订单金额分布</p>
                    <p><strong>分析目的:</strong> 直观展示订单金额的分布特征，识别最常见的消费区间</p>
                    <p><strong>图表说明:</strong> 词云图中文字大小表示该金额区间的订单数量，颜色从蓝到红表示金额从低到高</p>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-loading" id="order-amount-wordcloudLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="order-amount-wordcloud" class="chart-container" style="height: 450px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 待分配订单实时地理热点图 -->
    <div class="col-md-6 mb-4">
        <div class="card" style="border-radius:15px; border: 1px solid rgba(100,100,255,0.3); box-shadow: 0 0 15px rgba(0,100,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,35,125,0.8), rgba(85,85,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-geo-alt-fill me-2"></i>待分配订单实时地理热点图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="pending-orders-map" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="pending-orders-map" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表中status为'待分配'的订单，按城市和地理坐标统计</p>
                    <p><strong>分析目的:</strong> 实时监控各地区的订单需求，指导车辆调度和区域运营策略</p>
                    <p><strong>图表说明:</strong> 中国地图上的热力展示，颜色深浅表示待分配订单的密度，帮助管理人员快速识别高需求区域</p>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-loading" id="pending-orders-mapLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="pending-orders-map" class="chart-container" style="height: 450px;"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
<!-- 添加中国地图相关依赖 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 确保订单和服务质量标签页为活跃状态
    const tabLinks = document.querySelectorAll('#analytics-tab .nav-link');
    tabLinks.forEach(link => link.classList.remove('active'));
    const serviceQualityTab = document.getElementById('service-quality-tab');
    if(serviceQualityTab) {
        serviceQualityTab.classList.add('active');
    }
    
    // 初始化工具提示
    var tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(function(el) {
        return new bootstrap.Tooltip(el);
    });
    
    // 初始化所有图表变量，便于全局访问
    let cityOrderDurationChart, orderPeakHeatmapChart, orderDistanceDistributionChart, 
        orderAmountWordcloudChart, pendingOrdersMapChart;
    
    // 解析后端传递的JSON数据
    const cityOrderDurationData = JSON.parse('{{ city_order_duration_data|safe }}');
    
    // 订单高峰时段数据(使用真实数据)
    const orderPeakData = JSON.parse('{{ order_peak_data|safe }}');
    
    // 订单行驶里程分布数据(使用真实数据)
    const orderDistanceData = JSON.parse('{{ order_distance_data|safe }}');
    
    // 订单金额分布数据(使用真实数据)
    const orderAmountData = JSON.parse('{{ order_amount_data|safe }}');
    
    // 待分配订单地理数据(使用真实数据)
    const pendingOrdersMapData = JSON.parse('{{ pending_orders_map_data|safe }}');
    
    // 建立图表ID与图表对象的映射关系
    const chartObjects = {};
    
    // 建立图表ID与加载区域ID的映射
    const chartToLoadingMap = {
        'city-order-duration': 'city-order-durationLoading',
        'order-peak-heatmap': 'order-peak-heatmapLoading',
        'order-distance-distribution': 'order-distance-distributionLoading',
        'order-amount-wordcloud': 'order-amount-wordcloudLoading',
        'pending-orders-map': 'pending-orders-mapLoading'
    };
    
    // 渲染所有图表
    cityOrderDurationChart = renderCityOrderDuration(cityOrderDurationData);
    orderPeakHeatmapChart = renderOrderPeakHeatmap(orderPeakData);
    orderDistanceDistributionChart = renderOrderDistanceDistribution(orderDistanceData);
    orderAmountWordcloudChart = renderOrderAmountWordcloud(orderAmountData);
    pendingOrdersMapChart = renderPendingOrdersMap(pendingOrdersMapData);
    
    // 存储图表对象
    chartObjects['city-order-duration'] = cityOrderDurationChart;
    chartObjects['order-peak-heatmap'] = orderPeakHeatmapChart;
    chartObjects['order-distance-distribution'] = orderDistanceDistributionChart;
    chartObjects['order-amount-wordcloud'] = orderAmountWordcloudChart;
    chartObjects['pending-orders-map'] = pendingOrdersMapChart;
    
    // 窗口大小改变时重新渲染图表
    window.addEventListener('resize', function() {
        cityOrderDurationChart = renderCityOrderDuration(cityOrderDurationData);
        orderPeakHeatmapChart = renderOrderPeakHeatmap(orderPeakData);
        orderDistanceDistributionChart = renderOrderDistanceDistribution(orderDistanceData);
        orderAmountWordcloudChart = renderOrderAmountWordcloud(orderAmountData);
        pendingOrdersMapChart = renderPendingOrdersMap(pendingOrdersMapData);
        
        // 更新图表对象引用
        chartObjects['city-order-duration'] = cityOrderDurationChart;
        chartObjects['order-peak-heatmap'] = orderPeakHeatmapChart;
        chartObjects['order-distance-distribution'] = orderDistanceDistributionChart;
        chartObjects['order-amount-wordcloud'] = orderAmountWordcloudChart;
        chartObjects['pending-orders-map'] = pendingOrdersMapChart;
    });
    
    // 监听日期范围选择器变化
    const dateRangeSelect = document.getElementById('date-range');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const dateForm = document.getElementById('date-range-form');
    
    if(dateRangeSelect && dateForm) {
        // 更新表单提交目标，确保提交到当前页面
        dateForm.action = '{{ url_for("analytics.service_quality") }}';
        
        // 表单提交前处理
        dateForm.addEventListener('submit', function(e) {
            // 标记日期范围来源
            localStorage.setItem('last_date_filter_page', 'service-quality');
        });
        
        // 日期范围选择变化时更新日期输入框
        dateRangeSelect.addEventListener('change', function() {
            const today = new Date();
            let startDate = new Date(today);
            
            switch(this.value) {
                case 'last_3_days':
                    startDate.setDate(today.getDate() - 3);
                    break;
                case 'last_7_days':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'last_30_days':
                    startDate.setDate(today.getDate() - 30);
                    break;
                case 'last_90_days':
                    startDate.setDate(today.getDate() - 90);
                    break;
                case 'last_180_days':
                    startDate.setDate(today.getDate() - 180);
                    break;
                case 'custom':
                    // 自定义模式下不修改日期
                    return;
            }
            
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = startDate.toISOString().split('T')[0];
        });
    }
    
    // 刷新按钮事件处理
    document.querySelectorAll('.refresh-chart').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.getAttribute('data-chart');
            const loadingId = chartToLoadingMap[chartId];
            
            if (loadingId) {
                // 显示加载动画
                document.getElementById(loadingId).style.display = 'flex';
                
                // 模拟加载延迟，实际项目中应该是AJAX请求新数据
                setTimeout(function() {
                    // 根据图表类型重新渲染
                    switch(chartId) {
                        case 'city-order-duration':
                            chartObjects[chartId] = renderCityOrderDuration(cityOrderDurationData);
                            break;
                        case 'order-peak-heatmap':
                            chartObjects[chartId] = renderOrderPeakHeatmap(orderPeakData);
                            break;
                        case 'order-distance-distribution':
                            chartObjects[chartId] = renderOrderDistanceDistribution(orderDistanceData);
                            break;
                        case 'order-amount-wordcloud':
                            chartObjects[chartId] = renderOrderAmountWordcloud(orderAmountData);
                            break;
                        case 'pending-orders-map':
                            chartObjects[chartId] = renderPendingOrdersMap(pendingOrdersMapData);
                            break;
                    }
                    
                    // 隐藏加载动画
                    document.getElementById(loadingId).style.display = 'none';
                }, 800);
            }
        });
    });
    
    // 下载按钮事件处理
    document.querySelectorAll('.download-chart').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.getAttribute('data-chart');
            const chartDom = document.getElementById(chartId);
            const chartName = chartDom.closest('.card').querySelector('.card-title').textContent.trim();
            
            try {
                const chart = chartObjects[chartId];
                
                if (!chart) {
                    console.error('找不到图表对象:', chartId);
                    return;
                }
                
                // 针对ECharts的导出方法
                const url = chart.getDataURL({
                    pixelRatio: 3,
                    backgroundColor: '#fff'
                });
                
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `${chartName.replace(/\s+/g, '_')}.png`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (err) {
                console.error('导出图表错误:', err);
                alert('导出图表失败，请重试');
            }
        });
    });
});

// 渲染各城市平均订单完成时长动态条形图
function renderCityOrderDuration(data) {
    const chartDom = document.getElementById('city-order-duration');
    const chart = echarts.init(chartDom);
    
    const option = {
        grid: {
            left: '5%',
            right: '5%',
            bottom: '10%',
            top: '10%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            name: '完成时长(分钟)',
            nameTextStyle: {
                color: '#888',
                fontSize: 12
            },
            axisLine: {
                lineStyle: {
                    color: '#ddd'
                }
            },
            splitLine: {
                lineStyle: {
                    color: 'rgba(200, 200, 200, 0.1)',
                    type: 'dashed'
                }
            }
        },
        yAxis: {
            type: 'category',
            data: data.cities,
            axisLine: {
                lineStyle: {
                    color: '#ddd'
                }
            },
            axisTick: {
                alignWithLabel: true
            }
        },
        series: [
            {
                type: 'bar',
                data: data.cities.map((city, index) => {
                    return {
                        value: data.durations[index],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                {offset: 0, color: data.colors[index]},
                                {offset: 1, color: adjustBrightness(data.colors[index], 0.7)}
                            ]),
                            borderRadius: [0, 10, 10, 0]
                        }
                    };
                }),
                barWidth: '60%',
                label: {
                    show: true,
                    position: 'right',
                    formatter: '{c} 分钟',
                    fontSize: 14,
                    color: '#666'
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 20,
                        shadowColor: 'rgba(0,0,0,0.3)'
                    }
                },
                animationDelay: function(idx) {
                    return idx * 120;
                },
                animationDelayUpdate: function(idx) {
                    return idx * 120;
                }
            }
        ],
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ccc',
            borderWidth: 1,
            textStyle: {
                color: '#333'
            },
            formatter: function(params) {
                const data = params[0];
                return `<div style="padding: 3px 6px;">
                    <div style="font-weight: bold; margin-bottom: 2px;">${data.name}</div>
                    <div style="display: flex; align-items: center;">
                        <span style="display: inline-block; width: 10px; height: 10px; background-color: ${data.color}; margin-right: 5px;"></span>
                        <span>平均完成时长: ${data.value} 分钟</span>
                    </div>
                </div>`;
            }
        },
        animationDuration: 1000,
        animationEasing: 'elasticOut'
    };
    
    // 设置图表配置项并渲染
    chart.setOption(option);
    
    // 执行排序动画
    function updateSort() {
        const cities = [...data.cities];
        const durations = [...data.durations];
        const colors = [...data.colors];
        
        // 创建排序索引数组
        const indices = durations.map((_, i) => i);
        indices.sort((a, b) => durations[a] - durations[b]);
        
        // 应用排序
        const sortedCities = indices.map(i => cities[i]);
        const sortedDurations = indices.map(i => durations[i]);
        const sortedColors = indices.map(i => colors[i]);
        
        // 更新数据
        chart.setOption({
            yAxis: {
                data: sortedCities
            },
            series: [{
                data: sortedCities.map((city, index) => {
                    return {
                        value: sortedDurations[index],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                {offset: 0, color: sortedColors[index]},
                                {offset: 1, color: adjustBrightness(sortedColors[index], 0.7)}
                            ]),
                            borderRadius: [0, 10, 10, 0]
                        }
                    };
                })
            }]
        });
    }
    
    // 5秒后执行排序
    setTimeout(updateSort, 3000);
    
    // 辅助函数：调整颜色亮度
    function adjustBrightness(color, factor) {
        // 将颜色转换为RGB
        let r, g, b;
        if (color.startsWith('#')) {
            const hex = color.slice(1);
            r = parseInt(hex.slice(0, 2), 16);
            g = parseInt(hex.slice(2, 4), 16);
            b = parseInt(hex.slice(4, 6), 16);
        } else if (color.startsWith('rgb')) {
            const matches = color.match(/\d+/g);
            r = parseInt(matches[0]);
            g = parseInt(matches[1]);
            b = parseInt(matches[2]);
        } else {
            return color; // 无法处理的颜色格式
        }
        
        // 调整亮度
        r = Math.min(255, Math.round(r * factor));
        g = Math.min(255, Math.round(g * factor));
        b = Math.min(255, Math.round(b * factor));
        
        // 转回十六进制
        return `rgb(${r},${g},${b})`;
    }
    
    // 返回图表实例供其他函数使用
    return chart;
}

// 渲染订单高峰时段热力图
function renderOrderPeakHeatmap(data) {
    const chartDom = document.getElementById('order-peak-heatmap');
    const chart = echarts.init(chartDom);
    
    const hours = data.hours;
    
    const option = {
        tooltip: {
            position: 'top',
            formatter: function(params) {
                return `${data.days[params.data[0]]} ${hours[params.data[1]]}<br>订单数: ${params.data[2]}`;
            },
            backgroundColor: 'rgba(50, 50, 50, 0.9)',
            borderColor: '#777',
            textStyle: {color: '#fff'},
            extraCssText: 'box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);'
        },
        grid: {
            top: '8%',
            left: '3%',
            right: '7%',
            bottom: '10%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: hours,
            axisLabel: {
                color: '#666',
                fontSize: 10,
                interval: function(index, value) {
                    return index % 3 === 0; // 每3小时显示一个标签
                },
                formatter: function(value) {
                    return value.split(':')[0] + '时';
                }
            },
            splitArea: {
                show: true
            }
        },
        yAxis: {
            type: 'category',
            data: data.days,
            axisLabel: {
                color: '#666',
                fontSize: 12
            },
            splitArea: {
                show: true
            }
        },
        visualMap: {
            min: 0,
            max: data.max_count > 0 ? data.max_count : 100,
            calculable: true,
            orient: 'horizontal',
            left: 'center',
            bottom: '0%',
            inRange: {
                color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
            },
            textStyle: {
                color: '#666'
            }
        },
        series: [{
            name: '订单数量',
            type: 'heatmap',
            data: data.data,
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            progressive: 1000,
            animation: true,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
                return idx * 5;
            }
        }]
    };
    
    chart.setOption(option);
    
    // 返回图表实例供其他函数使用
    return chart;
}

// 渲染订单行驶里程分布图
function renderOrderDistanceDistribution(data) {
    const chartDom = document.getElementById('order-distance-distribution');
    const chart = echarts.init(chartDom);
    
    // 使用后端传递的分区数据
    const binData = data.bin_data;
    
    // 提取区间名称和数值用于绘图
    const categories = binData.map(item => item.name + 'km');
    const values = binData.map(item => item.value);
    
    // 使用核密度估计曲线的点数据
    // 从原始距离数据计算核密度估计
    const kdePoints = [];
    
    // 如果有原始距离数据
    if(data.raw_distances && data.raw_distances.length > 0) {
        const step = 0.5;
        const maxDistance = Math.max(...data.raw_distances);
        const h = 2; // 带宽参数
        
        for(let x = 0; x <= maxDistance; x += step) {
            // 使用近似高斯核密度估计
            let y = 0;
            
            data.raw_distances.forEach(d => {
                // 高斯核函数
                y += Math.exp(-Math.pow(x - d, 2) / (2 * Math.pow(h, 2))) / (Math.sqrt(2 * Math.PI) * h);
            });
            
            y = y / data.raw_distances.length * 300; // 缩放到合适高度
            kdePoints.push([x, y]);
        }
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            },
            backgroundColor: 'rgba(255, 255, 255, 0.8)',
            borderColor: '#aaa',
            borderWidth: 1,
            textStyle: {
                color: '#666'
            },
            formatter: function(params) {
                const barData = params.find(param => param.seriesType === 'bar');
                const lineData = params.find(param => param.seriesType === 'line');
                
                let result = `<div style="font-weight: bold; margin-bottom: 5px;">${barData.name}</div>`;
                result += `<div style="display: flex; align-items: center; margin-bottom: 3px;">
                    <span style="display: inline-block; width: 10px; height: 10px; background-color: ${barData.color}; margin-right: 5px;"></span>
                    <span>订单数量: ${barData.value}</span>
                </div>`;
                
                if (lineData) {
                    result += `<div style="display: flex; align-items: center;">
                        <span style="display: inline-block; width: 10px; height: 10px; background-color: ${lineData.color}; margin-right: 5px;"></span>
                        <span>密度估计: ${Math.round(lineData.value[1] * 100) / 100}</span>
                    </div>`;
                }
                
                return result;
            }
        },
        grid: {
            left: '5%',
            right: '5%',
            bottom: '12%',
            top: '8%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: {
                interval: function(index, value) {
                    return index % 3 === 0; // 每隔三个显示一个标签
                },
                color: '#666',
                fontSize: 10
            },
            axisLine: {
                lineStyle: {
                    color: '#ddd'
                }
            },
            axisTick: {
                alignWithLabel: true
            },
            name: '行驶距离 (km)',
            nameLocation: 'middle',
            nameGap: 30,
            nameTextStyle: {
                color: '#888',
                fontSize: 12
            }
        },
        yAxis: [{
            type: 'value',
            name: '订单数量',
            position: 'left',
            axisLine: {
                lineStyle: {
                    color: '#675bba'
                }
            },
            axisLabel: {
                color: '#666',
                fontSize: 10
            },
            splitLine: {
                lineStyle: {
                    color: 'rgba(200, 200, 200, 0.1)',
                    type: 'dashed'
                }
            }
        }, {
            type: 'value',
            name: '密度估计',
            position: 'right',
            axisLine: {
                lineStyle: {
                    color: '#ee6666'
                }
            },
            axisLabel: {
                color: '#666',
                fontSize: 10
            },
            splitLine: {
                show: false
            }
        }],
        series: [{
            name: '订单数量',
            type: 'bar',
            barWidth: '70%',
            data: values.map((value, index) => {
                return {
                    value: value,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            {offset: 0, color: 'rgba(103, 91, 186, 0.9)'},
                            {offset: 1, color: 'rgba(103, 91, 186, 0.4)'}
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    }
                };
            }),
            yAxisIndex: 0,
            z: 10,
            animationDelay: function(idx) {
                return idx * 20;
            }
        }, {
            name: '密度估计',
            type: 'line',
            smooth: true,
            symbol: 'none',
            sampling: 'average',
            itemStyle: {
                color: '#ee6666'
            },
            lineStyle: {
                width: 2,
                shadowColor: 'rgba(0, 0, 0, 0.3)',
                shadowBlur: 10
            },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    {offset: 0, color: 'rgba(238, 102, 102, 0.5)'},
                    {offset: 1, color: 'rgba(238, 102, 102, 0.1)'}
                ])
            },
            data: kdePoints,
            yAxisIndex: 1,
            z: 9,
            animationDelay: function() {
                return 300;
            }
        }],
        animationEasing: 'elasticOut',
        animationDelayUpdate: function(idx) {
            return idx * 5;
        }
    };
    
    chart.setOption(option);
    
    // 返回图表实例供其他函数使用
    return chart;
}

// 渲染订单金额分布云图
function renderOrderAmountWordcloud(amountData) {
    const chartDom = document.getElementById('order-amount-wordcloud');
    const chart = echarts.init(chartDom);
    
    // 计算最大值，用于大小和颜色映射
    const maxValue = Math.max(...amountData.map(item => item.value));
    const minValue = Math.min(...amountData.map(item => item.value));
    
    // 设置词云大小范围
    const sizeRange = [24, 80]; // 最小和最大字体大小
    
    // 为每个金额区间设置颜色和大小
    amountData.forEach(item => {
        // 归一化计算字体大小
        const fontSize = Math.floor(
            ((item.value - minValue) / (maxValue - minValue)) * (sizeRange[1] - sizeRange[0]) + sizeRange[0]
        );
        
        // 根据数值大小映射颜色
        const ratio = (item.value - minValue) / (maxValue - minValue);
        
        item.fontSize = fontSize || sizeRange[0]; // 防止值为0时字体大小计算出NaN
        // 使用HSL颜色模型，创建从蓝到红的渐变色
        const hue = Math.floor(240 - ratio * 240); // 从240(蓝)到0(红)
        item.color = `hsl(${hue}, 70%, 50%)`;
    });
    
    // 加载圆形蒙版
    const maskImage = new Image();
    maskImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAxASURBVHgB7d3rdds4EAXgAXKy/+MKVK5gN1XspopdQbQVRK5glQqiVGCmgigVWK7AdgVWKrCzgtX+WliWbUmkSAIzuPf7zuEhTh4S8XBnAAxACCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCiGL5D6uRYNVxF9qnAAAAAElFTkSuQmCC';
    
    maskImage.onload = function() {
        const option = {
            series: [{
                type: 'wordCloud',
                shape: 'circle',
                left: 'center',
                top: 'center',
                width: '90%',
                height: '90%',
                right: null,
                bottom: null,
                sizeRange: sizeRange,
                rotationRange: [-30, 30],
                rotationStep: 15,
                gridSize: 8,
                drawOutOfBound: false,
                layoutAnimation: true,
                textStyle: {
                    fontFamily: 'sans-serif',
                    fontWeight: 'bold',
                    // 通过回调函数设置词云颜色
                    color: function(params) {
                        return amountData[params.dataIndex].color;
                    }
                },
                emphasis: {
                    textStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                data: amountData
            }],
            tooltip: {
                show: true,
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderColor: '#ccc',
                borderWidth: 1,
                formatter: function(params) {
                    return `<div style="font-weight: bold;">${params.name}</div>
                            <div>订单数量: ${params.value}</div>`;
                },
                textStyle: {
                    fontSize: 14,
                    color: '#333'
                }
            },
            backgroundColor: 'rgba(255, 255, 255, 0.0)',
        };
        
        chart.setOption(option);
    };
    
    // 返回图表实例供其他函数使用
    return chart;
}

// 渲染待分配订单实时地理热点图
function renderPendingOrdersMap(data) {
    const chartDom = document.getElementById('pending-orders-map');
    const chart = echarts.init(chartDom);
    
    // 从数据中提取点数据和城市数据
    const points = data.points || [];
    const cityData = data.city_data || [];
    
    // 计算最大值用于视觉映射
    const maxCityValue = cityData.length > 0 ? Math.max(...cityData.map(c => c.value)) : 0;
    
    // 如果数据为空，显示提示信息
    if (cityData.length === 0 && points.length === 0) {
        chartDom.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-exclamation-circle fs-1"></i><p class="mt-3">{{ _("暂无待分配订单数据") }}</p></div>';
        return null;
    }
    
    // 渲染城市热力视图
    function renderMap() {
        // 使用fetch API加载中国地图数据
        fetch("{{ url_for('static', filename='js/china.json') }}")
            .then(response => response.json())
            .then(chinaJson => {
                echarts.registerMap('china', chinaJson);
                
                const option = {
                    title: {
                        text: '待分配订单城市分布',
                        left: 'center',
                        textStyle: {
                            color: '#666',
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            if (params.data && params.data.name && typeof params.data.value === 'number') {
                                return `${params.data.name}: ${params.data.value}个待分配订单`;
                            }
                            return '';
                        },
                        backgroundColor: 'rgba(50, 50, 50, 0.8)',
                        borderColor: '#555',
                        textStyle: {color: '#fff'}
                    },
                    visualMap: {
                        min: 0,
                        max: maxCityValue || 10,
                        calculable: true,
                        inRange: {
                            color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                        },
                        textStyle: {
                            color: '#666'
                        },
                        left: 'left',
                        top: 'bottom'
                    },
                    series: [
                        {
                            name: '待分配订单数量',
                            type: 'map',
                            map: 'china',
                            roam: true,
                            zoom: 1.2,
                            center: [104, 34],
                            emphasis: {
                                label: {
                                    show: true
                                },
                                itemStyle: {
                                    areaColor: '#e6f7ff'
                                }
                            },
                            data: cityData,
                            itemStyle: {
                                borderColor: '#999',
                                borderWidth: 0.5,
                                areaColor: '#f3f3f3'
                            }
                        }
                    ]
                };
                
                chart.setOption(option);
            })
            .catch(error => {
                console.error('加载地图数据失败:', error);
                showToast('加载地图数据失败，请刷新页面重试', 'error');
                
                // 如果地图加载失败，显示提示
                chartDom.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-exclamation-circle fs-1"></i><p class="mt-3">{{ _("加载地图数据失败，请刷新页面重试") }}</p></div>';
            });
    }
    
    // 初始化渲染
    const renderedChart = renderMap();
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        if (chart) {
            chart.resize();
        }
    });
    
    // 返回图表实例
    return renderedChart;
}
</script>
{% endblock %}
