{% extends "analytics/index.html" %}

{% block content_area %}
<!-- 添加样式 -->
<style>
  .card-header {
    position: relative;
  }
  .chart-info-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 0 0 10px 10px;
    font-size: 14px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    line-height: 1.5;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    max-height: 300px;
    overflow-y: auto;
  }
  .card-header:hover .chart-info-tooltip {
    opacity: 1;
    visibility: visible;
  }
  /* 图表操作按钮样式 */
  .chart-actions .btn {
    padding: 0.25rem 0.5rem;
    margin-left: 5px;
  }
  .chart-actions .btn i {
    font-size: 0.9rem;
  }
  .chart-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    display: none;
  }
  .chart-content {
    position: relative;
    width: 100%;
    height: 100%;
  }
</style>

<!-- 车辆运营效率指标卡片 -->
<div class="category-title">{{ _("车辆运营效率") }}</div>
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card metric-card h-100">
            <div class="metric-card-content">
                <div class="metric-icon bg-primary">
                    <i class="bi-taxi-front-fill"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">￥{{ daily_income_per_vehicle }}</div>
                    <div class="metric-label">{{ _("单车每日收益") }}</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，总收入 ÷ 可用车辆数 ÷ 天数（元/车/天）
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card metric-card h-100">
            <div class="metric-card-content">
                <div class="metric-icon bg-success">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ vehicle_turnover_rate }}</div>
                    <div class="metric-label">车辆周转率</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，总订单数 ÷ 车辆总数 ÷ 天数（单位：单/车/天）
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card metric-card h-100">
            <div class="metric-card-content">
                <div class="metric-icon bg-info">
                    <i class="bi bi-speedometer2"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ daily_mileage_per_vehicle }}</div>
                    <div class="metric-label">车辆日均行驶里程</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，总行驶里程 ÷ 车辆数 ÷ 天数（公里/车/天）
            </div>
        </div>
    </div>
</div>

<!-- 车辆日均行驶里程分布图 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,150,255,0.3); box-shadow: 0 0 15px rgba(0,100,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,60,125,0.8), rgba(45,120,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-bar-chart-line me-2"></i>车辆日均行驶里程分布</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="mileageDistributionChart" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="mileageDistributionChart" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表和vehicles表里程数据，按车型分组计算</p>
                    <p><strong>分析目的:</strong> 展示不同车型在日常运营中的里程表现，识别高效和低效车型</p>
                    <p><strong>方法亮点:</strong> 使用统计学分位数方法，展示中位数而非平均数，减少极端值干扰</p>
                    <p><strong>应用场景:</strong> 车队规划和车型选择决策支持，识别最适合特定运营环境的车型</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="mileageDistributionChartLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="mileageDistributionChartContent">
                    <div class="chart-container" style="position:relative; height:300px; width:100%">
                        <canvas id="mileageDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 车型累计数据排名图表 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,150,150,0.3); box-shadow: 0 0 15px rgba(255,100,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(125,25,60,0.8), rgba(255,45,120,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-pie-chart-fill me-2"></i>各车型累计完成订单数排名</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="modelOrdersChart" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="modelOrdersChart" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表和vehicles表关联数据，按车型分组聚合</p>
                    <p><strong>分析目的:</strong> 展示不同车型的市场接受度和运营效率，反映用户偏好</p>
                    <p><strong>方法亮点:</strong> 使用饼图直观展示市场份额分布，颜色渐变增强视觉效果</p>
                    <p><strong>应用场景:</strong> 车队结构优化和车型采购决策，根据用户偏好调整车队组成</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="modelOrdersChartLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="modelOrdersChartContent">
                    <div class="chart-container" style="position:relative; height:350px; width:100%">
                        <canvas id="modelOrdersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(150,255,150,0.3); box-shadow: 0 0 15px rgba(100,255,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,125,60,0.8), rgba(45,255,120,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-bar-chart-steps me-2"></i>各车型累计行驶里程排名</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="modelMileageChart" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="modelMileageChart" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> orders表里程数据，按车型分组统计</p>
                    <p><strong>分析目的:</strong> 评估车辆使用强度和耐久性表现，指导维护计划制定</p>
                    <p><strong>方法亮点:</strong> 水平条形图按降序排列，直观展示不同车型间的里程差距</p>
                    <p><strong>应用场景:</strong> 车辆维护计划制定、使用寿命预测和车辆更新周期确定</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="modelMileageChartLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="modelMileageChartContent">
                    <div class="chart-container" style="position:relative; height:350px; width:100%">
                        <canvas id="modelMileageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- 引入Chart.js和Chart.js插件 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient@0.5.0"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化所有图表变量，便于全局访问
    let mileageDistributionChart, modelOrdersChart, modelMileageChart;
    
    // 确保日期范围选择器保持当前状态
    // 获取URL中的日期参数
    const urlParams = new URLSearchParams(window.location.search);
    const dateRange = urlParams.get('date_range') || 'last_30_days';
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    
    // 设置日期选择器的值
    const dateRangeSelect = document.getElementById('date-range');
    if(dateRangeSelect) {
        dateRangeSelect.value = dateRange;
        
        // 如果是自定义日期范围，设置日期输入框的值
        if(dateRange === 'custom' && startDate && endDate) {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            if(startDateInput) startDateInput.value = startDate;
            if(endDateInput) endDateInput.value = endDate;
        }
    }

    // 设置车辆运营效率标签页为活跃状态
    const tabLinks = document.querySelectorAll('#analytics-tab .nav-link');
    tabLinks.forEach(link => link.classList.remove('active'));
    const vehicleEfficiencyTab = document.getElementById('vehicle-efficiency-tab');
    if(vehicleEfficiencyTab) {
        vehicleEfficiencyTab.classList.add('active');
    }
    
    // 初始化工具提示
    var tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(function(el) {
        return new bootstrap.Tooltip(el);
    });
    
    // 图表ID与加载区域ID的映射
    const chartToLoadingMap = {
        'mileageDistributionChart': 'mileageDistribution',
        'modelOrdersChart': 'modelOrders',
        'modelMileageChart': 'modelMileage'
    };
    
    // 加载模拟函数
    function simulateLoading(chartId, delay = 800) {
        const loadingId = chartId + 'Loading';
        const contentId = chartId + 'Content';
        
        document.getElementById(loadingId).style.display = 'flex';
        document.getElementById(contentId).style.opacity = '0.3';
        
        setTimeout(function() {
            document.getElementById(loadingId).style.display = 'none';
            document.getElementById(contentId).style.opacity = '1';
        }, delay);
    }
    
    // 刷新图表按钮事件处理
    document.querySelectorAll('.refresh-chart').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.getAttribute('data-chart');
            const loadingId = chartToLoadingMap[chartId];
            if (loadingId) {
                simulateLoading(chartId, 800);
            }
        });
    });
    
    // 图表下载功能
    document.querySelectorAll('.download-chart').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.getAttribute('data-chart');
            const chartCanvas = document.getElementById(chartId);
            const chartName = chartCanvas.closest('.card').querySelector('.card-title').textContent.trim();
            
            try {
                // 获取当前图表对象
                let chart;
                switch(chartId) {
                    case 'mileageDistributionChart':
                        chart = mileageDistributionChart;
                        break;
                    case 'modelOrdersChart':
                        chart = modelOrdersChart;
                        break;
                    case 'modelMileageChart':
                        chart = modelMileageChart;
                        break;
                }
                
                if (!chart) {
                    console.error('找不到图表对象:', chartId);
                    return;
                }
                
                // 创建临时高分辨率画布
                const tempCanvas = document.createElement('canvas');
                const scale = 3; // 3倍分辨率
                tempCanvas.width = chartCanvas.width * scale;
                tempCanvas.height = chartCanvas.height * scale;
                
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.scale(scale, scale);
                tempCtx.fillStyle = '#ffffff';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // 绘制图表到高分辨率画布
                tempCtx.drawImage(chartCanvas, 0, 0);
                
                // 转换为数据URL并触发下载
                const link = document.createElement('a');
                link.download = `${chartName.replace(/\s+/g, '_')}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (err) {
                console.error('导出图表错误:', err);
                alert('导出图表失败，请重试');
            }
        });
    });
    
    // 定义生成渐变色的函数
    function generateGradient(ctx, startColor, endColor) {
        const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        gradient.addColorStop(0, startColor);
        gradient.addColorStop(1, endColor);
        return gradient;
    }
    
    // 1. 里程分布图
    const mileageDistributionCtx = document.getElementById('mileageDistributionChart');
    if(mileageDistributionCtx) {
        // 后端已使用json.dumps将数据转为JSON字符串，先将其解析为JavaScript对象
        let mileageData = {{ mileage_distribution_data|safe }};
        
        const modelNames = mileageData.map(item => item.label);
        const medianValues = mileageData.map(item => item.median);
        
        mileageDistributionChart = new Chart(mileageDistributionCtx, {
            type: 'bar',
            data: {
                labels: modelNames,
                datasets: [{
                    label: '日均行驶里程中位数',
                    data: medianValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataIndex = context.dataIndex;
                                const data = mileageData[dataIndex];
                                return [
                                    `车型: ${data.label}`,
                                    `最小值: ${data.min.toFixed(2)} km`,
                                    `25%分位: ${data.q1.toFixed(2)} km`,
                                    `中位数: ${data.median.toFixed(2)} km`,
                                    `75%分位: ${data.q3.toFixed(2)} km`,
                                    `最大值: ${data.max.toFixed(2)} km`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '日均里程 (公里/天)'
                        },
                        grid: {
                            drawBorder: false,
                            color: 'rgba(200, 200, 200, 0.2)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // 2. 订单排名图 - 使用饼图
    const modelOrdersCtx = document.getElementById('modelOrdersChart');
    if(modelOrdersCtx) {
        // 后端已使用json.dumps将数据转为JSON字符串，先将其解析为JavaScript对象
        let modelLabels = {{ model_labels|safe }};
        let modelOrdersData = {{ model_orders_data|safe }};
        
        // 获取绘图上下文，用于生成渐变色
        const ctx = modelOrdersCtx.getContext('2d');
        
        // 使用果冻色渐变效果
        const gradientColors = [];
        const baseColors = [
            ['rgba(255, 99, 132, 0.9)', 'rgba(255, 99, 132, 0.5)'],
            ['rgba(54, 162, 235, 0.9)', 'rgba(54, 162, 235, 0.5)'],
            ['rgba(255, 206, 86, 0.9)', 'rgba(255, 206, 86, 0.5)'],
            ['rgba(75, 192, 192, 0.9)', 'rgba(75, 192, 192, 0.5)'],
            ['rgba(153, 102, 255, 0.9)', 'rgba(153, 102, 255, 0.5)'],
            ['rgba(255, 159, 64, 0.9)', 'rgba(255, 159, 64, 0.5)'],
            ['rgba(199, 199, 199, 0.9)', 'rgba(199, 199, 199, 0.5)'],
            ['rgba(83, 102, 255, 0.9)', 'rgba(83, 102, 255, 0.5)'],
            ['rgba(78, 205, 196, 0.9)', 'rgba(78, 205, 196, 0.5)'],
            ['rgba(232, 65, 24, 0.9)', 'rgba(232, 65, 24, 0.5)']
        ];
        
        for (let i = 0; i < baseColors.length; i++) {
            const gradient = ctx.createRadialGradient(
                ctx.canvas.width / 2, 
                ctx.canvas.height / 2, 
                0, 
                ctx.canvas.width / 2, 
                ctx.canvas.height / 2, 
                ctx.canvas.width / 2
            );
            gradient.addColorStop(0, baseColors[i][0]);
            gradient.addColorStop(1, baseColors[i][1]);
            gradientColors.push(gradient);
        }
        
        // 创建饼图
        modelOrdersChart = new Chart(modelOrdersCtx, {
            type: 'pie',
            data: {
                labels: modelLabels,
                datasets: [{
                    label: '累计完成订单数',
                    data: modelOrdersData,
                    backgroundColor: gradientColors.slice(0, modelLabels.length),
                    borderWidth: 1,
                    borderColor: 'rgba(255, 255, 255, 0.5)',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} 单 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 3. 里程排名图 - 使用水平进度条样式
    const modelMileageCtx = document.getElementById('modelMileageChart');
    if(modelMileageCtx) {
        // 后端已使用json.dumps将数据转为JSON字符串，先将其解析为JavaScript对象
        let modelLabels = {{ model_labels|safe }};
        let modelMileageData = {{ model_mileage_data|safe }};
        
        // 计算最大值用于百分比计算
        const maxMileage = Math.max(...modelMileageData);
        
        // 数据排序处理（从高到低）
        const sortedData = [...modelMileageData].map((value, index) => ({
            label: modelLabels[index],
            value: value
        })).sort((a, b) => b.value - a.value);
        
        const sortedLabels = sortedData.map(item => item.label);
        const sortedValues = sortedData.map(item => item.value);
        
        // 创建水平柱状图
        modelMileageChart = new Chart(modelMileageCtx, {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: '累计行驶里程',
                    data: sortedValues,
                    backgroundColor: function(context) {
                        const index = context.dataIndex;
                        const hue = (index * 25) % 360;
                        return `hsla(${hue}, 80%, 60%, 0.8)`;
                    },
                    borderWidth: 0,
                    borderRadius: 10,
                    borderSkipped: false,
                    maxBarThickness: 25
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toFixed(1)} 公里`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    },
                    y: {
                        grid: {
                            display: false,
                            drawBorder: false
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart'
                }
            }
        });
    }
    
    // 初始隐藏所有加载指示器
    document.querySelectorAll('.chart-loading').forEach(loading => {
        loading.style.display = 'none';
    });
});
</script>
{% endblock %}
