{% extends "analytics/index.html" %}

{% block content_area %}
<!-- 添加样式 -->
<style>
  .card-header {
    position: relative;
  }
  .chart-info-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 0 0 10px 10px;
    font-size: 14px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    line-height: 1.5;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    max-height: 300px;
    overflow-y: auto;
  }
  .card-header:hover .chart-info-tooltip {
    opacity: 1;
    visibility: visible;
  }
  
  /* 图表操作按钮样式 */
  .chart-actions .btn {
    padding: 0.25rem 0.5rem;
    margin-left: 5px;
  }
  
  .chart-actions .btn i {
    font-size: 0.9rem;
  }
  
  .chart-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
</style>

<!-- 充电和电池管理指标卡片 -->
<div class="category-title">{{ _("充电和电池管理") }}</div>
<div class="row mb-4 g-3">
    <div class="col-md-6">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon bg-warning">
                    <i class="bi bi-battery-charging"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ battery_usage_efficiency }}</div>
                    <div class="metric-label">{{ _("收入/充电站支出比") }}</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，车费收入与充电站支出的比值（元/元）
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon bg-danger">
                    <i class="bi bi-lightning-charge"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ daily_charging_per_vehicle }}</div>
                    <div class="metric-label">{{ _("车辆日均充电次数") }}</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，充电站支出表中金额小于1万的充电记录数 ÷ 车辆数 ÷ 天数（次/车/天）
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4">
    <!-- 充电站实时利用率仪表盘 -->
    <div class="col-md-12 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,180,0,0.3); box-shadow: 0 0 15px rgba(255,150,0,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(180,90,0,0.8), rgba(255,150,0,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-speedometer2 me-2"></i>充电站实时利用率仪表盘
                </h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="charging-stations-gauge" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="charging-stations-gauge" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 各城市充电站当前使用情况与最大容量数据统计</p>
                    <p><strong>分析目的:</strong> 监控各城市充电站资源使用情况，识别饱和或闲置区域</p>
                    <p><strong>图表说明:</strong> 通过仪表盘直观展示各城市充电站使用率，红色表示接近饱和状态，绿色表示有充足容量</p>
                </div>
            </div>
            <div class="card-body p-0 position-relative">
                <div class="chart-loading" id="charging-stations-gaugeLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="charging-stations-gaugeContent">
                    <div id="charging-stations-gauge" style="height: 540px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 车辆电池电量分布直方图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,200,255,0.3); box-shadow: 0 0 15px rgba(0,150,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,80,150,0.8), rgba(45,150,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-bar-chart-fill me-2"></i>车辆电池电量分布
                </h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="battery-level-histogram" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="battery-level-histogram" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 车辆表中当前电量数据，按电量区间统计车辆数量</p>
                    <p><strong>分析目的:</strong> 了解车队整体电量状况，评估充电需求紧急程度</p>
                    <p><strong>图表说明:</strong> 统计不同电量区间的车辆数量，颜色从红(低电量)到绿(高电量)渐变</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column position-relative">
                <div class="chart-loading" id="battery-level-histogramLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="battery-level-histogramContent">
                    <div id="battery-level-histogram" style="height: 380px; flex-grow: 1;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 充电高峰时段热力图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,150,150,0.3); box-shadow: 0 0 15px rgba(255,100,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(150,25,60,0.8), rgba(255,60,120,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-calendar-week me-2"></i>充电高峰时段热力图
            
                </h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="charging-peak-heatmap" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="charging-peak-heatmap" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 充电记录数据，按星期和小时统计充电频次</p>
                    <p><strong>分析目的:</strong> 发现充电高峰时段，优化充电资源调度和充电桩布局</p>
                    <p><strong>图表说明:</strong> 热力图颜色深浅代表充电频次高低，红色区域表示高峰时段</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column position-relative">
                <div class="chart-loading" id="charging-peak-heatmapLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="charging-peak-heatmapContent">
                    <div id="charging-peak-heatmap" style="height: 330px; flex-grow: 1;"></div>
                    <div id="peak-time-info" class="mt-2 text-center small" style="min-height: 50px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 车辆平均电量地理位置热点图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,200,150,0.3); box-shadow: 0 0 15px rgba(50,150,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,100,60,0.8), rgba(45,180,120,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-geo-alt-fill me-2"></i>车辆平均电量地理分布
                </h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="battery-level-map" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="battery-level-map" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 车辆位置与电量数据，按省份聚合计算平均值</p>
                    <p><strong>分析目的:</strong> 识别不同区域的能耗特点，发现电量异常低的区域</p>
                    <p><strong>图表说明:</strong> 地图颜色从红(低电量)到绿(高电量)渐变，直观展示区域电量状况</p>
                </div>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="battery-level-mapLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="battery-level-mapContent">
                    <div id="battery-level-map" style="height: 450px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 各城市充电需求 vs 容量对比图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(150,150,255,0.3); box-shadow: 0 0 15px rgba(100,100,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(60,25,150,0.8), rgba(120,60,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-bar-chart-steps me-2"></i>各城市充电需求VS容量对比
                </h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="city-charging-capacity" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="city-charging-capacity" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 城市车辆数量、低电量车辆数及充电站容量统计</p>
                    <p><strong>分析目的:</strong> 评估各城市充电资源配置合理性，发现供需不平衡区域</p>
                    <p><strong>图表说明:</strong> 水平条形图对比需求与容量，散点标识需求/容量比，红色表示资源严重不足</p>
                </div>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="city-charging-capacityLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div class="chart-content" id="city-charging-capacityContent">
                    <div id="city-charging-capacity" style="height: 450px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 确保充电电池标签页为活跃状态
    const tabLinks = document.querySelectorAll('#analytics-tab .nav-link');
    tabLinks.forEach(link => link.classList.remove('active'));
    const chargingBatteryTab = document.getElementById('charging-battery-tab');
    if(chargingBatteryTab) {
        chargingBatteryTab.classList.add('active');
    }
    
    // 解析JSON数据
    const chargingStationsData = JSON.parse('{{ charging_stations_data|safe }}');
    const batteryDistribution = JSON.parse('{{ battery_distribution|safe }}');
    const chargingPeakHours = JSON.parse('{{ charging_peak_hours|safe }}');
    const batteryMapData = JSON.parse('{{ battery_map_data|safe }}');
    const cityChargingData = JSON.parse('{{ city_charging_data|safe }}');
    
    // 充电站实时利用率仪表盘
    renderChargingStationsGauge(chargingStationsData);
    
    // 车辆电池电量分布直方图
    renderBatteryLevelHistogram(batteryDistribution);
    
    // 充电高峰时段热力图
    renderChargingPeakHeatmap(chargingPeakHours);
    
    // 车辆平均电量地理位置热点图
    renderBatteryLevelMap(batteryMapData);
    
    // 各城市充电需求 vs 容量对比图
    renderCityChargingCapacity(cityChargingData);
    
    // 窗口大小改变时重新渲染图表
    window.addEventListener('resize', function() {
        renderChargingStationsGauge(chargingStationsData);
        renderBatteryLevelHistogram(batteryDistribution);
        renderChargingPeakHeatmap(chargingPeakHours);
        renderBatteryLevelMap(batteryMapData);
        renderCityChargingCapacity(cityChargingData);
    });
});

// 充电站实时利用率仪表盘
function renderChargingStationsGauge(data) {
    if (!data || data.length === 0) {
        document.getElementById('charging-stations-gauge').innerHTML = '<div class="alert alert-warning">暂无充电站数据</div>';
        return;
    }
    
    const gaugeChart = echarts.init(document.getElementById('charging-stations-gauge'));
    
    // 布局优化：使用3行4列的布局
    const cityCount = data.length;
    const rows = 3;
    const cols = 4;
    
    const series = [];
    const titles = [];
    
    // 为每个城市创建一个仪表盘
    for (let i = 0; i < cityCount; i++) {
        const city = data[i];
        const utilRate = parseFloat(city.utilization_rate);
        
        // 计算位置，实现多行布局
        const row = Math.floor(i / cols);
        const col = i % cols;
        
        // 为每个仪表盘预留边距，防止重叠
        const cellWidth = 92 / cols; // 92%总宽度，两侧各留4%边距
        const cellHeight = 88 / rows; // 90%总高度，顶部和底部各留5%边距
        
        const centerX = col * cellWidth + cellWidth/2 + 4; // 加上左侧4%边距
        const centerY = row * cellHeight + cellHeight/2 + 20; // 加上顶部5%边距
        
        // 添加标题
        titles.push({
            text: city.city_code,
            left: `${centerX}%`,
            top: `${row * cellHeight + 7}%`, // 距离顶部多留些空间
            textAlign: 'center',
            textStyle: {
                fontSize: 14,
                fontWeight: 'bold'
            }
        });
        
        // 添加仪表盘
        series.push({
            name: city.city_code,
            type: 'gauge',
            center: [`${centerX}%`, `${centerY}%`],
            radius: '43%', // 进一步缩小仪表盘
            startAngle: 180,
            endAngle: 0,
            min: 0,
            max: 100,
            itemStyle: {
                color: function(params) {
                    const value = params.value;
                    if (value < 30) return '#91cc75'; 
                    if (value < 70) return '#fac858';
                    return '#ee6666';
                }
            },
            progress: {
                show: true,
                width: 8 // 更小的进度条宽度
            },
            pointer: {
                show: true,
                length: '50%',
                width: 3
            },
            axisLine: {
                lineStyle: {
                    width: 8 // 更小的轴线宽度
                }
            },
            axisTick: {
                show: false
            },
            splitLine: {
                length: 8,
                lineStyle: {
                    width: 1,
                    color: '#999'
                }
            },
            axisLabel: {
                distance: -15,
                color: '#999',
                fontSize: 8
            },
            anchor: {
                show: true,
                showAbove: true,
                size: 12,
                itemStyle: {
                    borderWidth: 3
                }
            },
            title: {
                show: true,
                offsetCenter: [0, '-10%'],
                fontSize: 9
            },
            detail: {
                valueAnimation: true,
                fontSize: 11,
                color: '#333',
                offsetCenter: [0, '-20%'],
                formatter: '{value}%'
            },
            data: [{
                value: utilRate,
                name: `${city.total_current_vehicles}/${city.total_max_capacity}`
            }]
        });
    }
    
    const option = {
        title: titles,
        series: series,
        tooltip: {
            formatter: '{a} <br/>{c}% 利用率'
        }
    };
    
    gaugeChart.setOption(option);
    
    // 将高度设为固定540px，与卡片高度一致
    document.getElementById('charging-stations-gauge').style.height = '540px';
}

// 车辆电池电量分布直方图
function renderBatteryLevelHistogram(data) {
    if (!data || !data.ranges || data.ranges.length === 0) {
        document.getElementById('battery-level-histogram').innerHTML = '<div class="alert alert-warning">暂无电池电量数据</div>';
        return;
    }
    
    const histogramChart = echarts.init(document.getElementById('battery-level-histogram'));
    
    // 为直方图设置不同的颜色
    const colorMap = [
        '#ff0000', // 0%（红色）
        '#ee6666', // 0-10%
        '#ee9966', // 10-20%
        '#eecc66', // 20-30%
        '#eee466', // 30-40%
        '#cce466', // 40-50%
        '#99e466', // 50-60%
        '#66e466', // 60-70%
        '#66e499', // 70-80%
        '#66e4cc', // 80-90%
        '#00ff00'  // 100%（绿色）
    ];
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: '{b}: {c} 辆车'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '8%',
            top: '8%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: data.ranges,
            axisLabel: {
                interval: 0,
                rotate: 45,
                fontSize: 11
            }
        },
        yAxis: {
            type: 'value',
            name: '车辆数量',
            minInterval: 1
        },
        series: [{
            name: '电量分布',
            type: 'bar',
            data: data.counts.map((value, index) => {
                return {
                    value: value,
                    itemStyle: {
                        color: colorMap[index % colorMap.length]
                    }
                };
            }),
            barWidth: '50%',
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: true,
                position: 'top',
                formatter: '{c}'
            },
            animation: true,
            animationDelay: function(idx) {
                return idx * 100;
            }
        }]
    };
    
    histogramChart.setOption(option);
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        histogramChart.resize();
    });
}

// 充电高峰时段热力图
function renderChargingPeakHeatmap(data) {
    if (!data || !data.days || data.days.length === 0) {
        document.getElementById('charging-peak-heatmap').innerHTML = '<div class="alert alert-warning">暂无充电高峰时段数据</div>';
        document.getElementById('peak-time-info').innerHTML = '';
        return;
    }
    
    const heatmapChart = echarts.init(document.getElementById('charging-peak-heatmap'));

    // 计算最大值，忽略0值
    let maxValue = 0;
    let peakDay = -1;
    let peakHour = -1;
    let totalCharging = data.total_charging || 0;
    
    // 找出最高峰时段
    data.data.forEach(item => {
        if (item[2] > maxValue) {
            maxValue = item[2];
            peakHour = item[0];
            peakDay = item[1];
        }
    });
    
    // 如果没有数据，设置默认最大值
    if (maxValue === 0) maxValue = 10;
    
    const option = {
        tooltip: {
            position: 'top',
            formatter: function (params) {
                const percentage = totalCharging > 0 ? 
                    ((params.value[2] / totalCharging) * 100).toFixed(1) + '%' : '0%';
                return `${data.days[params.value[1]]} ${data.hours[params.value[0]]}<br>充电次数: ${params.value[2]}<br>占比: ${percentage}`;
            }
        },
        grid: {
            top: '10%',
            bottom: '15%',
            left: '10%',
            right: '10%'
        },
        xAxis: {
            type: 'category',
            data: data.hours,
            splitArea: {
                show: true
            },
            axisLabel: {
                interval: 3,
                fontSize: 10
            }
        },
        yAxis: {
            type: 'category',
            data: data.days,
            splitArea: {
                show: true
            }
        },
        visualMap: {
            min: 0,
            max: maxValue,
            calculable: true,
            orient: 'horizontal',
            left: 'center',
            bottom: '5%',
            inRange: {
                color: ['#f5f5f5', '#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', 
                        '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
            },
            controller: {
                inRange: {
                    opacity: 0.8
                }
            }
        },
        series: [{
            name: '充电次数',
            type: 'heatmap',
            data: data.data,
            label: {
                show: true,
                formatter: function(params) {
                    return params.value[2] > 0 ? params.value[2] : '';
                }
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            }
        }]
    };
    
    heatmapChart.setOption(option);
    
    // 显示高峰时段信息
    if (peakDay >= 0 && peakHour >= 0) {
        const peakDayName = data.days[peakDay];
        const peakHourName = data.hours[peakHour];
        const peakCount = maxValue;
        const peakPercentage = totalCharging > 0 ? ((peakCount / totalCharging) * 100).toFixed(1) : 0;
        
        document.getElementById('peak-time-info').innerHTML = 
            `<span class="badge bg-danger">{{ _("最高峰时段") }}</span> ${peakDayName} ${peakHourName}，共${peakCount}次充电 (${peakPercentage}%)<br>` +
            `所选日期范围内总充电次数: ${totalCharging}次`;
    } else {
        document.getElementById('peak-time-info').innerHTML = `所选日期范围内总充电次数: ${totalCharging}次`;
    }
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        heatmapChart.resize();
    });
}

// 车辆平均电量地理位置热点图
function renderBatteryLevelMap(data) {
    if (!data || data.length === 0) {
        document.getElementById('battery-level-map').innerHTML = '<div class="alert alert-warning">暂无车辆电量地理分布数据</div>';
        return;
    }
    
    const mapChart = echarts.init(document.getElementById('battery-level-map'));
    
    // 数据格式检查和转换
    if (!Array.isArray(data)) {
        console.error('电量地理分布数据格式错误');
        data = [];
    }
    
    // 省份名称映射（简称到全称）
    const provinceNameMap = {
        '北京': '北京市',
        '天津': '天津市',
        '上海': '上海市',
        '重庆': '重庆市',
        '河北': '河北省',
        '山西': '山西省',
        '辽宁': '辽宁省',
        '吉林': '吉林省',
        '黑龙江': '黑龙江省',
        '江苏': '江苏省',
        '浙江': '浙江省',
        '安徽': '安徽省',
        '福建': '福建省',
        '江西': '江西省',
        '山东': '山东省',
        '河南': '河南省',
        '湖北': '湖北省',
        '湖南': '湖南省',
        '广东': '广东省',
        '海南': '海南省',
        '四川': '四川省',
        '贵州': '贵州省',
        '云南': '云南省',
        '陕西': '陕西省',
        '甘肃': '甘肃省',
        '青海': '青海省',
        '台湾': '台湾省',
        '内蒙古': '内蒙古自治区',
        '广西': '广西壮族自治区',
        '西藏': '西藏自治区',
        '宁夏': '宁夏回族自治区',
        '新疆': '新疆维吾尔自治区',
        '香港': '香港特别行政区',
        '澳门': '澳门特别行政区'
    };
    
    // 格式化数据，确保省份名称正确
    const formattedData = data.map(item => {
        const provinceName = item.name || '';
        const mappedName = provinceNameMap[provinceName] || provinceName;
        
        return {
            name: mappedName,
            value: item.value || 0,
            count: item.count || 0
        };
    });
    
    // 计算最大值，避免除以0
    const maxValue = Math.max(...formattedData.map(item => item.value)) || 100;
    
    // 使用fetch API加载中国地图数据
    fetch("{{ url_for('static', filename='js/china.json') }}")
        .then(response => response.json())
        .then(chinaJson => {
            echarts.registerMap('china', chinaJson);
            
            const option = {
                title: {
                    text: '车辆平均电量地理分布',
                    left: 'center',
                    textStyle: {
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        // 查找对应的数据项获取车辆数
                        const dataItem = formattedData.find(item => item.name === params.name);
                        const count = dataItem ? dataItem.count : 0;
                        const value = params.value || 0;
                        
                        return `${params.name}<br>平均电量: ${value}%<br>车辆数: ${count}辆`;
                    }
                },
                visualMap: {
                    min: 0,
                    max: 100,
                    left: 'left',
                    top: 'bottom',
                    text: ['高电量', '低电量'],
                    calculable: true,
                    inRange: {
                        color: ['#ff4d4d', '#ff944d', '#ffdc4d', '#a3ff4d', '#4dff4d']
                    }
                },
                series: [{
                    name: '平均电量',
                    type: 'map',
                    map: 'china',
                    roam: true,
                    emphasis: {
                        label: {
                            show: true
                        }
                    },
                    data: formattedData,
                    itemStyle: {
                        borderColor: '#999',
                        borderWidth: 1,
                        areaColor: '#f3f3f3'
                    }
                }]
            };
            
            mapChart.setOption(option);
        })
        .catch(error => {
            console.error('加载地图数据失败:', error);
            document.getElementById('battery-level-map').innerHTML = 
                '<div class="alert alert-danger">加载地图数据失败，请刷新页面重试</div>';
        });
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        mapChart.resize();
    });
}

// 根据电量获取颜色
function getColorByBatteryLevel(level) {
    // 红色到绿色的渐变
    if (level < 20) return '#ff4d4d'; // 红色
    if (level < 40) return '#ff944d'; // 橙色
    if (level < 60) return '#ffdc4d'; // 黄色
    if (level < 80) return '#a3ff4d'; // 浅绿色
    return '#4dff4d'; // 绿色
}

// 各城市充电需求 vs 容量对比图
function renderCityChargingCapacity(data) {
    if (!data || !data.cities || data.cities.length === 0) {
        document.getElementById('city-charging-capacity').innerHTML = '<div class="alert alert-warning">暂无城市充电需求与容量数据</div>';
        return;
    }
    
    const chartDom = document.getElementById('city-charging-capacity');
    const barChart = echarts.init(chartDom);
    
    // 生成渐变色
    const demandGradient = new echarts.graphic.LinearGradient(0, 0, 1, 0, [
        {offset: 0, color: '#5470c6'},
        {offset: 1, color: '#91cc75'}
    ]);
    
    const capacityGradient = new echarts.graphic.LinearGradient(0, 0, 1, 0, [
        {offset: 0, color: '#73c0de'},
        {offset: 1, color: '#3ba272'}
    ]);
    
    const lowBatteryGradient = new echarts.graphic.LinearGradient(0, 0, 1, 0, [
        {offset: 0, color: '#fc8452'},
        {offset: 1, color: '#ee6666'}
    ]);

    // 处理数据，确保所有城市都有完整数据
    const cities = data.cities || [];
    const demand = data.demand || [];
    const capacity = data.capacity || [];
    const lowBattery = data.low_battery || [];
    const ratio = data.ratio || [];
    
    // 数据排序 - 按需求量从大到小排序
    const sortData = [];
    for (let i = 0; i < cities.length; i++) {
        sortData.push({
            city: cities[i],
            demand: demand[i],
            capacity: capacity[i],
            lowBattery: lowBattery[i],
            ratio: ratio[i]
        });
    }
    
    sortData.sort((a, b) => b.demand - a.demand);
    
    // 重新组织排序后的数据
    const sortedCities = sortData.map(item => item.city);
    const sortedDemand = sortData.map(item => item.demand);
    const sortedCapacity = sortData.map(item => item.capacity);
    const sortedLowBattery = sortData.map(item => item.lowBattery);
    const sortedRatio = sortData.map(item => item.ratio);
    
    // 为比例创建特殊颜色标记
    const ratioColors = sortedRatio.map(value => {
        if (value > 150) return '#c13531'; // 危险
        if (value > 100) return '#e87c25'; // 警告
        if (value > 80) return '#fad860'; // 注意
        return '#91cc75'; // 正常
    });
    
    const option = {
        title: {
            text: '充电需求与容量对比分析',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function(params) {
                // 查找对应索引
                const index = params[0].dataIndex;
                const city = sortedCities[index];
                const demandValue = sortedDemand[index];
                const capacityValue = sortedCapacity[index];
                const lowBatteryValue = sortedLowBattery[index];
                const ratioValue = sortedRatio[index];
                
                // 构建提示框内容
                let html = `<div style="font-weight:bold;margin-bottom:5px">${city}</div>`;
                html += `<div>充电需求: <span style="float:right;font-weight:bold">${demandValue} 辆</span></div>`;
                html += `<div>充电容量: <span style="float:right;font-weight:bold">${capacityValue} 个</span></div>`;
                html += `<div>低电量车辆: <span style="float:right;font-weight:bold">${lowBatteryValue} 辆</span></div>`;
                html += `<div style="margin-top:5px;padding-top:5px;border-top:1px solid #eee">`;
                
                // 根据比例添加不同颜色的状态指示
                let statusColor = '#91cc75';
                let statusText = '充足';
                
                if (ratioValue > 150) {
                    statusColor = '#c13531';
                    statusText = '严重不足';
                } else if (ratioValue > 100) {
                    statusColor = '#e87c25';
                    statusText = '不足';
                } else if (ratioValue > 80) {
                    statusColor = '#fad860';
                    statusText = '接近饱和';
                }
                
                html += `需求/容量比: <span style="float:right;font-weight:bold">${ratioValue}%</span></div>`;
                html += `<div>容量状态: <span style="float:right;font-weight:bold;color:${statusColor}">${statusText}</span></div>`;
                
                return html;
            }
        },
        legend: {
            data: ['充电需求', '充电容量', '低电量车辆', '需求/容量比(%)'],
            top: 35
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '8%',
            top: '20%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            name: '数量',
            axisLabel: {
                formatter: '{value}'
            },
            splitLine: {
                lineStyle: {
                    type: 'dashed'
                }
            }
        },
        yAxis: {
            type: 'category',
            data: sortedCities,
            axisLabel: {
                fontSize: 12
            }
        },
        series: [
            {
                name: '充电需求',
                type: 'bar',
                stack: 'total',
                label: {
                    show: true,
                    position: 'insideRight',
                    formatter: '{c}',
                    color: '#fff',
                    fontSize: 12
                },
                emphasis: {
                    focus: 'series'
                },
                data: sortedDemand.map(value => ({
                    value: value,
                    itemStyle: {
                        color: demandGradient
                    }
                })),
                barWidth: '20%',
                barGap: '100%',
                z: 3
            },
            {
                name: '充电容量',
                type: 'bar',
                label: {
                    show: true,
                    position: 'insideRight',
                    formatter: '{c}',
                    color: '#fff',
                    fontSize: 12
                },
                emphasis: {
                    focus: 'series'
                },
                data: sortedCapacity.map(value => ({
                    value: value,
                    itemStyle: {
                        color: capacityGradient
                    }
                })),
                barWidth: '20%',
                z: 2
            },
            {
                name: '低电量车辆',
                type: 'bar',
                label: {
                    show: true,
                    position: 'insideRight',
                    formatter: '{c}',
                    color: '#fff',
                    fontSize: 12
                },
                emphasis: {
                    focus: 'series'
                },
                data: sortedLowBattery.map(value => ({
                    value: value,
                    itemStyle: {
                        color: lowBatteryGradient
                    }
                })),
                barWidth: '20%',
                z: 1
            },
            {
                name: '需求/容量比(%)',
                type: 'scatter',
                symbolSize: 20,
                label: {
                    show: true,
                    position: 'inside',
                    formatter: function(params) {
                        return params.value.toFixed(0) + '%';
                    },
                    color: '#fff',
                    fontSize: 10
                },
                data: sortedRatio.map((value, index) => ({
                    value: value,
                    itemStyle: {
                        color: ratioColors[index]
                    }
                })),
                yAxisIndex: 0,
                xAxisIndex: 0,
                z: 4
            }
        ],
        // 添加图表动画效果
        animationEasing: 'elasticOut',
        animationDelay: function (idx) {
            return idx * 100 + 100;
        }
    };
    
    barChart.setOption(option);
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        barChart.resize();
    });
}

/**
 * 图表实例存储对象 - 用于刷新和下载功能
 */
 const chartInstances = {};

/**
 * 图表ID与对应初始化函数的映射
 */
const chartInitFunctions = {
    'charging-stations-gauge': renderChargingStationsGauge,
    'battery-level-histogram': renderBatteryLevelHistogram,
    'charging-peak-heatmap': renderChargingPeakHeatmap,
    'battery-level-map': renderBatteryLevelMap,
    'city-charging-capacity': renderCityChargingCapacity
};

/**
 * 在DOM加载完成后绑定按钮事件
 */
document.addEventListener('DOMContentLoaded', function() {
    // 初始化工具提示
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(el => new bootstrap.Tooltip(el));
    }
    
    // 绑定图表刷新按钮事件
    bindRefreshButtons();
    
    // 绑定图表下载按钮事件
    bindDownloadButtons();
    
    // 监听窗口调整大小事件，调整所有图表大小
            window.addEventListener('resize', function() {
        for (const chartId in chartInstances) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].resize();
            }
        }
    });
});

/**
 * 绑定所有刷新按钮的点击事件
 */
function bindRefreshButtons() {
    document.querySelectorAll('.refresh-chart').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.getAttribute('data-chart');
            refreshChart(chartId);
            });
        });
}

/**
 * 刷新指定图表
 * @param {string} chartId - 图表的DOM ID
 */
function refreshChart(chartId) {
    // 显示加载中效果
    const loadingId = chartId + 'Loading';
    const loadingEl = document.getElementById(loadingId);
    if (loadingEl) {
        loadingEl.style.display = 'flex';
    }
    
    // 使用AJAX获取最新数据
    fetch('/analytics/battery-data?chart=' + chartId)
        .then(response => {
            if (!response.ok) {
                throw new Error('网络请求失败');
            }
            return response.json();
        })
        .then(data => {
            // 调用对应的初始化函数刷新图表
            const initFunc = chartInitFunctions[chartId];
            if (typeof initFunc === 'function') {
                initFunc(data);
                // 隐藏加载效果
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            } else {
                console.warn(`没有找到图表 ${chartId} 的初始化函数`);
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('获取图表数据失败:', error);
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            // 显示错误提示
            const contentEl = document.getElementById(chartId + 'Content');
            if (contentEl) {
                contentEl.innerHTML = `<div class="alert alert-danger">获取数据失败，请重试</div>`;
            }
        });
}

/**
 * 绑定所有下载按钮的点击事件
 */
function bindDownloadButtons() {
    document.querySelectorAll('.download-chart').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.getAttribute('data-chart');
            downloadChart(chartId);
        });
    });
}

/**
 * 下载指定图表为PNG图片
 * @param {string} chartId - 图表的DOM ID
 */
function downloadChart(chartId) {
    try {
        const chartInstance = chartInstances[chartId];
        if (!chartInstance) {
            console.error(`找不到图表实例: ${chartId}`);
            return;
        }
        
        // 获取图表容器和标题
        const chartContainer = document.getElementById(chartId);
        const chartTitle = chartContainer.closest('.card').querySelector('.card-title').textContent.trim();
        const fileName = chartTitle.replace(/\s+/g, '_') + '.png';
        
        // 获取图表的画布元素
        const canvas = chartInstance.getRenderedCanvas({
            pixelRatio: 3, // 3倍分辨率提高图片质量
            backgroundColor: '#fff'
        });
        
        // 创建下载链接
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
    } catch (err) {
        console.error('下载图表失败:', err);
        alert('下载图表失败，请重试。错误详情: ' + err.message);
    }
}

/**
 * 修改原有的echarts初始化函数，保存图表实例到全局对象中
 * 以便支持刷新和下载功能
 */
const originalEChartsInit = echarts.init;
echarts.init = function(dom, theme, opts) {
    const chart = originalEChartsInit.call(this, dom, theme, opts);
    // 保存图表实例到全局映射中
    if (dom && dom.id) {
        chartInstances[dom.id] = chart;
    }
    return chart;
};
</script>
{% endblock %}
