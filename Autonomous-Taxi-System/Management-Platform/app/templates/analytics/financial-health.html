{% extends "analytics/index.html" %}

{% block content_area %}
<!-- CSS样式 -->
<style>
    .card-header {
        position: relative;
    }
    .chart-info-tooltip {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 0 0 10px 10px;
        font-size: 14px;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        line-height: 1.5;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        max-height: 300px;
        overflow-y: auto;
    }
    .card-header:hover .chart-info-tooltip {
        opacity: 1;
        visibility: visible;
    }
    
    /* 图表操作按钮样式 */
    .chart-actions .btn {
        padding: 0.25rem 0.5rem;
        margin-left: 5px;
    }
    
    .chart-actions .btn i {
        font-size: 0.9rem;
    }
    
    /* 图表加载效果 */
    .chart-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 10;
        border-radius: 0 0 15px 15px;
    }
    
    /* 加载中效果动画 */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 卡片内容样式 */
    .card-body {
        position: relative;
    }
    
    /* 按钮悬停效果 */
    .chart-actions .btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        transition: all 0.2s;
    }
    
    /* 按钮激活效果 */
    .chart-actions .btn:active {
        transform: translateY(1px);
    }
</style>
<!-- 财务和整体健康指标卡片 -->
<div class="category-title">{{ _("财务和整体健康") }}</div>
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon bg-danger">
                    <i class="bi bi-percent"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ operating_profit_margin }}%</div>
                    <div class="metric-label">运营利润率</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所选时间段内，(总收入-总支出) ÷ 总收入 × 100%（%）
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon" style="background-color: #6610f2;">
                    <i class="bi bi-calendar-date"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ vehicle_roi_period }}</div>
                    <div class="metric-label">平均车辆投资回报期</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：车辆支出总额 ÷ 所选时间段内的日均收入（天）
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon" style="background-color: #1f9bcf;">
                    <i class="bi bi-calendar-month"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ fleet_average_age }}</div>
                    <div class="metric-label">车队平均车龄</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：所有车辆的平均服役时间（月）
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-card-content">
                <div class="metric-icon" style="background-color: #d9534f;">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="metric-info">
                    <div class="metric-value">{{ system_warning_rate }}</div>
                    <div class="metric-label">系统预警率</div>
                </div>
            </div>
            <div class="metric-tooltip">
                计算公式：系统预警数 ÷ 天数（个/天）
            </div>
        </div>
    </div>
</div>

<!-- 第一行：实时收支动态平衡仪表盘 (一行一个) -->
<div class="row mb-4">
    <div class="col-md-12 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,150,255,0.3); box-shadow: 0 0 15px rgba(0,100,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,60,125,0.8), rgba(45,120,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-speedometer2 me-2"></i>实时收支动态平衡仪表盘</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="finance-balance-gauge" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="finance-balance-gauge" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> income 表的 amount 总和，expense 表的 amount 总和（按日/周/月聚合）</p>
                    <p><strong>分析目的:</strong> 实时（或准实时）展示当前周期的净利润/亏损状态，提供最直观的财务健康快照。</p>
                    <p><strong>图表说明:</strong> 使用动态仪表盘(Gauge Chart)或水平平衡条，指针或平衡条动态变化，比静态数字卡片更具视觉冲击力。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="finance-balance-gaugeLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="finance-balance-gauge" class="chart-container" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 第二行：成本结构桑基图 (一行一个) -->
<div class="row mb-4">
    <div class="col-md-12 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,150,100,0.3); box-shadow: 0 0 15px rgba(255,100,0,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(125,60,25,0.8), rgba(255,120,45,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-diagram-3 me-2"></i>成本结构桑基图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="cost-structure-sankey" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="cost-structure-sankey" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> expense 表的 amount 和 type</p>
                    <p><strong>分析目的:</strong> 极佳地可视化成本的流向和构成，直观展示各项主要支出类别的占比和流向。</p>
                    <p><strong>图表说明:</strong> 使用桑基图(Sankey Diagram)展示从"总支出"到"支出类型"的流动分布，比饼图更能体现层级流动关系。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="cost-structure-sankeyLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="cost-structure-sankey" class="chart-container" style="height: 450px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 第三行：关键财务指标预测趋势图 (一行一个) -->
<div class="row mb-4">
    <div class="col-md-12 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,200,100,0.3); box-shadow: 0 0 15px rgba(0,200,100,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,100,25,0.8), rgba(45,200,45,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-graph-up-arrow me-2"></i>关键财务指标预测趋势图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="financial-metrics-forecast" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="financial-metrics-forecast" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 历史（日/周/月）总收入、总支出、净利润数据（来自 income, expense）</p>
                    <p><strong>分析目的:</strong> 提供前瞻性视角，预测短期财务走向，辅助财务决策。</p>
                    <p><strong>图表说明:</strong> 折线图(Line Chart)加入预测线，应用简单预测模型（如移动平均、线性回归），增加了图表的科技感和决策支持价值。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="financial-metrics-forecastLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="financial-metrics-forecast" class="chart-container" style="height: 420px;"></div>
            </div>
        </div>
    </div>
</div>


<!-- 第五行：城市收入雷达图 和 用户信用分vs.人均贡献收入气泡图 (一行两个) -->
<div class="row mb-4">
    <!-- 城市收入雷达图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(150,100,200,0.3); box-shadow: 0 0 15px rgba(100,0,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(75,25,125,0.8), rgba(150,85,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-radioactive me-2"></i>城市收入雷达图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="city-financial-radar" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="city-financial-radar" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 按 orders.city_code 分组，计算各城市关键财务指标</p>
                    <p><strong>分析目的:</strong> 在一个视图中清晰对比不同运营城市的综合财务表现，识别优势和劣势区域。</p>
                    <p><strong>图表说明:</strong> 雷达图(Radar Chart)适合多维度指标对比，可同时展示总收入、平均订单价值、利润率等多个维度。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="city-financial-radarLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="city-financial-radar" class="chart-container" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 用户信用分vs.人均贡献收入气泡图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(200,100,150,0.3); box-shadow: 0 0 15px rgba(255,0,150,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(125,25,75,0.8), rgba(255,85,145,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-droplet-half me-2"></i>用户信用分vs.人均贡献收入气泡图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="credit-income-bubble" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="credit-income-bubble" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> X轴: users.credit_score；Y轴: 人均收入；气泡大小: 该信用分/收入组合的用户数量</p>
                    <p><strong>分析目的:</strong> 探索用户信用与其为平台创造收入能力之间的关系，发现高价值用户特征。</p>
                    <p><strong>图表说明:</strong> 气泡图(Bubble Chart)用气泡大小表示用户密度，展现三维数据关系，更显层次感。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="credit-income-bubbleLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="credit-income-bubble" class="chart-container" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 第五行：车辆资产回报K线图/箱线图 和 优惠券套餐销售贡献旭日图 (一行两个) -->
<div class="row mb-4">
    <!-- 车辆资产回报K线图/箱线图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(100,200,255,0.3); box-shadow: 0 0 15px rgba(0,150,255,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(25,75,125,0.8), rgba(45,165,255,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-bar-chart me-2"></i>车辆资产回报箱线图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="vehicle-roi-boxplot" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="vehicle-roi-boxplot" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> 按车型(vehicles.model)分组计算累计收入和购置成本</p>
                    <p><strong>分析目的:</strong> 评估不同车型资产的投资回报情况和风险，辅助车辆采购决策。</p>
                    <p><strong>图表说明:</strong> 箱线图(Box Plot)展示某车型车辆累计收入的分布情况（中位数、四分位数等）与购置成本的对比，比简单的散点图更能揭示数据的分布和波动。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="vehicle-roi-boxplotLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="vehicle-roi-boxplot" class="chart-container" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 优惠券套餐销售贡献旭日图 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" style="border-radius:15px; border: 1px solid rgba(255,200,100,0.3); box-shadow: 0 0 15px rgba(255,150,0,0.1);">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(125,85,25,0.8), rgba(255,175,45,0.5)); border-bottom: none; border-radius: 15px 15px 0 0;">
                <h5 class="card-title mb-0 text-white"><i class="bi bi-sun me-2"></i>优惠券套餐销售贡献旭日图</h5>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-light refresh-chart" data-chart="coupon-package-sunburst" data-bs-toggle="tooltip" title="{{ _("刷新数据") }}">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light download-chart" data-chart="coupon-package-sunburst" data-bs-toggle="tooltip" title="{{ _("下载图表") }}">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="chart-info-tooltip">
                    <p><strong>数据来源:</strong> coupon_packages表，外环按套餐(name)展示，内环按优惠券类型展示</p>
                    <p><strong>分析目的:</strong> 多层级地展示不同优惠券套餐的销售额贡献及其内部构成，优化营销策略。</p>
                    <p><strong>图表说明:</strong> 旭日图(Sunburst Chart)视觉效果现代且信息密度高，可按层级展示套餐和内部优惠券类型构成。</p>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-loading" id="coupon-package-sunburstLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("加载中...") }}</span>
                    </div>
                </div>
                <div id="coupon-package-sunburst" class="chart-container" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入ECharts库 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- 引入图表JS文件 -->
<script src="{{ url_for('static', filename='js/financial_health_charts.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 确保财务和整体健康标签页为活跃状态
    const tabLinks = document.querySelectorAll('#analytics-tab .nav-link');
    tabLinks.forEach(link => link.classList.remove('active'));
    const financeHealthTab = document.getElementById('finance-health-tab');
    if(financeHealthTab) {
        financeHealthTab.classList.add('active');
    }
    
    // 设置日期范围选择器表单提交目标
    const dateForm = document.getElementById('date-range-form');
    if(dateForm) {
        // 更新表单提交目标，确保提交到当前页面
        dateForm.action = '{{ url_for("analytics.finance_health") }}';
        
        // 表单提交前处理
        dateForm.addEventListener('submit', function(e) {
            // 标记日期范围来源
            localStorage.setItem('last_date_filter_page', 'finance-health');
        });
        
        // 确保日期范围选择器事件正常工作
        const dateRangeSelect = document.getElementById('date-range');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        if(dateRangeSelect) {
            // 设置日期范围下拉框的初始值
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('date_range')) {
                dateRangeSelect.value = urlParams.get('date_range');
            }
            
            // 日期范围选择变化时更新日期输入框
            dateRangeSelect.addEventListener('change', function() {
                const today = new Date();
                let startDate = new Date(today);
                
                switch(this.value) {
                    case 'last_3_days':
                        startDate.setDate(today.getDate() - 3);
                        break;
                    case 'last_7_days':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'last_30_days':
                        startDate.setDate(today.getDate() - 30);
                        break;
                    case 'last_90_days':
                        startDate.setDate(today.getDate() - 90);
                        break;
                    case 'last_180_days':
                        startDate.setDate(today.getDate() - 180);
                        break;
                    case 'custom':
                        // 自定义模式下不修改日期
                        return;
                }
                
                endDateInput.value = today.toISOString().split('T')[0];
                startDateInput.value = startDate.toISOString().split('T')[0];
            });
        }
    }
});
</script>
{% endblock %}