<!--index.wxml-->
<navigation-bar title="æ— äººé©¾é©¶å‡ºç§Ÿè½¦å¹³å°" back="{{false}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- ç”¨æˆ·å›¾æ ‡ -->
    <user-icon userInfo="{{userInfo}}" bindtoggle="toggleSidebar"></user-icon>
    
    <!-- ä¾§è¾¹æ  -->
    <sidebar 
      show="{{showSidebar}}" 
      userInfo="{{userInfo}}" 
      isLogged="{{isLogged}}" 
      bindclose="closeSidebar">
    </sidebar>
    
    <!-- åŸå¸‚é€‰æ‹©å™¨ - ä½¿ç”¨æ›´å°çš„æ ·å¼ -->
    <view class="city-selector-mini">
      <picker bindchange="cityChange" value="{{cityIndex}}" range="{{cities}}">
        <view class="picker-mini">
          {{cities[cityIndex]}}
        </view>
      </picker>
    </view>
    
    <!-- è½¦è¾†ä½ç½®åˆ·æ–°æŒ‰é’® - ç§»åŠ¨åˆ°åŸå¸‚é€‰æ‹©å™¨ä¸‹æ–¹ -->
    <view class="vehicle-refresh-btn-below-city" wx:if="{{isLogged && !showVehicleDetail && !showOrderConfirm}}" bindtap="refreshVehicleLocation">
      <text class="refresh-icon">ğŸ”„</text>
      <text class="refresh-text">åˆ·æ–°è½¦è¾†</text>
    </view>
    
    <!-- è½¦è¾†ä¿¡æ¯æŒ‰é’® - ä½äºåˆ·æ–°è½¦è¾†æŒ‰é’®ä¸‹æ–¹ -->
    <view class="vehicle-info-btn-below-refresh" wx:if="{{isLogged && vehicleLocation && !showVehicleDetail && !showOrderConfirm}}" bindtap="showVehicleDetail">
      <text class="info-icon">ğŸš—</text>
      <text class="info-text">è½¦è¾†ä¿¡æ¯</text>
    </view>
    
    <!-- é«˜å¾·åœ°å›¾ç»„ä»¶ - ç°åœ¨å æ®æ›´å¤šç©ºé—´ -->
    <view class="map-container-large">
      <map id="myMap"
           class="map"
           longitude="{{longitude}}"
           latitude="{{latitude}}"
           scale="{{scale}}"
           markers="{{markers}}"
           polygons="{{polygons}}"
           show-location="true"
           bindtap="onMapTap">
      </map>
      
      <!-- èµ·ç‚¹ç»ˆç‚¹ä¿¡æ¯æ˜¾ç¤º -->
      <view class="route-info" wx:if="{{(startPoint || endPoint) && !showVehicleDetail && !showOrderConfirm}}">
        <view class="point-info" wx:if="{{startPoint}}">
          <text class="point-label">èµ·ç‚¹:</text>
          <text class="point-addr">{{startPoint.address || 'å·²é€‰æ‹©'}}</text>
        </view>
        <view class="point-info" wx:if="{{endPoint}}">
          <text class="point-label">ç»ˆç‚¹:</text>
          <text class="point-addr">{{endPoint.address || 'å·²é€‰æ‹©'}}</text>
        </view>
      </view>
      
      <!-- ç‚¹å‡»åœ°å›¾å¼¹å‡ºçš„çª—å£ - æ”¹ä¸ºå›ºå®šåœ¨åœ°å›¾ä¸­å¿ƒ -->
      <view class="map-popup-center" wx:if="{{showPopup}}">
        <view class="popup-content">
          <view class="popup-header">
            <text class="popup-title">é€‰æ‹©æ“ä½œ</text>
            <button class="popup-close-btn" bindtap="closePopup">âœ•</button>
          </view>
          <view class="popup-buttons">
            <button class="popup-btn" bindtap="setAsStart" wx:if="{{!hasSetStart}}">è®¾ä¸ºèµ·ç‚¹</button>
            <button class="popup-btn" bindtap="setAsEnd" wx:if="{{hasSetStart && !hasSetEnd}}">è®¾ä¸ºç»ˆç‚¹</button>
            <button class="popup-btn reset-btn" bindtap="resetPoints" wx:if="{{hasSetStart || hasSetEnd}}">é‡ç½®</button>
          </view>
        </view>
      </view>
      
      <!-- è½¦è¾†è¯¦æƒ…å¼¹çª— -->
      <view class="vehicle-detail-popup" wx:if="{{showVehicleDetail && selectedVehicle}}">
        <view class="vehicle-detail-content">
          <view class="vehicle-detail-header">
            <text class="vehicle-detail-title">è½¦è¾†è¯¦æƒ…</text>
            <button class="popup-close-btn" bindtap="closeVehicleDetail">âœ•</button>
          </view>
          <view class="vehicle-detail-body">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <view class="detail-section">
              <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
              <view class="detail-item">
                <text class="detail-label">è½¦ç‰Œå·:</text>
                <text class="detail-value">{{selectedVehicle.plateNumber}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">è½¦å‹:</text>
                <text class="detail-value">{{selectedVehicle.model}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">å½“å‰çŠ¶æ€:</text>
                <text class="detail-value status-{{selectedVehicle.currentStatus === 'è¿è¡Œä¸­' ? 'running' : selectedVehicle.currentStatus === 'ç©ºé—²ä¸­' ? 'idle' : selectedVehicle.currentStatus === 'å……ç”µä¸­' ? 'charging' : selectedVehicle.currentStatus === 'ç»´æŠ¤ä¸­' ? 'maintenance' : ''}}">{{selectedVehicle.currentStatus}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">ç”µæ± ç”µé‡:</text>
                <text class="detail-value battery-{{selectedVehicle.batteryLevel >= 80 ? 'high' : selectedVehicle.batteryLevel >= 50 ? 'medium' : 'low'}}">{{selectedVehicle.batteryLevel}}%</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">è½¦è¾†è¯„åˆ†:</text>
                <text class="detail-value">{{selectedVehicle.rating === -1 ? 'å°šæ— è¯„ä»·' : selectedVehicle.rating + 'â­'}}</text>
              </view>
            </view>

            <!-- ä½ç½®ä¿¡æ¯ -->
            <view class="detail-section">
              <view class="section-title">ä½ç½®ä¿¡æ¯</view>
              <view class="detail-item">
               
            
              </view>
              <view class="detail-item">
                <text class="detail-label">æ‰€åœ¨åŸå¸‚:</text>
                <text class="detail-value">{{selectedVehicle.location.city}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">åæ ‡:</text>
                <text class="detail-value">{{selectedVehicle.location.systemX}}, {{selectedVehicle.location.systemY}}</text>
              </view>
            </view>

            <!-- è®¢å•ä¿¡æ¯ -->
            <view class="detail-section" wx:if="{{selectedVehicle.orderInfo}}">
              <view class="section-title">å½“å‰è®¢å•</view>
              <view class="detail-item">
                <text class="detail-label">è®¢å•å·:</text>
                <text class="detail-value">{{selectedVehicle.orderInfo.orderNumber}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">è®¢å•çŠ¶æ€:</text>
                <text class="detail-value">{{selectedVehicle.orderInfo.orderStatus}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">åˆ›å»ºæ—¶é—´:</text>
                <text class="detail-value">{{selectedVehicle.orderInfo.createTime}}</text>
              </view>
              <view class="detail-item" wx:if="{{selectedVehicle.orderInfo.arrivalTime}}">
                <text class="detail-label">åˆ°è¾¾æ—¶é—´:</text>
                <text class="detail-value">{{selectedVehicle.orderInfo.arrivalTime}}</text>
              </view>
              <view class="detail-item">
               
            
                <text class="detail-label">ä¸Šè½¦åæ ‡:</text>
                <text class="detail-value">{{selectedVehicle.orderInfo.pickupLocationX}}, {{selectedVehicle.orderInfo.pickupLocationY}}</text>
              </view>
              <view class="detail-item">
             
             
                <text class="detail-label">ä¸‹è½¦åæ ‡:</text>
                <text class="detail-value">{{selectedVehicle.orderInfo.dropoffLocationX}}, {{selectedVehicle.orderInfo.dropoffLocationY}}</text>
              </view>
            </view>

            <!-- æ›´æ–°æ—¶é—´ -->
            <view class="detail-section">
              <view class="detail-item">
                <text class="detail-label">æœ€åæ›´æ–°:</text>
                <text class="detail-value">{{selectedVehicle.lastUpdate}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è®¢å•ç¡®è®¤å¼¹çª— -->
      <view class="order-confirm-popup" wx:if="{{showOrderConfirm && orderConfirmData}}">
        <view class="order-confirm-content">
          <view class="order-confirm-header">
            <text class="order-confirm-title">ç¡®è®¤è®¢å•</text>
            <button class="popup-close-btn" bindtap="closeOrderConfirm">âœ•</button>
          </view>
          <view class="order-confirm-body">
            <!-- è·¯çº¿ä¿¡æ¯ -->
            <view class="detail-section">
              <view class="section-title">ğŸ“ è·¯çº¿ä¿¡æ¯</view>
              <view class="detail-item">
                <text class="detail-label">èµ·ç‚¹åæ ‡:</text>
                <text class="detail-value">({{orderConfirmData.pickupSystemCoords.x}}, {{orderConfirmData.pickupSystemCoords.y}})</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">ç»ˆç‚¹åæ ‡:</text>
                <text class="detail-value">({{orderConfirmData.dropoffSystemCoords.x}}, {{orderConfirmData.dropoffSystemCoords.y}})</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">è¡Œç¨‹è·ç¦»:</text>
                <text class="detail-value" wx:if="{{orderConfirmData.priceEstimate}}">{{orderConfirmData.priceEstimate.distance}}å…¬é‡Œ</text>
                <text class="detail-value" wx:else>{{orderConfirmData.distance}}å…¬é‡Œ</text>
              </view>
            </view>

            <!-- ä»·æ ¼ä¿¡æ¯ -->
            <view class="detail-section">
              <view class="section-title">ğŸ’° ä»·æ ¼æ„æˆ</view>
              <view wx:if="{{orderConfirmData.priceEstimate}}">
                <view class="detail-item">
                  <text class="detail-label">èµ·æ­¥è·ç¦»:</text>
                  <text class="detail-value">{{orderConfirmData.priceEstimate.base_distance}}å…¬é‡Œ</text>
                </view>
                <view class="detail-item">
                  <text class="detail-label">èµ·æ­¥ä»·:</text>
                  <text class="detail-value">Â¥{{orderConfirmData.priceEstimate.adjusted_base_price}}</text>
                </view>
                <view class="detail-item">
                  <text class="detail-label">è¶…å‡ºéƒ¨åˆ†:</text>
                  <text class="detail-value">Â¥{{orderConfirmData.priceEstimate.adjusted_price_per_km}}/å…¬é‡Œ</text>
                </view>
                <view class="detail-item price-highlight">
                  <text class="detail-label">é¢„è®¡ä»·æ ¼:</text>
                  <text class="detail-value price-range">{{orderConfirmData.priceEstimate.price_range}}</text>
                </view>
              </view>
              <view wx:else>
                <view class="detail-item">
                  <text class="detail-label">èµ·æ­¥ä»·:</text>
                  <text class="detail-value">Â¥{{orderConfirmData.basePrice}}</text>
                </view>
                <view class="detail-item">
                  <text class="detail-label">é‡Œç¨‹è´¹:</text>
                  <text class="detail-value">Â¥{{orderConfirmData.distancePrice}}</text>
                </view>
                <view class="detail-item price-highlight">
                  <text class="detail-label">æ€»è®¡:</text>
                  <text class="detail-value price-range">Â¥{{orderConfirmData.totalPrice}}</text>
                </view>
              </view>
            </view>

            <!-- ä»·æ ¼è¯´æ˜ -->
            <view class="detail-section">
              <view class="section-title">ğŸ’¡ ä»·æ ¼è¯´æ˜</view>
              <view class="price-explanation">
                <view wx:if="{{orderConfirmData.priceEstimate}}">
                  <text class="explanation-text">â€¢ å‰{{orderConfirmData.priceEstimate.base_distance}}å…¬é‡ŒæŒ‰èµ·æ­¥ä»·Â¥{{orderConfirmData.priceEstimate.adjusted_base_price}}è®¡è´¹</text>
                  <text class="explanation-text">â€¢ è¶…å‡º{{orderConfirmData.priceEstimate.base_distance}}å…¬é‡Œéƒ¨åˆ†æŒ‰Â¥{{orderConfirmData.priceEstimate.adjusted_price_per_km}}/å…¬é‡Œè®¡è´¹</text>
                  <text class="explanation-text">â€¢ ä¸åŒè½¦å‹ä»·æ ¼ä¸åŒï¼Œç»æµå‹è½¦è¾†ä»·æ ¼è¾ƒä½ï¼Œè±ªåå‹è½¦è¾†ä»·æ ¼è¾ƒé«˜</text>
                  <text class="explanation-text">â€¢ ç³»ç»Ÿå°†ä¸ºæ‚¨åŒ¹é…æœ€ä¼˜è½¦è¾†ï¼Œæœ€ç»ˆä»·æ ¼ä»¥å®é™…ä¹˜åè½¦å‹ä¸ºå‡†</text>
                </view>
                <view wx:else>
                  <text class="explanation-text">â€¢ æ­¤ä¸ºåŸºç¡€ä»·æ ¼ä¼°ç®—</text>
                  <text class="explanation-text">â€¢ å®é™…ä»·æ ¼å¯èƒ½å› è½¦å‹å’ŒåŸå¸‚ç³»æ•°æœ‰æ‰€è°ƒæ•´</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="order-confirm-footer">
            <button class="unified-btn" style="flex: 1; margin-right: 16rpx;" bindtap="closeOrderConfirm">å–æ¶ˆ</button>
            <button class="unified-btn success" style="flex: 2;" bindtap="confirmOrder">ç¡®è®¤ä¸‹å•</button>
          </view>
        </view>
      </view>
      
      <!-- å‘èµ·è®¢å•æŒ‰é’® -->
      <view class="order-btn-container">
        <button class="unified-btn {{hasSetStart && hasSetEnd ? '' : 'disabled'}}" 
                bindtap="createOrder" 
                disabled="{{!(hasSetStart && hasSetEnd)}}">
          å‘èµ·è®¢å•
        </button>
      </view>
    </view>
    
    <view class="usermotto">
      <text class="user-motto">{{motto}}</text>
    </view>
  </view>
</scroll-view>
