<navigation-bar title="æ™ºèƒ½å®¢æœ" back="{{true}}" color="black" background="#FFF"></navigation-bar>
<view class="container">
  <!-- å†å²è®°å½•ç­›é€‰åŒºåŸŸ -->
  <view class="header-toolbar">
    <view class="date-filter">
      <picker mode="date" value="{{selectedDate}}" bindchange="onDateChange">
        <view class="date-picker">
          <text class="btn-icon">ğŸ“…</text>
          <text class="btn-text">{{selectedDate || 'é€‰æ‹©æ—¥æœŸæŸ¥çœ‹å†å²'}}</text>
        </view>
      </picker>
      <button class="clear-filter" bindtap="clearDateFilter" wx:if="{{selectedDate}}">
        <text>æ¸…é™¤æ—¥æœŸç­›é€‰</text>
      </button>
    </view>
  </view>
  
  <!-- å¯ç”¨æ—¥æœŸæç¤º -->
  <view class="available-dates" wx:if="{{availableDates.length > 0 && showAvailableDates}}">
    <text class="label">æœ‰å¯¹è¯è®°å½•çš„æ—¥æœŸï¼š</text>
    <scroll-view class="dates-scroll" scroll-x>
      <view class="date-item {{item === selectedDate ? 'active' : ''}}" 
            wx:for="{{availableDates}}" 
            wx:key="*this"
            bindtap="selectDate"
            data-date="{{item}}">
        {{item}}
      </view>
    </scroll-view>
  </view>
  <scroll-view class="chat-messages" scroll-y="true" scroll-top="{{scrollTop}}" scroll-into-view="{{toView}}" enhanced="true" show-scrollbar="true" bounces="true">
    <!-- å†å²æ¨¡å¼ä¸‹æ˜¾ç¤ºæ—¥æœŸæ ‡é¢˜ -->
    <view class="date-header" wx:if="{{isHistoryMode && selectedDate}}">
      <text class="date-title">{{selectedDate}} çš„å¯¹è¯è®°å½•</text>
    </view>
    
    <!-- åŠ è½½ä¸­æç¤º -->
    <view class="loading-indicator" wx:if="{{historyLoading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½å†å²è®°å½•ä¸­...</text>
    </view>
    
    <view class="message-list">
      <view wx:for="{{messages}}" wx:key="id" class="message-item {{item.role === 'user' ? 'user' : 'assistant'}}" id="msg{{item.id}}">
        <view class="message-avatar">
          <image 
            src="{{item.role === 'user' ? userAvatar : robotAvatar}}" 
            class="avatar"
            mode="aspectFill"
            binderror="onAvatarError"
            data-role="{{item.role}}"
            wx:if="{{item.role === 'user' ? showUserImage : showRobotImage}}"
          ></image>
          <view class="robot-icon" wx:if="{{item.role === 'assistant' && !showRobotImage}}">ğŸ¤–</view>
          <view class="user-icon" wx:if="{{item.role === 'user' && !showUserImage}}">ğŸ‘¤</view>
        </view>
        <view class="message-content">
          <view class="message-bubble">
            <text class="message-text">{{item.content}}</text>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
      </view>
      <view wx:if="{{isTyping}}" class="message-item assistant">
        <view class="message-avatar">
          <image 
            src="{{robotAvatar}}" 
            class="avatar"
            mode="aspectFill"
            wx:if="{{showRobotImage}}"
          ></image>
          <view class="robot-icon" wx:if="{{!showRobotImage}}">ğŸ¤–</view>
        </view>
        <view class="message-content">
          <view class="message-bubble typing">
            <view class="typing-indicator">
              <view class="dot"></view>
              <view class="dot"></view>
              <view class="dot"></view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
  
  <view class="quick-questions" wx:if="{{showQuickQuestions && !isHistoryMode}}">
    <text class="quick-title">å¸¸è§é—®é¢˜</text>
    <view class="question-list">
      <view wx:for="{{quickQuestions}}" wx:key="index" class="question-item" bindtap="sendQuickQuestion" data-question="{{item}}">
        <text>{{item}}</text>
      </view>
    </view>
  </view>
  
  <view class="chat-input">
    <view class="input-container">
      <input class="input-field" placeholder="{{isHistoryMode ? 'å†å²è®°å½•æŸ¥çœ‹æ¨¡å¼' : 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...'}}" value="{{inputText}}" bindinput="onInput" confirm-type="send" bindconfirm="sendMessage" disabled="{{isHistoryMode}}" />
      <button class="send-btn {{inputText ? 'active' : ''}}" bindtap="sendMessage" disabled="{{!inputText || isSending || isHistoryMode}}">
        <text wx:if="{{!isSending}}">å‘é€</text>
        <text wx:else>...</text>
      </button>
    </view>
  </view>
</view> 