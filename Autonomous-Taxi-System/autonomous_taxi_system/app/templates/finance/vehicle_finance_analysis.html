{% extends "finance/analysis_base.html" %}

{% block analysis_content %}

                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    此页面将包含车辆收入排行、车辆维护成本与收入关系等图表。目前为功能预留页面。
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">车辆收入排行</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <canvas id="vehicleIncomeRankChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">车辆维护成本与收入关系</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <div id="maintenanceCostIncomeChart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">车辆单位里程收益对比</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <div id="unitDistanceRevenueChart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">车辆投资回报率</div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <canvas id="vehicleROIChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
      
{% endblock %}

{% block analysis_scripts %}
<script>
    // 车辆财务分析页面的图表初始化代码
    document.addEventListener('DOMContentLoaded', function() {
        // 检查所需的库是否加载
        function checkAndLoadLibraries() {
            // 定义需要加载的库和它们的URL
            const requiredLibraries = [
                { name: 'Chart', globalVar: 'Chart', url: 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js' },
                { name: 'ECharts', globalVar: 'echarts', url: 'https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js' }
            ];
            
            let allLoaded = true;
            let loadingPromises = [];
            
            // 检查每个库
            for (const lib of requiredLibraries) {
                if (typeof window[lib.globalVar] === 'undefined') {
                    allLoaded = false;
                    console.error(`${lib.name}未能加载，尝试重新加载`);
                    
                    // 创建加载Promise
                    const loadPromise = new Promise((resolve, reject) => {
                        const scriptElement = document.createElement('script');
                        scriptElement.src = lib.url;
                        scriptElement.onload = () => {
                            console.log(`${lib.name}加载成功`);
                            resolve();
                        };
                        scriptElement.onerror = () => {
                            console.error(`${lib.name}加载失败`);
                            reject(new Error(`Failed to load ${lib.name}`));
                        };
                        document.head.appendChild(scriptElement);
                    });
                    
                    loadingPromises.push(loadPromise);
                }
            }
            
            // 如果所有库都已加载，直接初始化图表
            if (allLoaded) {
                initCharts();
                return;
            }
            
            // 否则等待所有库加载完成后再初始化
            Promise.all(loadingPromises)
                .then(() => {
                    console.log('所有图表库加载完成，开始初始化图表');
                    initCharts();
                })
                .catch(error => {
                    console.error('图表库加载失败:', error);
                    alert('图表库加载失败，请刷新页面重试');
                });
        }
        
        // 初始化所有图表
        function initCharts() {
            // 初始化Chart.js图表
            initChartJsGraphs();
            // 初始化ECharts图表
            initEChartsGraphs();
        }
        
        // 初始化Chart.js图表
        function initChartJsGraphs() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js未加载，无法初始化Chart.js图表');
                return;
            }
            
            // 车辆收入排行
            const incomeRankChart = document.getElementById('vehicleIncomeRankChart');
            if (incomeRankChart) {
                const incomeRankCtx = incomeRankChart.getContext('2d');
                new Chart(incomeRankCtx, {
                    type: 'bar',
                    data: {
                        labels: ['车辆1', '车辆2', '车辆3', '车辆4', '车辆5'],
                        datasets: [{
                            label: '月收入(元)',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(0, 123, 255, 0.7)',
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '车辆收入排行榜 - 功能开发中'
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // 车辆投资回报率
            const roiChart = document.getElementById('vehicleROIChart');
            if (roiChart) {
                const roiCtx = roiChart.getContext('2d');
                new Chart(roiCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '投资回报率(%)',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: 'rgba(40, 167, 69, 0.8)',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '车辆投资回报率趋势 - 功能开发中'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '回报率(%)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化ECharts图表
        function initEChartsGraphs() {
            if (typeof echarts === 'undefined') {
                console.error('ECharts未加载，无法初始化ECharts图表');
                return;
            }
            
            // 车辆维护成本与收入关系散点图
            const costIncomeChart = document.getElementById('maintenanceCostIncomeChart');
            if (costIncomeChart) {
                const chart = echarts.init(costIncomeChart);
                const option = {
                    title: {
                        text: '车辆维护成本与收入关系 - 功能开发中',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        },
                        formatter: function(params) {
                            return '维护成本: ' + params[0].value[0] + '元<br/>' + 
                                  '月收入: ' + params[0].value[1] + '元<br/>' + 
                                  '车辆ID: ' + params[0].value[2];
                        }
                    },
                    xAxis: {
                        name: '维护成本(元)',
                        nameLocation: 'middle',
                        nameGap: 30,
                        type: 'value',
                        scale: true
                    },
                    yAxis: {
                        name: '月收入(元)',
                        nameLocation: 'middle',
                        nameGap: 40,
                        type: 'value',
                        scale: true
                    },
                    series: [{
                        type: 'scatter',
                        // 示例数据: [维护成本, 月收入, 车辆ID]
                        data: [[1000, 5000, 1], [2000, 7000, 2], [1500, 6000, 3]],
                        symbolSize: 15,
                        itemStyle: {
                            color: function(params) {
                                // 实际实现时可基于盈利情况设置不同颜色
                                return 'rgba(0, 123, 255, 0.7)';
                            }
                        }
                    }]
                };
                chart.setOption(option);
                
                // 响应窗口大小变化
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
            
            // 车辆单位里程收益对比箱线图
            const unitRevenueChart = document.getElementById('unitDistanceRevenueChart');
            if (unitRevenueChart) {
                const chart = echarts.init(unitRevenueChart);
                const option = {
                    title: {
                        text: '车辆单位里程收益对比 - 功能开发中',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            return params.name + ': ' + params.value.toFixed(2) + '元/公里';
                        }
                    },
                    grid: {
                        left: '10%',
                        right: '10%',
                        bottom: '15%'
                    },
                    xAxis: {
                        type: 'category',
                        data: ['车型A', '车型B', '车型C', '车型D', '车型E']
                    },
                    yAxis: {
                        type: 'value',
                        name: '单位里程收益(元/公里)',
                        nameLocation: 'middle',
                        nameGap: 40
                    },
                    series: [{
                        name: '单位里程收益',
                        type: 'boxplot',
                        data: [
                            [1, 2, 3, 4, 5],
                            [1.2, 2.2, 3.2, 4.2, 5.2],
                            [1.3, 2.3, 3.3, 4.3, 5.3],
                            [1.4, 2.4, 3.4, 4.4, 5.4],
                            [1.5, 2.5, 3.5, 4.5, 5.5]
                        ],
                        itemStyle: {
                            color: 'rgba(40, 167, 69, 0.7)'
                        }
                    }]
                };
                chart.setOption(option);
                
                // 响应窗口大小变化
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
        }
        
        // 开始检查并加载库
        checkAndLoadLibraries();
    });
</script>
{% endblock %} 