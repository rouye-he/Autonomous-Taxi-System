{% extends "base.html" %}

{% block title %}首页仪表盘 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        transition: transform 0.3s;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .stat-card {
        text-align: center;
        padding: 20px;
    }
    .stat-card .icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: #007bff;
    }
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stat-card .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .stat-card .stat-change {
        font-size: 0.8rem;
    }
    .stat-card .stat-change.positive {
        color: #28a745;
    }
    .stat-card .stat-change.negative {
        color: #dc3545;
    }
    .stat-card .stat-empty-space {
        height: 24px;
        margin-top: 5px;
    }
    
    /* 图表悬停提示样式 */
    .card-header {
        position: relative;
    }
    .chart-info-tooltip {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 0 0 10px 10px;
        font-size: 14px;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        line-height: 1.5;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        max-height: 300px;
        overflow-y: auto;
    }
    .card-header:hover .chart-info-tooltip {
        opacity: 1;
        visibility: visible;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    /* 不同图表的卡片样式 */
    /* 每日平均订单金额 */
    .chart-order-amount {
        border: 1px solid rgba(100,150,255,0.3);
        box-shadow: 0 0 15px rgba(0,100,255,0.1);
        transition: all 0.3s ease;
    }
    .chart-order-amount:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .chart-order-amount .card-header {
        background: linear-gradient(135deg, rgba(25,60,125,0.8), rgba(45,120,255,0.5));
        color: white;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        transition: all 0.3s ease;
    }
    .chart-order-amount:hover .card-header {
        background: linear-gradient(135deg, rgba(25,60,125,0.9), rgba(45,120,255,0.7));
    }
    
    /* 平均每辆车每天完成的订单数 */
    .chart-orders-per-vehicle {
        border: 1px solid rgba(100,255,100,0.3);
        box-shadow: 0 0 15px rgba(0,100,255,0.1);
        transition: all 0.3s ease;
    }
    .chart-orders-per-vehicle:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .chart-orders-per-vehicle .card-header {
        background: linear-gradient(135deg, rgba(25,125,25,0.8), rgba(45,255,45,0.5));
        color: white;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        transition: all 0.3s ease;
    }
    .chart-orders-per-vehicle:hover .card-header {
        background: linear-gradient(135deg, rgba(25,125,25,0.9), rgba(45,255,45,0.7));
    }
    
    /* 按车型的收入与成本分析 */
    .chart-model-finance {
        border: 1px solid rgba(255,100,100,0.3);
        box-shadow: 0 0 15px rgba(0,100,255,0.1);
        transition: all 0.3s ease;
    }
    .chart-model-finance:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .chart-model-finance .card-header {
        background: linear-gradient(135deg, rgba(125,25,25,0.8), rgba(255,45,45,0.5));
        color: white;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        transition: all 0.3s ease;
    }
    .chart-model-finance:hover .card-header {
        background: linear-gradient(135deg, rgba(125,25,25,0.9), rgba(255,45,45,0.7));
    }
    
    .warning-item {
        padding: 10px;
        border-left: 4px solid #ffc107;
        background-color: #fff8e1;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    .warning-item.critical {
        border-left-color: #dc3545;
        background-color: #ffebee;
    }
    .warning-item .icon {
        margin-right: 10px;
        font-size: 1.2rem;
    }
    .shortcut-btn {
        margin-bottom: 10px;
        padding: 15px;
        text-align: center;
        border-radius: 10px;
        font-weight: 500;
        color: white;
    }
    .shortcut-btn i {
        display: block;
        font-size: 2rem;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-4">首页仪表盘</h2>
        </div>
    </div>

    <!-- 实时数据概览 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="icon"><i class="bi-taxi-front-fill"></i></div>
                <div class="stat-value">{{ stats.running_vehicles }}/{{ stats.total_vehicles }}</div>
                <div class="stat-label">运行车辆/总车辆</div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i> 
                    0% vs 昨日
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="icon"><i class="bi bi-journal-check"></i></div>
                <div class="stat-value">{{ stats.today_orders }}</div>
                <div class="stat-label">今日完成订单</div>
                <div class="stat-change {% if stats.today_orders_percent_change >= 0 %}positive{% else %}negative{% endif %}">
                    <i class="bi bi-arrow-{% if stats.today_orders_percent_change >= 0 %}up{% else %}down{% endif %}"></i> 
                    {{ stats.today_orders_percent_change|abs }}% vs 昨日
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="icon"><i class="bi bi-cash"></i></div>
                <div class="stat-value">¥{{ '{:,}'.format(stats.today_income|int) }}</div>
                <div class="stat-label">今日收入</div>
                <div class="stat-change {% if stats.today_income_percent_change >= 0 %}positive{% else %}negative{% endif %}">
                    <i class="bi bi-arrow-{% if stats.today_income_percent_change >= 0 %}up{% else %}down{% endif %}"></i> 
                    {{ stats.today_income_percent_change|abs }}% vs 昨日
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="icon"><i class="bi bi-people"></i></div>
                <div class="stat-value">{{ stats.active_users }}</div>
                <div class="stat-label">今日活跃用户</div>
                <div class="stat-change {% if stats.active_users_percent_change >= 0 %}positive{% else %}negative{% endif %}">
                    <i class="bi bi-arrow-{% if stats.active_users_percent_change >= 0 %}up{% else %}down{% endif %}"></i> 
                    {{ stats.active_users_percent_change|abs }}% vs 昨日
                </div>
            </div>
        </div>
    </div>

    <!-- 关键指标可视化 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card chart-order-amount">
                <div class="card-header">
                    <i class="bi bi-cash-coin me-1"></i> 每日平均订单金额 (最近7天)
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表中的amount字段平均值，按日分组</p>
                        <p><strong>分析目的:</strong> 了解每日订单价格趋势，判断用户消费水平变化</p>
                        <p><strong>图表说明:</strong> 折线图展示最近7天每日平均订单金额，帮助评估业务收入稳定性和增长趋势</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="orderAmountChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-orders-per-vehicle">
                <div class="card-header">
                    <i class="bi bi-taxi-front-fill me-1"></i> 平均每辆车每天完成的订单数 (最近7天)
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表和vehicles表关联统计，按日分组</p>
                        <p><strong>分析目的:</strong> 评估车辆利用效率，监控车辆周转率变化</p>
                        <p><strong>图表说明:</strong> 折线图展示每辆车平均每天完成的订单数量，反映资源利用效率和营运状况</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ordersPerVehicleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card chart-model-finance">
                <div class="card-header">
                    <i class="bi bi-bar-chart me-1"></i> 按车型的收入与成本分析
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表的amount字段（收入）和expenses表（支出）按车型分组统计</p>
                        <p><strong>分析目的:</strong> 比较不同车型的盈利能力，评估车队结构的经济效益</p>
                        <p><strong>图表说明:</strong> 柱状图展示各车型的收入和支出，折线图展示利润率，帮助优化车队配置决策</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="modelFinanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 预警信息和快捷操作 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-exclamation-triangle"></i> 预警信息
                </div>
                <div class="card-body">
                    {% if warnings %}
                        {% for warning in warnings %}
                        <div class="warning-item {% if warning.status == '未读' %}critical{% endif %}">
                            <i class="bi {% if warning.type == 'vehicle' %}bi-taxi-front-fill{% elif warning.type == 'order' %}bi-journal-check{% elif warning.type == 'system' %}bi-gear{% else %}bi-exclamation-triangle{% endif %} icon"></i>
                            <strong>{{ warning.title }}</strong> {{ warning.content }}
                            <div class="small text-muted mt-1">{{ warning.created_at }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="warning-item">
                            <i class="bi bi-info-circle icon"></i>
                            目前没有警告信息
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入Chart.js库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    // 每日平均订单金额图表
    const orderCtx = document.getElementById('orderAmountChart').getContext('2d');
    const orderAmountChart = new Chart(orderCtx, {
        type: 'line',
        data: {
            labels: {{ chart_data.avg_order_amount.labels|tojson }},
            datasets: [{
                label: '平均订单金额',
                data: {{ chart_data.avg_order_amount.data|tojson }},
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return '¥' + value;
                        }
                    }
                }
            }
        }
    });

    // 平均每辆车每天完成的订单数图表
    const vehicleCtx = document.getElementById('ordersPerVehicleChart').getContext('2d');
    const ordersPerVehicleChart = new Chart(vehicleCtx, {
        type: 'line',
        data: {
            labels: {{ chart_data.avg_orders_per_vehicle.labels|tojson }},
            datasets: [{
                label: '平均订单数/车',
                data: {{ chart_data.avg_orders_per_vehicle.data|tojson }},
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 1
                    }
                }
            }
        }
    });

    // 按车型的收入与成本分析图表
    const modelFinanceCtx = document.getElementById('modelFinanceChart').getContext('2d');
    const modelFinanceChart = new Chart(modelFinanceCtx, {
        type: 'bar',
        data: {
            labels: {{ model_finance.models|tojson }},
            datasets: [
                {
                    label: '收入',
                    data: {{ model_finance.income|tojson }},
                    backgroundColor: 'rgba(40, 167, 69, 0.7)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1,
                    order: 2
                },
                {
                    label: '支出',
                    data: {{ model_finance.expense|tojson }},
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1,
                    order: 2
                },
                {
                    type: 'line',
                    label: '利润率(%)',
                    data: {{ model_finance.profit_rate|tojson }},
                    borderColor: 'rgba(255, 193, 7, 1)',
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(255, 193, 7, 1)',
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1',
                    order: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const index = context[0].dataIndex;
                            const profitRate = {{ model_finance.profit_rate|tojson }}[index];
                            return `利润率: ${profitRate}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '金额 (元)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    beginAtZero: false,
                    position: 'right',
                    title: {
                        display: true,
                        text: '利润率 (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        stepSize: 10
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    // 显示欢迎消息
    document.addEventListener('DOMContentLoaded', function() {
        showToast('欢迎回到无人驾驶出租车管理平台', 'primary', 3000);
        
        // 一键分配按钮点击事件
        document.getElementById('quickAutoAssignBtn').addEventListener('click', function() {
            // 显示确认对话框
            if (!confirm('确定要为所有待分配订单自动分配最近的车辆吗？')) {
                return;
            }
            
            // 禁用按钮，防止重复点击
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 分配中...';
            
            // 显示加载提示
            showToast('正在为待分配订单分配车辆，请稍候...', 'info');
            
            // 调用API获取所有待分配订单ID
            fetch('/orders/api/get_waiting_order_ids', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    search_params: { 'order_status': '待分配' }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const orderIds = data.data.order_ids;
                    
                    // 如果没有待分配订单，提示用户
                    if (orderIds.length === 0) {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-lightning-charge"></i> 一键分配';
                        showToast('没有待分配的订单', 'warning');
                        return;
                    }
                    
                    // 显示找到的订单数量
                    showToast(`找到 ${orderIds.length} 个待分配订单，开始分配...`, 'info');
                    
                    // 调用API进行一键分配
                    return fetch('/orders/api/auto_assign_vehicles', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            order_ids: orderIds
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        // 恢复按钮状态
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-lightning-charge"></i> 一键分配';
                        
                        // 处理分配结果
                        if (result.status === 'success') {
                            const successful = result.data.successful;
                            const failed = result.data.failed;
                            
                            showToast(`分配完成！成功: ${successful.length} 个，失败: ${failed.length} 个`, 'success');
                        } else {
                            showToast(`一键分配失败: ${result.message}`, 'danger');
                        }
                    });
                } else {
                    throw new Error(data.message || '获取待分配订单失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // 恢复按钮状态
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-lightning-charge"></i> 一键分配';
                showToast(`操作失败: ${error.message || '未知错误'}`, 'danger');
            });
        });
    });
</script>
{% endblock %} 