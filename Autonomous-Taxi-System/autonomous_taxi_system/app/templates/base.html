<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}无人驾驶出租车管理平台{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 添加Font Awesome 5图标库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- 添加Socket.IO客户端库 -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        /* 全局表格居中样式 */
        .table th, .table td {
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            padding: 8px;
        }
        
        /* DataTables特定样式 */
        .dataTable th, .dataTable td {
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        /* 文本内容列保持左对齐 */
        .text-content, td.content-cell, td.description-cell, td.text-start {
            text-align: left !important;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
            background-color: #ffffff;
            width: 240px;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link {
            color: #495057;
            padding: 0.85rem 1.2rem;
            margin: 6px 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-weight: 500;
        }
        .sidebar .nav-link:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.03);
            border-left: 3px solid #dee2e6;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        /* 为菜单项设置不同颜色 - 模仿优惠券页面样式 */
        .nav-link[href*="dashboard"].active {
            border-left-color: #0d6efd !important;
            background-color: rgba(13, 110, 253, 0.1) !important;
            color: #0d6efd !important;
        }
        
        .nav-link[href*="vehicles"].active {
            border-left-color: #198754 !important;
            background-color: rgba(25, 135, 84, 0.1) !important;
            color: #198754 !important;
        }
        
        .nav-link[href*="orders"].active {
            border-left-color: #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
        }
        
        .nav-link[href*="notifications"].active {
            border-left-color: #ff9f1c !important;
            background-color: rgba(255, 159, 28, 0.1) !important;
            color: #ff9f1c !important;
        }
        
        .nav-link[href*="finance"].active {
            border-left-color: #6f42c1 !important;
            background-color: rgba(111, 66, 193, 0.1) !important;
            color: #6f42c1 !important;
        }
        
        .nav-link[href*="analytics"].active {
            border-left-color: #fd7e14 !important;
            background-color: rgba(253, 126, 20, 0.1) !important;
            color: #fd7e14 !important;
        }
        
        .nav-link[href*="coupons"].active {
            border-left-color: #20c997 !important;
            background-color: rgba(32, 201, 151, 0.1) !important;
            color: #20c997 !important;
        }
        
        .nav-link[href*="users"].active {
            border-left-color: #e83e8c !important;
            background-color: rgba(232, 62, 140, 0.1) !important;
            color: #e83e8c !important;
        }
        
        .nav-link[href*="settings"].active {
            border-left-color: #17a2b8 !important;
            background-color: rgba(23, 162, 184, 0.1) !important;
            color: #17a2b8 !important;
        }
        
        .nav-link[href*="algorithm"].active {
            border-left-color: #6c757d !important;
            background-color: rgba(108, 117, 125, 0.1) !important;
            color: #6c757d !important;
        }

        .sidebar-heading {
            font-size: .75rem;
            text-transform: uppercase;
            padding: 1rem;
            color: #6c757d;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .main-content {
            margin-left: 240px;
            padding: 20px;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        .navbar {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1030;
            padding-left: 256px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .navbar-brand, .navbar-nav .nav-link {
            color: #495057 !important;
        }
        body {
            padding-top: 56px;
            background-color: #f8f9fa;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1060;
        }
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1050;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #loader-wrapper.show {
            display: flex;
        }
        
        /* 铃铛按钮样式 */
        .notification-bell {
            display: inline-block;
            width: 36px;
            height: 36px;
            line-height: 36px;
            text-align: center;
            border-radius: 50%;
            background-color: #f8f9fa;
            position: relative;
        }
        
        .notification-bell i {
            font-size: 20px;
            color: #495057;
        }
        
        .notification-bell .notification-count {
            position: absolute;
            top: 70%;
            left: -40px;
            font-size: 15px;
            min-width: 18px;
            height: 27px;
            line-height: 18px;
            text-align: center;
            border-radius: 10px;
        
            transform: translateY(-50%);
        }
        
        .notification-menu {
            width: 320px !important;
            max-height: 400px !important;
            overflow-y: auto;
        }
        
        /* Flash消息样式 */
        .flash-messages-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1060;
            width: auto;
            max-width: 90%;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .flash-messages-container .alert {
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
            border-radius: 10px;
            padding: 15px 25px;
            text-align: center;
            animation: fadeInDown 0.5s, fadeOut 0.5s 4.5s;
            opacity: 0;
            animation-fill-mode: forwards;
            border: none;
            min-width: 300px;
        }
        
        .flash-messages-container .alert-success {
            background-color: rgba(40, 167, 69, 0.95);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.25);
        }
        
        .flash-messages-container .alert-danger,
        .flash-messages-container .alert-error {
            background-color: rgba(220, 53, 69, 0.95);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.25);
        }
        
        .flash-messages-container .alert-warning {
            background-color: rgba(255, 193, 7, 0.95);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.25);
        }
        
        .flash-messages-container .alert-info {
            background-color: rgba(23, 162, 184, 0.95);
            color: white;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.25);
        }
        
        .flash-message-text {
            font-weight: 500;
            font-size: 1.05rem;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">无人驾驶出租车管理平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle notification-bell" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-bell"></i>
                            <span class="badge bg-danger notification-count">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end notification-menu">
                            <li><h6 class="dropdown-header">系统通知</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <div class="notification-items">
                                <li class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </li>
                            </div>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-center" href="{{ url_for('notifications.index') }}">查看全部通知</a></li>
                        </ul>
                    </li>
                    
                </ul>
            </div>
        </div>
    </nav>

    <!-- 侧边栏导航 -->
    <div class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard.index') }}">
                    <i class="bi bi-house-door"></i> 首页仪表盘
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'vehicles' %}active{% endif %}" href="{{ url_for('vehicles.index') }}">
                    <i class="bi-taxi-front-fill"></i> 车辆管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'orders' %}active{% endif %}" href="{{ url_for('orders.index') }}">
                    <i class="bi bi-journal-text"></i> 订单管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'notifications' %}active{% endif %}" href="{{ url_for('notifications.index') }}">
                    <i class="bi bi-bell"></i> 通知管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'finance' %}active{% endif %}" href="{{ url_for('finance.index') }}">
                    <i class="bi bi-cash-coin"></i> 财务管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'analytics' %}active{% endif %}" href="{{ url_for('analytics.index') }}">
                    <i class="bi bi-graph-up"></i> 数据分析
                </a>
            </li>
     
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'coupons' %}active{% endif %}" href="{{ url_for('admin.coupons.packages') }}">
                    <i class="bi bi-ticket-perforated"></i> 优惠管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'users' %}active{% endif %}" href="{{ url_for('users.index') }}">
                    <i class="bi bi-people"></i> 用户管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'settings' %}active{% endif %}" href="{{ url_for('settings.index') }}">
                    <i class="bi bi-gear"></i> 系统设置
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_page == 'algorithm' %}active{% endif %}" href="{{ url_for('algorithm.index') }}">
                    <i class="bi bi-cpu"></i> 算法测试
                </a>
            </li>
        </ul>
    </div>

    <!-- 主要内容区域 -->
    <div class="main-content">
        <!-- Flash消息容器 -->
        <div class="flash-messages-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} fade show" role="alert">
                            {% if category == 'success' %}
                                <i class="bi bi-check-circle-fill me-2"></i>
                            {% elif category == 'danger' or category == 'error' %}
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            {% elif category == 'warning' %}
                                <i class="bi bi-exclamation-circle-fill me-2"></i>
                            {% elif category == 'info' %}
                                <i class="bi bi-info-circle-fill me-2"></i>
                            {% endif %}
                            <span class="flash-message-text">{{ message }}</span>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
        
        <!-- 加载动画 -->
        <div id="loader-wrapper">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
        
        {% block content %}{% endblock %}
    </div>

    <!-- 添加Bootstrap和其他需要的JS库 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 添加其他自定义脚本 -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    
    <script>
        // 设置当前页面的导航高亮
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 初始化Flash消息自动关闭功能
                initFlashMessages();
                
                // 根据当前URL路径来判断哪个导航应该高亮
                const currentPath = window.location.pathname;
                
                // 获取所有导航链接
                const navLinks = document.querySelectorAll('.sidebar .nav-link');
                
                // 默认移除所有active类
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                
                // 特殊处理某些路径
                if (currentPath.includes('/finance_health') || currentPath.includes('/financial-health')) {
                    // 财务健康页面只高亮数据分析
                    const analyticsLink = document.querySelector('.nav-link[href*="analytics"]');
                    if (analyticsLink) {
                        analyticsLink.classList.add('active');
                    }
                    return;
                }
                
                // 特殊处理服务质量分析页面
                if (currentPath.includes('/service_quality') || currentPath.includes('/service-quality')) {
                    // 服务质量分析页面只高亮数据分析
                    const analyticsLink = document.querySelector('.nav-link[href*="analytics"]');
                    if (analyticsLink) {
                        analyticsLink.classList.add('active');
                    }
                    return;
                }

                // 特殊处理用户行为和营销页面
                if (currentPath.includes('/user_marketing') || currentPath.includes('/user-marketing')) {
                    // 用户营销页面只高亮数据分析
                    const analyticsLink = document.querySelector('.nav-link[href*="analytics"]');
                    if (analyticsLink) {
                        analyticsLink.classList.add('active');
                    }
                    return;
                }
                
                // 激活匹配当前路径的导航项
                let activeFound = false;
                
                navLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && currentPath.includes(href.split('/').filter(Boolean)[0])) {
                        link.classList.add('active');
                        activeFound = true;
                    }
                });
                
                // 如果没有找到匹配项且在首页，则激活仪表盘
                if (!activeFound && (currentPath === '/' || currentPath.includes('dashboard'))) {
                    const dashboardLink = document.querySelector('.nav-link[href*="dashboard"]');
                    if (dashboardLink) {
                        dashboardLink.classList.add('active');
                    }
                }
                
            } catch (error) {
                console.error('Error in navigation initialization:', error);
            }
        });

        // 启用通知功能，每10秒更新一次
        function updateNotifications() {
            const notificationCount = document.querySelector('.notification-count');
            const notificationItems = document.querySelector('.notification-items');
            
            // 获取未读通知
            fetch('/api/v1/notifications/unread')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 更新通知数量
                        notificationCount.textContent = data.data.length;
                        
                        // 更新通知列表
                        if (data.data.length > 0) {
                            let notificationHTML = '';
                            data.data.slice(0, 5).forEach(notification => {
                                notificationHTML += `
                                    <li><a class="dropdown-item notification-item" href="/notifications?id=${notification.id}">
                                        <small class="text-muted">${notification.created_at}</small>
                                        <p class="mb-0">${notification.title}</p>
                                    </a></li>
                                `;
                            });
                            
                            notificationItems.innerHTML = notificationHTML;
                        } else {
                            notificationItems.innerHTML = '<li><span class="dropdown-item">没有新通知</span></li>';
                        }
                    }
                })
                .catch(error => {
                    console.error('获取通知失败:', error);
                });
        }
        
        // 页面加载时以及之后每60秒更新一次通知
        document.addEventListener('DOMContentLoaded', function() {
            updateNotifications();
            setInterval(updateNotifications, 60000);
        });
        
        /**
         * 初始化Flash消息自动关闭功能
         */
        function initFlashMessages() {
            // Flash消息现在通过CSS动画自动消失
            // 仅初始化一些其他可能的事件处理
            const alerts = document.querySelectorAll('.flash-messages-container .alert');
            alerts.forEach(alert => {
                // 消息显示完成后，从DOM中移除元素
                setTimeout(() => {
                    if (alert && alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 1500); // 5秒后移除元素
            });
        }
    </script>
    
    <!-- 允许继承脚本块 -->
    {% block scripts %}{% endblock %}
    
    <!-- 为了兼容性，保留extra_js块 -->
    {% block extra_js %}{% endblock %}
</body>
</html> 