{% extends "coupons/index.html" %}

{% block content_area %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h5>优惠券详情</h5>
        <div>
            <a href="{{ url_for('admin.coupons.list') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i> 返回列表
            </a>
            {% if coupon.status == '未使用' %}
            <button type="button" class="btn btn-outline-danger btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#invalidateModal">
                <i class="bi bi-x-circle me-1"></i> 作废优惠券
            </button>
            <button type="button" class="btn btn-outline-success btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#extendModal">
                <i class="bi bi-calendar-plus me-1"></i> 延长有效期
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- 优惠券基本信息卡片 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">优惠券基本信息</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">优惠券ID</label>
                        <p class="fw-bold">{{ coupon.coupon_id }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">状态</label>
                        <p>
                            <span class="badge {% if coupon.status == '未使用' %}bg-success{% elif coupon.status == '已使用' %}bg-info{% else %}bg-secondary{% endif %} fw-bold">
                                {{ coupon.status }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">优惠券类型</label>
                        <p class="fw-bold">{{ coupon.type_name }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">折扣类型</label>
                        <p class="fw-bold">{{ coupon.discount_type }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">优惠值</label>
                        <p class="fw-bold text-primary fs-5">{{ coupon.value_display }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">使用条件</label>
                        <p class="fw-bold">{% if coupon.min_amount > 0 %}满{{ coupon.min_amount }}元可用{% else %}无门槛{% endif %}</p>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">用户</label>
                        <p class="fw-bold">{{ coupon.user_name }} (ID: {{ coupon.user_id }})</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">来源</label>
                        <p class="fw-bold">{{ coupon.source }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">获得时间</label>
                        <p>{{ coupon.receive_time }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">有效期</label>
                        <p>{{ coupon.validity_start }} 至 {{ coupon.validity_end }}</p>
                    </div>
                    {% if coupon.status == '已使用' and coupon.use_time %}
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">使用时间</label>
                        <p>{{ coupon.use_time }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">使用订单</label>
                        <p>
                            {% if coupon.order_id %}
                            <a href="{{ url_for('admin.orders.detail', order_id=coupon.order_id) }}" class="link-primary">
                                {{ coupon.order_id }}
                            </a>
                            {% else %}
                            无订单信息
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
                
                {% if coupon.type_description %}
                <hr>
                <div class="row">
                    <div class="col-12">
                        <label class="form-label text-muted">优惠券说明</label>
                        <p>{{ coupon.type_description }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if order %}
        <!-- 关联订单信息卡片 -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">关联订单信息</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">订单号</label>
                        <p>
                            <a href="{{ url_for('admin.orders.detail', order_id=order.order_number) }}" class="link-primary">
                                {{ order.order_number }}
                            </a>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">订单状态</label>
                        <p>
                            <span class="badge bg-secondary">{{ order.status }}</span>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">订单金额</label>
                        <p class="fw-bold">¥{{ order.actual_amount }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">下单时间</label>
                        <p>{{ order.create_time }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if package %}
        <!-- 套餐信息卡片 -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">来源套餐信息</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">套餐名称</label>
                        <p>
                            <a href="{{ url_for('admin.coupons.get_package_detail', package_id=package.id) }}" class="link-primary">
                                {{ package.name }}
                            </a>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">套餐价格</label>
                        <p class="fw-bold">¥{{ package.price }}</p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label text-muted">套餐描述</label>
                        <p>{{ package.description }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <!-- 优惠券状态卡片 -->
        <div class="card mb-4 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <span class="badge {% if coupon.status == '未使用' %}bg-success{% elif coupon.status == '已使用' %}bg-info{% else %}bg-secondary{% endif %} p-3 rounded-circle">
                        <i class="bi 
                            {% if coupon.status == '未使用' %}bi-check-circle-fill{% elif coupon.status == '已使用' %}bi-bag-check-fill{% else %}bi-x-circle-fill{% endif %} 
                            fs-1"></i>
                    </span>
                </div>
                <h5 class="card-title">当前状态: {{ coupon.status }}</h5>
                {% if coupon.status == '未使用' %}
                <p class="card-text">此优惠券仍然有效，可以正常使用</p>
                {% elif coupon.status == '已使用' %}
                <p class="card-text">
                    此优惠券已于 {{ coupon.use_time }} 使用
                    {% if coupon.order_id %}
                    <br>用于订单: {{ coupon.order_id }}
                    {% endif %}
                </p>
                {% else %}
                <p class="card-text">此优惠券已过期或被作废，无法使用</p>
                {% endif %}
            </div>
        </div>
        
        <!-- 倒计时/有效期卡片 -->
        {% if coupon.status == '未使用' %}
        <div class="card mb-4">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">优惠券有效期</h6>
                <div class="countdown-container" data-end-time="{{ coupon.validity_end }}">
                    <div class="display-6 text-primary countdown-timer mb-2">
                        <span id="validityCountdown">计算中...</span>
                    </div>
                    <div class="small text-muted">
                        {{ coupon.validity_start }} 至 {{ coupon.validity_end }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 优惠券操作卡片 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">操作</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if coupon.status == '未使用' %}
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#invalidateModal">
                        <i class="bi bi-x-circle me-2"></i> 作废优惠券
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#extendModal">
                        <i class="bi bi-calendar-plus me-2"></i> 延长有效期
                    </button>
                    {% endif %}
                    <a href="{{ url_for('admin.coupons.list') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i> 返回列表
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 作废优惠券模态框 -->
<div class="modal fade" id="invalidateModal" tabindex="-1" aria-labelledby="invalidateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.coupons.operate', coupon_id=coupon.coupon_id) }}" method="post">
                <input type="hidden" name="operation" value="invalidate">
                <div class="modal-header">
                    <h5 class="modal-title" id="invalidateModalLabel">作废优惠券</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要作废优惠券 #{{ coupon.coupon_id }} 吗？</p>
                    <p class="text-danger">此操作不可逆，作废后优惠券将无法使用。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">确认作废</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 延期优惠券模态框 -->
<div class="modal fade" id="extendModal" tabindex="-1" aria-labelledby="extendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.coupons.operate', coupon_id=coupon.coupon_id) }}" method="post">
                <input type="hidden" name="operation" value="extend">
                <div class="modal-header">
                    <h5 class="modal-title" id="extendModalLabel">延长优惠券有效期</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>为优惠券 #{{ coupon.coupon_id }} 延长有效期：</p>
                    <div class="mb-3">
                        <label for="days" class="form-label">延长天数</label>
                        <input type="number" class="form-control" id="days" name="days" min="1" value="7" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">确认延期</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 有效期倒计时功能
        const countdownElement = document.getElementById('validityCountdown');
        if (countdownElement) {
            const countdownContainer = document.querySelector('.countdown-container');
            const endTimeStr = countdownContainer.getAttribute('data-end-time');
            const endTime = new Date(endTimeStr.replace(/-/g, '/'));
            
            function updateCountdown() {
                const now = new Date();
                const diff = endTime - now;
                
                if (diff <= 0) {
                    countdownElement.textContent = "已过期";
                    countdownElement.classList.remove('text-primary');
                    countdownElement.classList.add('text-danger');
                    return;
                }
                
                // 计算剩余时间
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (days > 0) {
                    countdownElement.textContent = `${days}天 ${hours}小时`;
                } else if (hours > 0) {
                    countdownElement.textContent = `${hours}小时 ${minutes}分`;
                } else {
                    countdownElement.textContent = `${minutes}分 ${seconds}秒`;
                }
                
                // 如果剩余时间少于24小时，显示警告
                if (diff < 24 * 60 * 60 * 1000) {
                    countdownElement.classList.remove('text-primary');
                    countdownElement.classList.add('text-warning');
                }
                
                // 每秒更新一次
                setTimeout(updateCountdown, 1000);
            }
            
            updateCountdown();
        }
    });
</script>
{% endblock %} 