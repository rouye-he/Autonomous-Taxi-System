{% extends "coupons/index.html" %}

{% block content_area %}
<!-- 添加隐藏的过滤器状态数据 -->
<div id="filterStatus" 
     data-has-filter="{% if filter and (filter.user_id or filter.type or filter.status or filter.source) %}true{% else %}false{% endif %}" 
     style="display:none;"></div>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h5>优惠券列表 <span class="badge bg-primary" id="totalCount">{{ pagination.total_count if pagination else 0 }}</span></h5>
        <a id="searchToggle" data-bs-toggle="collapse" href="#searchForm" role="button" aria-expanded="false">
            <i class="bi bi-funnel-fill me-1"></i> 高级筛选
        </a>
    </div>
</div>

<!-- 高级筛选表单 -->
<div class="collapse mb-4" id="searchForm">
    <div class="card card-body bg-light">
        <form method="GET" action="{{ url_for('admin.coupons.list') }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="user_id" class="form-label">用户ID</label>
                    <input type="text" class="form-control" id="user_id" name="user_id" value="{{ filter.user_id if filter else '' }}">
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">优惠券类型</label>
                    <select class="form-select" id="type" name="type">
                        <option value="">全部</option>
                        {% for type in coupon_types %}
                        <option value="{{ type.id }}" {% if filter and filter.type|string == type.id|string %}selected{% endif %}>{{ type.type_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">状态</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">全部</option>
                        <option value="未使用" {% if filter and filter.status == '未使用' %}selected{% endif %}>未使用</option>
                        <option value="已使用" {% if filter and filter.status == '已使用' %}selected{% endif %}>已使用</option>
                        <option value="已过期" {% if filter and filter.status == '已过期' %}selected{% endif %}>已过期</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="source" class="form-label">来源</label>
                    <select class="form-select" id="source" name="source">
                        <option value="">全部</option>
                        {% if sources %}
                        {% for source in sources %}
                        <option value="{{ source }}" {% if filter and filter.source == source %}selected{% endif %}>{{ source }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button type="reset" class="btn btn-outline-secondary me-2">重置</button>
                <button type="submit" class="btn btn-primary">查询</button>
            </div>
        </form>
    </div>
</div>

<!-- 筛选标签 -->
{% if filter and (filter.user_id or filter.type or filter.status or filter.source) %}
<div class="d-flex flex-wrap mb-3 filter-tags">
    {% if filter.user_id %}
    <div class="filter-tag">
        <span>用户ID: {{ filter.user_id }}</span>
        <a href="{{ url_for('admin.coupons.list', type=filter.type, status=filter.status, source=filter.source) }}" class="ms-2"><i class="bi bi-x-circle"></i></a>
    </div>
    {% endif %}
    
    {% if filter.type %}
    <div class="filter-tag">
        <span>优惠券类型: 
            {% for type in coupon_types %}
                {% if filter.type|string == type.id|string %}{{ type.type_name }}{% endif %}
            {% endfor %}
        </span>
        <a href="{{ url_for('admin.coupons.list', user_id=filter.user_id, status=filter.status, source=filter.source) }}" class="ms-2"><i class="bi bi-x-circle"></i></a>
    </div>
    {% endif %}
    
    {% if filter.status %}
    <div class="filter-tag">
        <span>状态: {{ filter.status }}</span>
        <a href="{{ url_for('admin.coupons.list', user_id=filter.user_id, type=filter.type, source=filter.source) }}" class="ms-2"><i class="bi bi-x-circle"></i></a>
    </div>
    {% endif %}
    
    {% if filter.source %}
    <div class="filter-tag">
        <span>来源: {{ filter.source }}</span>
        <a href="{{ url_for('admin.coupons.list', user_id=filter.user_id, type=filter.type, status=filter.status) }}" class="ms-2"><i class="bi bi-x-circle"></i></a>
    </div>
    {% endif %}
    
    <div class="filter-tag clear-all">
        <a href="{{ url_for('admin.coupons.list') }}" class="text-danger">
            <i class="bi bi-trash"></i> 清除全部
        </a>
    </div>
</div>
{% endif %}

<!-- 优惠券列表 -->
<div class="card">
    <div class="card-body">
        {% if error %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ error }}
        </div>
        {% else %}
        <div class="table-responsive">
            <table id="couponsTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户</th>
                        <th>优惠券类型</th>
                        <th>价值</th>
                        <th>使用条件</th>
                        <th>来源</th>
                        <th>获得时间</th>
                        <th>有效期至</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for coupon in coupons %}
                    <tr>
                        <td>{{ coupon.coupon_id }}</td>
                        <td>{{ coupon.user_name }} (ID: {{ coupon.user_id }})</td>
                        <td>{{ coupon.type_name }}</td>
                        <td>{{ coupon.value_display }}</td>
                        <td>{% if coupon.min_amount > 0 %}满{{ coupon.min_amount }}元可用{% else %}无门槛{% endif %}</td>
                        <td>{{ coupon.source }}</td>
                        <td>{{ coupon.receive_time }}</td>
                        <td>{{ coupon.validity_end }}</td>
                        <td>
                            <span class="badge {% if coupon.status == '未使用' %}bg-success{% elif coupon.status == '已使用' %}bg-info{% else %}bg-secondary{% endif %}">
                                {{ coupon.status }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if coupon.status == '未使用' %}
                                <button type="button" class="btn btn-outline-danger invalidate-btn" data-id="{{ coupon.coupon_id }}">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success extend-btn" data-id="{{ coupon.coupon_id }}">
                                    <i class="bi bi-calendar-plus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- 作废优惠券模态框 -->
<div class="modal fade" id="invalidateModal" tabindex="-1" aria-labelledby="invalidateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.coupons.operate_coupon', coupon_id=0) }}" method="post" id="invalidateForm">
                <input type="hidden" name="operation" value="invalidate">
                <div class="modal-header">
                    <h5 class="modal-title" id="invalidateModalLabel">作废优惠券</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要作废优惠券 #<span id="invalidateCouponId"></span> 吗？</p>
                    <p class="text-danger">此操作不可逆，作废后优惠券将无法使用。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">确认作废</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 延期优惠券模态框 -->
<div class="modal fade" id="extendModal" tabindex="-1" aria-labelledby="extendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.coupons.operate_coupon', coupon_id=0) }}" method="post" id="extendForm">
                <input type="hidden" name="operation" value="extend">
                <div class="modal-header">
                    <h5 class="modal-title" id="extendModalLabel">延长优惠券有效期</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>为优惠券 #<span id="extendCouponId"></span> 延长有效期：</p>
                    <div class="mb-3">
                        <label for="days" class="form-label">延长天数</label>
                        <input type="number" class="form-control" id="days" name="days" min="1" value="7" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">确认延期</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- 引入DataTables相关JS和CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function() {
        // 初始化DataTables
        var table = $('#couponsTable').DataTable({
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            responsive: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "全部"]],
            order: [[0, 'desc']], // 默认按ID倒序排列
            columnDefs: [
                { orderable: false, targets: -1 }, // 最后一列（操作）不可排序
                { className: 'text-center align-middle', targets: '_all' }, // 所有列居中对齐
                { className: 'text-start align-middle', targets: [1, 5] } // 用户和来源列左对齐
            ],
            serverSide: true,
            processing: true,
            ajax: {
                url: "{{ url_for('admin.coupons.data') }}",
                type: "GET",
                data: function(d) {
                    // 添加筛选参数
                    d.user_id = $("#user_id").val();
                    d.type = $("#type").val();
                    d.status = $("#status").val();
                    d.source = $("#source").val();
                }
            },
            columns: [
                { data: "coupon_id" },
                { data: "user_info" },
                { data: "type_name" },
                { data: "value_display" },
                { data: "condition" },
                { data: "source" },
                { data: "receive_time" },
                { data: "validity_end" },
                { data: "status_html", render: function(data) { return data; } },
                { data: "actions", render: function(data) { return data; } }
            ]
        });
        
        // 绑定动态加载的按钮事件
        $('#couponsTable').on('click', '.invalidate-btn', function() {
            var couponId = $(this).data('id');
            $('#invalidateCouponId').text(couponId);
            $('#invalidateForm').attr('action', $('#invalidateForm').attr('action').replace('0', couponId));
            $('#invalidateModal').modal('show');
        });
        
        $('#couponsTable').on('click', '.extend-btn', function() {
            var couponId = $(this).data('id');
            $('#extendCouponId').text(couponId);
            $('#extendForm').attr('action', $('#extendForm').attr('action').replace('0', couponId));
            $('#extendModal').modal('show');
        });
        
        // 搜索表单提交时重新加载表格
        $('form[method="GET"]').on('submit', function(e) {
            e.preventDefault();
            table.ajax.reload();
            // 更新URL以反映过滤状态
            var params = new URLSearchParams();
            if ($("#user_id").val()) params.append('user_id', $("#user_id").val());
            if ($("#type").val()) params.append('type', $("#type").val());
            if ($("#status").val()) params.append('status', $("#status").val());
            if ($("#source").val()) params.append('source', $("#source").val());
            
            var newUrl = window.location.pathname;
            if (params.toString()) {
                newUrl += '?' + params.toString();
            }
            history.pushState({}, '', newUrl);
            return false;
        });
        
        // 高级筛选表单展开/折叠
        $('#searchToggle').click(function() {
            $(this).find('i').toggleClass('bi-funnel-fill bi-funnel');
        });
        
        // 自动展开筛选表单（如果有筛选条件）
        var hasFilters = $('#filterStatus').data('hasFilter') === 'true';
        if (hasFilters) {
            $('#searchForm').addClass('show');
            $('#searchToggle').find('i').removeClass('bi-funnel-fill').addClass('bi-funnel');
        }
    });
</script>

<style>
    /* 表格单元格居中样式 */
    .table th, .table td {
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        padding: 8px;
    }
    
    .filter-tags {
        gap: 10px;
    }
    
    .filter-tag {
        display: inline-flex;
        align-items: center;
        background-color: #f0f7ff;
        border: 1px solid #cfe2ff;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 13px;
    }
    
    .filter-tag a {
        color: #6c757d;
        text-decoration: none;
    }
    
    .filter-tag a:hover {
        color: #dc3545;
    }
    
    .filter-tag.clear-all {
        background-color: #fff4f5;
        border-color: #ffd4d8;
    }
    
    .dataTables_wrapper .dataTables_length, 
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        margin-bottom: 10px;
    }
</style>
{% endblock %} 