{% extends "base.html" %}

{% block title %}用户数据分析 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<style>
    /* 图表悬停提示样式 */
    .card-header {
        position: relative;
    }
    .chart-info-tooltip {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 0 0 10px 10px;
        font-size: 14px;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        line-height: 1.5;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        max-height: 300px;
        overflow-y: auto;
    }
    .card-header:hover .chart-info-tooltip {
        opacity: 1;
        visibility: visible;
    }
    
    .stat-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
        text-align: center;
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card .icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: #007bff;
    }
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stat-card .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    /* 基础卡片样式 */
    .data-card {
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,100,255,0.1);
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    .data-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .data-card .card-header {
        border-bottom: none;
        border-radius: 15px 15px 0 0;
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    /* 不同图表的卡片样式 */
    /* 用户增长趋势 */
    .chart-growth {
        border: 1px solid rgba(100,150,255,0.3);
    }
    .chart-growth .card-header {
        background: linear-gradient(135deg, rgba(25,60,125,0.8), rgba(45,120,255,0.5));
    }
    .chart-growth:hover .card-header {
        background: linear-gradient(135deg, rgba(25,60,125,0.9), rgba(45,120,255,0.7));
    }
    
    /* 用户注册渠道 */
    .chart-channel {
        border: 1px solid rgba(255,100,100,0.3);
    }
    .chart-channel .card-header {
        background: linear-gradient(135deg, rgba(125,25,25,0.8), rgba(255,45,45,0.5));
    }
    .chart-channel:hover .card-header {
        background: linear-gradient(135deg, rgba(125,25,25,0.9), rgba(255,45,45,0.7));
    }
    
    /* 用户年龄分布 */
    .chart-age {
        border: 1px solid rgba(100,255,100,0.3);
    }
    .chart-age .card-header {
        background: linear-gradient(135deg, rgba(25,125,25,0.8), rgba(45,255,45,0.5));
    }
    .chart-age:hover .card-header {
        background: linear-gradient(135deg, rgba(25,125,25,0.9), rgba(45,255,45,0.7));
    }
    
    /* 用户性别比例 */
    .chart-gender {
        border: 1px solid rgba(255,100,255,0.3);
    }
    .chart-gender .card-header {
        background: linear-gradient(135deg, rgba(125,25,125,0.8), rgba(255,45,255,0.5));
    }
    .chart-gender:hover .card-header {
        background: linear-gradient(135deg, rgba(125,25,125,0.9), rgba(255,45,255,0.7));
    }
    
    /* 用户信用分分布 */
    .chart-credit {
        border: 1px solid rgba(255,200,100,0.3);
    }
    .chart-credit .card-header {
        background: linear-gradient(135deg, rgba(125,100,25,0.8), rgba(255,170,45,0.5));
    }
    .chart-credit:hover .card-header {
        background: linear-gradient(135deg, rgba(125,100,25,0.9), rgba(255,170,45,0.7));
    }
    
    /* 用户地理分布 */
    .chart-geo {
        border: 1px solid rgba(100,200,255,0.3);
    }
    .chart-geo .card-header {
        background: linear-gradient(135deg, rgba(25,100,125,0.8), rgba(45,170,255,0.5));
    }
    .chart-geo:hover .card-header {
        background: linear-gradient(135deg, rgba(25,100,125,0.9), rgba(45,170,255,0.7));
    }
    
    /* 用户标签云 */
    .chart-tags {
        border: 1px solid rgba(200,100,255,0.3);
    }
    .chart-tags .card-header {
        background: linear-gradient(135deg, rgba(100,25,125,0.8), rgba(170,45,255,0.5));
    }
    .chart-tags:hover .card-header {
        background: linear-gradient(135deg, rgba(100,25,125,0.9), rgba(170,45,255,0.7));
    }
    
    /* 用户使用时段分布 */
    .chart-time {
        border: 1px solid rgba(100,255,200,0.3);
    }
    .chart-time .card-header {
        background: linear-gradient(135deg, rgba(25,125,100,0.8), rgba(45,255,170,0.5));
    }
    .chart-time:hover .card-header {
        background: linear-gradient(135deg, rgba(25,125,100,0.9), rgba(45,255,170,0.7));
    }
    
    /* 用户消费能力分析 */
    .chart-consumption {
        border: 1px solid rgba(255,255,100,0.3);
    }
    .chart-consumption .card-header {
        background: linear-gradient(135deg, rgba(125,125,25,0.8), rgba(255,255,45,0.5));
    }
    .chart-consumption:hover .card-header {
        background: linear-gradient(135deg, rgba(125,125,25,0.9), rgba(255,255,45,0.7));
    }
    
    /* 用户留存率分析 */
    .chart-retention {
        border: 1px solid rgba(150,100,255,0.3);
    }
    .chart-retention .card-header {
        background: linear-gradient(135deg, rgba(75,25,125,0.8), rgba(130,45,255,0.5));
    }
    .chart-retention:hover .card-header {
        background: linear-gradient(135deg, rgba(75,25,125,0.9), rgba(130,45,255,0.7));
    }
    
    .metric-up {
        color: #28a745;
    }
    .metric-down {
        color: #dc3545;
    }
    .metric-neutral {
        color: #6c757d;
    }
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
    }
    .tag {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        background-color: #e9ecef;
    }
    .tag-1 { font-size: 0.85rem; background-color: #e9ecef; }
    .tag-2 { font-size: 0.95rem; background-color: #dee2e6; }
    .tag-3 { font-size: 1.05rem; background-color: #ced4da; }
    .tag-4 { font-size: 1.15rem; background-color: #adb5bd; color: white; }
    .tag-5 { font-size: 1.25rem; background-color: #6c757d; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>用户数据分析</h2>
            <p class="text-muted">可视化分析用户数据，了解用户行为和趋势</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('users.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> 返回用户管理
            </a>
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-file-earmark"></i> 导出报表
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a href="{{ url_for('users.export_analytics_report') }}" class="dropdown-item" id="exportExcelBtn">
                            <i class="bi bi-file-earmark-excel"></i> Excel格式
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('users.export_analytics_report_pdf') }}" class="dropdown-item" id="exportPdfBtn">
                            <i class="bi bi-file-earmark-pdf"></i> PDF格式
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 关键指标概览 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card" data-bs-toggle="tooltip" data-bs-placement="top" title="系统中注册的所有用户总数，同比增长表示与去年同期相比的增长百分比">
                <div class="icon"><i class="bi bi-people"></i></div>
                <div class="stat-value">{{ analytics_data.total_users }}</div>
                <div class="stat-label">总用户数</div>
                <div class="{% if analytics_data.yoy_growth > 0 %}metric-up{% elif analytics_data.yoy_growth < 0 %}metric-down{% else %}metric-neutral{% endif %}">
                    <i class="bi bi-{% if analytics_data.yoy_growth > 0 %}arrow-up{% elif analytics_data.yoy_growth < 0 %}arrow-down{% else %}dash{% endif %}"></i> 
                    {{ analytics_data.yoy_growth }}% 同比{% if analytics_data.yoy_growth > 0 %}增长{% elif analytics_data.yoy_growth < 0 %}下降{% else %}持平{% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card" data-bs-toggle="tooltip" data-bs-placement="top" title="当前月份内新注册的用户数量，环比增长表示与上个月相比的增长百分比">
                <div class="icon"><i class="bi bi-person-plus"></i></div>
                <div class="stat-value">{{ analytics_data.new_users_this_month }}</div>
                <div class="stat-label">本月新增用户</div>
                <div class="{% if analytics_data.mom_growth > 0 %}metric-up{% elif analytics_data.mom_growth < 0 %}metric-down{% else %}metric-neutral{% endif %}">
                    <i class="bi bi-{% if analytics_data.mom_growth > 0 %}arrow-up{% elif analytics_data.mom_growth < 0 %}arrow-down{% else %}dash{% endif %}"></i> 
                    {{ analytics_data.mom_growth }}% 环比{% if analytics_data.mom_growth > 0 %}增长{% elif analytics_data.mom_growth < 0 %}下降{% else %}持平{% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card" data-bs-toggle="tooltip" data-bs-placement="top" title="近30天内有登录记录的用户占总用户数的百分比，反映平台用户活跃程度">
                <div class="icon"><i class="bi bi-person-check"></i></div>
                <div class="stat-value">{{ analytics_data.activity_rate }}%</div>
                <div class="stat-label">用户活跃率</div>
                <div class="{% if analytics_data.activity_rate_change > 0 %}metric-up{% elif analytics_data.activity_rate_change < 0 %}metric-down{% else %}metric-neutral{% endif %}">
                    <i class="bi bi-{% if analytics_data.activity_rate_change > 0 %}arrow-up{% elif analytics_data.activity_rate_change < 0 %}arrow-down{% else %}dash{% endif %}"></i> 
                    {{ analytics_data.activity_rate_change }}% 环比{% if analytics_data.activity_rate_change > 0 %}增长{% elif analytics_data.activity_rate_change < 0 %}下降{% else %}持平{% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card" data-bs-toggle="tooltip" data-bs-placement="top" title="留存率表示30-60天前注册的用户中，最近30天内有登录记录的比例，是衡量用户粘性的重要指标">
                <div class="icon"><i class="bi bi-arrow-return-left"></i></div>
                <div class="stat-value">{{ analytics_data.retention_rate }}%</div>
                <div class="stat-label">30天用户留存率</div>
                <div class="{% if analytics_data.retention_rate_change > 0 %}metric-up{% elif analytics_data.retention_rate_change < 0 %}metric-down{% else %}metric-neutral{% endif %}">
                    <i class="bi bi-{% if analytics_data.retention_rate_change > 0 %}arrow-up{% elif analytics_data.retention_rate_change < 0 %}arrow-down{% else %}dash{% endif %}"></i> 
                    {{ analytics_data.retention_rate_change }}% 环比{% if analytics_data.retention_rate_change > 0 %}增长{% elif analytics_data.retention_rate_change < 0 %}下降{% else %}持平{% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 图表分析 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card data-card chart-growth">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i>
                    用户增长趋势 (近12个月)
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的register_time和last_login_time字段</p>
                        <p><strong>分析目的:</strong> 显示过去12个月内新增用户和活跃用户的变化趋势，识别用户增长模式</p>
                        <p><strong>图表说明:</strong> 双线图展示新增用户数量和活跃用户数量的月度变化，帮助分析用户增长和活跃度趋势</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card data-card chart-channel">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    用户注册渠道分布
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的registration_channel字段</p>
                        <p><strong>分析目的:</strong> 了解用户获取渠道的分布情况，评估不同渠道的获客效果</p>
                        <p><strong>图表说明:</strong> 环形图直观展示各渠道用户占比，帮助优化用户获取策略</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="registrationChannelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card data-card chart-age">
                <div class="card-header">
                    <i class="bi bi-bar-chart me-1"></i>
                    用户年龄分布
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的birth_date或age字段计算</p>
                        <p><strong>分析目的:</strong> 了解平台用户的年龄结构，识别主要年龄群体</p>
                        <p><strong>图表说明:</strong> 柱状图展示不同年龄段的用户数量分布，帮助针对特定年龄群体优化服务</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ageDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card data-card chart-gender">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    用户性别比例
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的gender字段</p>
                        <p><strong>分析目的:</strong> 了解平台用户的性别分布情况，为营销策略提供依据</p>
                        <p><strong>图表说明:</strong> 饼图直观展示男性、女性用户的比例分布</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="genderRatioChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card data-card chart-credit">
                <div class="card-header">
                    <i class="bi bi-bar-chart me-1"></i>
                    用户信用分分布
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的credit_score字段</p>
                        <p><strong>分析目的:</strong> 了解用户信用状况分布，评估整体用户信用质量</p>
                        <p><strong>图表说明:</strong> 柱状图展示不同信用分区间的用户数量，帮助识别潜在风险群体</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="creditScoreChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户地理分布 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card data-card chart-geo">
                <div class="card-header">
                    <i class="bi bi-globe me-1"></i>
                    用户地理分布
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的province或city字段</p>
                        <p><strong>分析目的:</strong> 了解用户地理分布情况，识别主要市场区域</p>
                        <p><strong>图表说明:</strong> 中国地图热力图展示各省份用户数量，颜色深浅表示用户密度</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <div id="userGeographicChart" style="width:100%; height:350px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card data-card chart-tags">
                <div class="card-header">
                    <i class="bi bi-cloud me-1"></i>
                    用户标签云
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> user_tags关联表或users表中的兴趣标签字段</p>
                        <p><strong>分析目的:</strong> 展示用户群体的兴趣和特征标签，了解用户画像</p>
                        <p><strong>图表说明:</strong> 词云图通过标签大小展示不同标签的权重，直观呈现用户群体特征</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <div id="userTagsChart" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户行为分析 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card data-card chart-time">
                <div class="card-header">
                    <i class="bi bi-clock-history me-1"></i>
                    用户使用时段分布
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表中的create_time字段提取小时数据</p>
                        <p><strong>分析目的:</strong> 了解用户在一天中的下单时间分布，把握用户使用习惯</p>
                        <p><strong>图表说明:</strong> 折线图分别展示工作日和周末各时段的订单数量，帮助合理安排车辆调度</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="userTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card data-card chart-consumption">
                <div class="card-header">
                    <i class="bi bi-cash-coin me-1"></i>
                    用户消费能力分析
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> orders表中的amount字段和users表关联</p>
                        <p><strong>分析目的:</strong> 分析不同用户群体的消费能力和消费频率，识别高价值用户</p>
                        <p><strong>图表说明:</strong> 气泡图通过位置和大小展示不同消费群体的订单频率、消费金额和群体规模</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="userConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户留存与流失 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card data-card chart-retention">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i>
                    用户留存率分析 (最近6个月)
                    <div class="chart-info-tooltip">
                        <p><strong>数据来源:</strong> users表中的register_time和last_login_time字段</p>
                        <p><strong>分析目的:</strong> 评估不同时间段用户的留存情况，了解用户粘性和服务满意度</p>
                        <p><strong>图表说明:</strong> 折线图展示1个月、3个月、6个月的用户留存率变化，其中：</p>
                        <ul>
                            <li><strong>1个月留存率</strong>：30-60天前注册的用户中，最近30天有登录的比例</li>
                            <li><strong>3个月留存率</strong>：90-120天前注册的用户中，最近30天有登录的比例</li>
                            <li><strong>6个月留存率</strong>：180-210天前注册的用户中，最近30天有登录的比例</li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="userRetentionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<!-- 引入需要的库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.0.0/dist/echarts-wordcloud.min.js"></script>

<script>
// 直接嵌入中国地图数据，避免网络请求
(function() {
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // 加载地图并初始化
        initMapChart();
         
        // 初始化标签云
        initTagsChart();
        
        // 初始化用户使用时段分布图表
        initUserTimeChart();
        
        // 初始化用户消费能力分析图表
        initUserConsumptionChart();
        
        // 用户增长趋势
        const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
        new Chart(userGrowthCtx, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ analytics_data.growth_trend_data.months | tojson | safe }}'),
                datasets: [
                    {
                        label: '新增用户',
                        data: JSON.parse('{{ analytics_data.growth_trend_data.new_users | tojson | safe }}'),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: '活跃用户',
                        data: JSON.parse('{{ analytics_data.growth_trend_data.active_users | tojson | safe }}'),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 注册渠道分布
        const registrationChannelCtx = document.getElementById('registrationChannelChart').getContext('2d');
        new Chart(registrationChannelCtx, {
            type: 'doughnut',
            data: {
                labels: JSON.parse('{{ analytics_data.channel_distribution.channels | tojson | safe }}'),
                datasets: [{
                    data: JSON.parse('{{ analytics_data.channel_distribution.counts | tojson | safe }}'),
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(201, 203, 207, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        // 年龄分布
        const ageDistributionCtx = document.getElementById('ageDistributionChart').getContext('2d');
        new Chart(ageDistributionCtx, {
            type: 'bar',
            data: {
                labels: JSON.parse('{{ analytics_data.age_distribution.labels | tojson | safe }}'),
                datasets: [{
                    label: '用户数量',
                    data: JSON.parse('{{ analytics_data.age_distribution.data | tojson | safe }}'),
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 性别比例
        const genderRatioCtx = document.getElementById('genderRatioChart').getContext('2d');
        new Chart(genderRatioCtx, {
            type: 'pie',
            data: {
                labels: JSON.parse('{{ analytics_data.gender_distribution.labels | tojson | safe }}'),
                datasets: [{
                    data: JSON.parse('{{ analytics_data.gender_distribution.data | tojson | safe }}'),
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 205, 86, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}%`;
                            }
                        }
                    }
                }
            }
        });

        // 信用分分布
        const creditScoreCtx = document.getElementById('creditScoreChart').getContext('2d');
        new Chart(creditScoreCtx, {
            type: 'bar',
            data: {
                labels: JSON.parse('{{ analytics_data.credit_score_distribution.labels | tojson | safe }}'),
                datasets: [{
                    label: '用户数量',
                    data: JSON.parse('{{ analytics_data.credit_score_distribution.data | tojson | safe }}'),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(54, 162, 235, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const item = tooltipItems[0];
                                return item.label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    },
                    x: {
                        title: {
                            display: true,
                            text: '信用分区间(0-150)'
                        }
                    }
                }
            }
        });

        // 用户留存率
        const userRetentionCtx = document.getElementById('userRetentionChart').getContext('2d');
        new Chart(userRetentionCtx, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ analytics_data.retention_data.months | tojson | safe }}'),
                datasets: [
                    {
                        label: '1个月留存',
                        data: JSON.parse('{{ analytics_data.retention_data.one_month_retention | tojson | safe }}'),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    },
                    {
                        label: '3个月留存',
                        data: JSON.parse('{{ analytics_data.retention_data.three_month_retention | tojson | safe }}'),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    },
                    {
                        label: '6个月留存',
                        data: JSON.parse('{{ analytics_data.retention_data.six_month_retention | tojson | safe }}'),
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                // 处理空值显示
                                if (context.raw === null) {
                                    return `${context.dataset.label}: 数据待收集`;
                                }
                                return `${context.dataset.label}: ${context.raw}%`;
                            }
                        }
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // 处理导出的函数
        function handleExport(e, element, type) {
            e.preventDefault();
            showToast(`${type}报表正在生成中，请稍候...`, 'info', 1500);
            setTimeout(() => {
                window.location.href = element.getAttribute('href');
                setTimeout(() => {
                    showToast(`${type}报表导出成功！`, 'success');
                }, 1000);
            }, 1500);
        }

        // 添加导出事件监听器
        document.getElementById('exportExcelBtn').addEventListener('click', function(e) {
            handleExport(e, this, 'Excel');
        });

        document.getElementById('exportPdfBtn').addEventListener('click', function(e) {
            handleExport(e, this, 'PDF');
        });
    });
})();

// 初始化地图图表
function initMapChart() {
    // 从后端获取省份数据
    let geoData = JSON.parse('{{ analytics_data.geographic_distribution | default([]) | tojson | safe }}');
    
    // 数据格式检查和转换
    if (!Array.isArray(geoData)) {
        geoData = [];
        console.error('地理分布数据格式错误');
    }
    
    // 省份名称映射（简称到全称）
    const provinceNameMap = {
        '北京': '北京市',
        '天津': '天津市',
        '上海': '上海市',
        '重庆': '重庆市',
        '河北': '河北省',
        '山西': '山西省',
        '辽宁': '辽宁省',
        '吉林': '吉林省',
        '黑龙江': '黑龙江省',
        '江苏': '江苏省',
        '浙江': '浙江省',
        '安徽': '安徽省',
        '福建': '福建省',
        '江西': '江西省',
        '山东': '山东省',
        '河南': '河南省',
        '湖北': '湖北省',
        '湖南': '湖南省',
        '广东': '广东省',
        '海南': '海南省',
        '四川': '四川省',
        '贵州': '贵州省',
        '云南': '云南省',
        '陕西': '陕西省',
        '甘肃': '甘肃省',
        '青海': '青海省',
        '台湾': '台湾省',
        '内蒙古': '内蒙古自治区',
        '广西': '广西壮族自治区',
        '西藏': '西藏自治区',
        '宁夏': '宁夏回族自治区',
        '新疆': '新疆维吾尔自治区',
        '香港': '香港特别行政区',
        '澳门': '澳门特别行政区'
    };
    
    // 确保每个数据项都有正确的 name 和 value，并转换省份名称
    geoData = geoData.map(item => {
        if (typeof item === 'object' && item !== null) {
            // 使用映射转换省份名称
            const provinceName = item.name || '';
            const mappedName = provinceNameMap[provinceName] || provinceName;
            
            return {
                name: mappedName,
                value: parseInt(item.value) || 0
            };
        }
        return null;
    }).filter(item => item !== null);
    
    // 如果没有数据，使用默认数据
    if (geoData.length === 0) {
        geoData = [
            {name: '北京市', value: 20},
            {name: '天津市', value: 10},
            {name: '河北省', value: 12},
            {name: '山西省', value: 8},
            {name: '内蒙古自治区', value: 5},
            {name: '辽宁省', value: 15},
            {name: '吉林省', value: 7},
            {name: '黑龙江省', value: 9},
            {name: '上海市', value: 25},
            {name: '江苏省', value: 18},
            {name: '浙江省', value: 20},
            {name: '安徽省', value: 11},
            {name: '福建省', value: 13},
            {name: '江西省', value: 8},
            {name: '山东省', value: 16},
            {name: '河南省', value: 14},
            {name: '湖北省', value: 12},
            {name: '湖南省', value: 11},
            {name: '广东省', value: 30},
            {name: '广西壮族自治区', value: 9},
            {name: '海南省', value: 5},
            {name: '重庆市', value: 15},
            {name: '四川省', value: 17},
            {name: '贵州省', value: 6},
            {name: '云南省', value: 8},
            {name: '西藏自治区', value: 2},
            {name: '陕西省', value: 10},
            {name: '甘肃省', value: 5},
            {name: '青海省', value: 3},
            {name: '宁夏回族自治区', value: 3},
            {name: '新疆维吾尔自治区', value: 4}
        ];
    }
    
    // 将转换后的数据打印到控制台，方便调试
    console.log('处理后的地理分布数据:', geoData);
    
    // 计算最大值，避免除以0
    const maxValue = Math.max(...geoData.map(item => item.value)) || 1;
    
    // 初始化 ECharts 实例
    const chartDom = document.getElementById('userGeographicChart');
    const myChart = echarts.init(chartDom);
    
    // 使用 fetch API 加载中国地图数据
    fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
        .then(response => response.json())
        .then(chinaJson => {
            echarts.registerMap('china', chinaJson);
            
            const option = {
                title: {
                    text: '用户地理分布热力图',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const value = params.value || 0;
                        return `${params.name}: ${value}人`;
                    }
                },
                visualMap: {
                    min: 0,
                    max: maxValue,
                    left: 'left',
                    top: 'bottom',
                    text: ['高', '低'],
                    calculable: true,
                    inRange: {
                        color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                    }
                },
                series: [{
                    name: '用户数量',
                    type: 'map',
                    map: 'china',
                    roam: true,
                    emphasis: {
                        label: {
                            show: true
                        }
                    },
                    data: geoData,
                    itemStyle: {
                        borderColor: '#999',
                        borderWidth: 1,
                        areaColor: '#f3f3f3'
                    }
                }]
            };
            
            myChart.setOption(option);
        })
        .catch(error => {
            console.error('加载地图数据失败:', error);
            showToast('加载地图数据失败，请刷新页面重试', 'error');
        });
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        myChart.resize();
    });
}

// 初始化标签云图表
function initTagsChart() {
    // 从后端获取标签数据
    let tagsData = JSON.parse('{{ analytics_data.user_tags | default([]) | tojson | safe }}');
    
    // 数据格式检查和转换
    if (!Array.isArray(tagsData)) {
        tagsData = [];
        console.error('标签数据格式错误');
    }
    
    // 转换数据为词云所需格式
    const wordCloudData = tagsData.map(item => {
        return {
            name: item.name,
            value: item.count,
            // 随机颜色，增加视觉效果
            textStyle: {
                color: 'rgb(' + [
                    Math.round(Math.random() * 160 + 60),
                    Math.round(Math.random() * 160 + 60),
                    Math.round(Math.random() * 160 + 60)
                ].join(',') + ')'
            }
        };
    });
    
    // 初始化 ECharts 实例
    const chartDom = document.getElementById('userTagsChart');
    const myChart = echarts.init(chartDom);
    
    const option = {
        series: [{
            type: 'wordCloud',
            shape: 'circle',
            left: 0,
            top: 0,
            width: '100%',
            height: '100%',
            // 减小网格大小，使词语更密集
            gridSize: 4,
            // 减小词语大小范围，使小标签也能显示
            sizeRange: [8, 30],
            // 修改旋转角度范围，使布局更紧凑
            rotationRange: [-45, 45],
            rotationStep: 15,
            // 允许词语超出画布边界，以显示更多词语
            drawOutOfBound: true,
            // 是否开启布局动画
            layoutAnimation: true,
            // 设置全局文字样式
            textStyle: {
                fontFamily: 'sans-serif',
                fontWeight: 'normal',
                color: function () {
                    return 'rgb(' + 
                        Math.round(Math.random() * 160 + 60) + ',' + 
                        Math.round(Math.random() * 160 + 60) + ',' + 
                        Math.round(Math.random() * 160 + 60) + ')';
                }
            },
            emphasis: {
                textStyle: {
                    fontWeight: 'bold',
                    shadowBlur: 10,
                    shadowColor: '#333'
                }
            },
            // 设置全局缩放
            global: {
                scale: 0.8
            },
            data: wordCloudData.length > 0 ? wordCloudData : [
                { name: '安全出行', value: 18 },
                { name: '舒适体验', value: 15 },
                { name: '智能服务', value: 10 },
                { name: '便捷出行', value: 20 },
                { name: '无人驾驶', value: 25 },
                { name: '城市出行', value: 12 },
                { name: '科技爱好者', value: 15 },
                { name: '低碳环保', value: 19 },
                { name: '商务人士', value: 18 },
                { name: '学生群体', value: 17 },
                { name: '老年服务', value: 8 },
                { name: '社区出行', value: 9 },
                { name: '机场接送', value: 14 },
                { name: '火车站接送', value: 12 },
                { name: '节假日出行', value: 13 },
                { name: '夜间出行', value: 10 },
                { name: '医院出行', value: 11 },
                { name: '购物出行', value: 16 },
                { name: '长途旅行', value: 7 },
                { name: '高频用户', value: 22 }
            ]
        }]
    };
    
    myChart.setOption(option);
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        myChart.resize();
    });
}

// 初始化用户使用时段分布图表
function initUserTimeChart() {
    // 从后端获取用户使用时段数据
    let timeDistributionData = JSON.parse('{{ analytics_data.time_distribution | default({}) | tojson | safe }}');
    
    // 默认数据（如果后端未提供）
    const defaultHours = ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', 
                          '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'];
    
    // 如果后端数据不完整或格式不正确，使用默认数据
    if (!timeDistributionData || !timeDistributionData.hours || !timeDistributionData.weekday_counts || !timeDistributionData.weekend_counts) {
        timeDistributionData = {
            hours: defaultHours,
            weekday_counts: [15, 8, 5, 3, 2, 5, 12, 35, 60, 45, 40, 55, 70, 50, 45, 50, 65, 85, 90, 75, 60, 50, 35, 20],
            weekend_counts: [25, 18, 12, 8, 5, 3, 8, 15, 25, 40, 55, 65, 75, 70, 65, 70, 75, 80, 85, 90, 80, 70, 55, 35]
        };
    }
    
    // 初始化Chart.js图表
    const ctx = document.getElementById('userTimeChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timeDistributionData.hours,
            datasets: [
                {
                    label: '工作日',
                    data: timeDistributionData.weekday_counts,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                },
                {
                    label: '周末',
                    data: timeDistributionData.weekend_counts,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                },
                title: {
                    display: true,
                    text: '用户一天中使用时段分布'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '订单数量'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '时间段'
                    }
                }
            }
        }
    });
}

// 初始化用户消费能力分析图表
function initUserConsumptionChart() {
    // 从后端获取用户消费能力数据
    let consumptionData = JSON.parse('{{ analytics_data.consumption_data | default({}) | tojson | safe }}');
    
    // 默认数据（如果后端未提供）
    if (!consumptionData || !consumptionData.labels || !consumptionData.average_trip || !consumptionData.trip_frequency) {
        consumptionData = {
            labels: ['低消费群体', '中低消费群体', '中等消费群体', '中高消费群体', '高消费群体'],
            average_trip: [15.5, 25.8, 38.2, 65.4, 120.6],
            trip_frequency: [1.2, 2.5, 4.8, 8.2, 12.5],
            user_percentage: [45, 25, 18, 8, 4]
        };
    }
    
    // 计算气泡大小（基于用户百分比）
    const bubbleSizes = consumptionData.user_percentage.map(p => p * 3);
    
    // 准备数据
    const data = [];
    for (let i = 0; i < consumptionData.labels.length; i++) {
        data.push({
            x: consumptionData.trip_frequency[i],
            y: consumptionData.average_trip[i],
            r: bubbleSizes[i],
            label: consumptionData.labels[i],
            percentage: consumptionData.user_percentage[i]
        });
    }
    
    // 初始化Chart.js图表
    const ctx = document.getElementById('userConsumptionChart').getContext('2d');
    new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: '用户消费群体',
                data: data,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(255, 99, 132, 0.7)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const dataPoint = context.raw;
                            return [
                                `${dataPoint.label}`,
                                `月均订单次数: ${dataPoint.x.toFixed(1)}次`,
                                `平均单次消费: ${dataPoint.y.toFixed(1)}元`,
                                `用户占比: ${dataPoint.percentage}%`
                            ];
                        }
                    }
                },
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: '用户消费能力分析'
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: '平均单次消费(元)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '月均订单次数'
                    }
                }
            }
        }
    });
}

// 浮动提示框函数
function showToast(message, category = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `custom-toast toast-${category}`;
    toast.innerHTML = message;
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
            if (toast.parentNode === toastContainer) {
                toastContainer.removeChild(toast);
            }
        }, 500);
    }, duration);
}
</script>
{% endblock %}