{% extends "base.html" %}

{% block title %}编辑障碍物 - 无人驾驶出租车管理平台{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>编辑障碍物</h2>
            <p class="text-muted">修改障碍物信息</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('map_obstacles.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> 返回障碍物地图
            </a>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <i class="bi bi-pencil me-1"></i> 障碍物详情
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('map_obstacles.edit', obstacle_id=obstacle.id) }}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">障碍物名称</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ data.name if data else obstacle.name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="city_code" class="form-label">所在城市</label>
                        <select class="form-select" id="city_code" name="city_code" required>
                            <option value="">选择城市</option>
                            <option value="shenyang" {% if (data and data.city_code == 'shenyang') or (not data and obstacle.city_code == 'shenyang') %}selected{% endif %}>沈阳市</option>
                            <option value="beijing" {% if (data and data.city_code == 'beijing') or (not data and obstacle.city_code == 'beijing') %}selected{% endif %}>北京市</option>
                            <option value="shanghai" {% if (data and data.city_code == 'shanghai') or (not data and obstacle.city_code == 'shanghai') %}selected{% endif %}>上海市</option>
                            <option value="guangzhou" {% if (data and data.city_code == 'guangzhou') or (not data and obstacle.city_code == 'guangzhou') %}selected{% endif %}>广州市</option>
                            <option value="shenzhen" {% if (data and data.city_code == 'shenzhen') or (not data and obstacle.city_code == 'shenzhen') %}selected{% endif %}>深圳市</option>
                            <option value="hangzhou" {% if (data and data.city_code == 'hangzhou') or (not data and obstacle.city_code == 'hangzhou') %}selected{% endif %}>杭州市</option>
                            <option value="nanjing" {% if (data and data.city_code == 'nanjing') or (not data and obstacle.city_code == 'nanjing') %}selected{% endif %}>南京市</option>
                            <option value="chengdu" {% if (data and data.city_code == 'chengdu') or (not data and obstacle.city_code == 'chengdu') %}selected{% endif %}>成都市</option>
                            <option value="chongqing" {% if (data and data.city_code == 'chongqing') or (not data and obstacle.city_code == 'chongqing') %}selected{% endif %}>重庆市</option>
                            <option value="wuhan" {% if (data and data.city_code == 'wuhan') or (not data and obstacle.city_code == 'wuhan') %}selected{% endif %}>武汉市</option>
                            <option value="xian" {% if (data and data.city_code == 'xian') or (not data and obstacle.city_code == 'xian') %}selected{% endif %}>西安市</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label for="obstacle_type" class="form-label">障碍物类型</label>
                        <select class="form-select" id="obstacle_type" name="obstacle_type" required>
                            <option value="">选择类型</option>
                            <option value="barrier" {% if (data and data.obstacle_type == 'barrier') or (not data and obstacle.obstacle_type == 'barrier') %}selected{% endif %}>障碍墙</option>
                            <option value="restricted" {% if (data and data.obstacle_type == 'restricted') or (not data and obstacle.obstacle_type == 'restricted') %}selected{% endif %}>限制区域</option>
                            <option value="construction" {% if (data and data.obstacle_type == 'construction') or (not data and obstacle.obstacle_type == 'construction') %}selected{% endif %}>施工区域</option>
                            <option value="one_way" {% if (data and data.obstacle_type == 'one_way') or (not data and obstacle.obstacle_type == 'one_way') %}selected{% endif %}>单行道</option>
                            <option value="speed_limit" {% if (data and data.obstacle_type == 'speed_limit') or (not data and obstacle.obstacle_type == 'speed_limit') %}selected{% endif %}>限速区域</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="geometry_type" class="form-label">几何形状类型</label>
                        <select class="form-select" id="geometry_type" name="geometry_type" required>
                            <option value="polygon" {% if (data and data.geometry_type == 'polygon') or (not data and obstacle.geometry_type == 'polygon') %}selected{% endif %}>多边形</option>
                            <option value="line" {% if (data and data.geometry_type == 'line') or (not data and obstacle.geometry_type == 'line') %}selected{% endif %}>线段</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label for="color" class="form-label">显示颜色</label>
                        <input type="color" class="form-control form-control-color" id="color" name="color" value="{{ data.color if data else obstacle.color }}" title="选择颜色">
                    </div>
                    <div class="col-md-6" id="widthField">
                        <label for="width" class="form-label">线宽 (仅线段有效)</label>
                        <input type="number" class="form-control" id="width" name="width" min="1" max="10" step="0.5" value="{{ data.width if data else obstacle.width }}">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <label for="polygon_points" class="form-label">坐标点</label>
                        <textarea class="form-control" id="polygon_points" name="polygon_points" rows="5" required>{{ data.polygon_points if data else obstacle.polygon_points }}</textarea>
                        <div class="form-text" id="pointsHelp">
                            <p>格式说明：</p>
                            <ul>
                                <li>多边形：每行一个坐标点，格式为"x,y"，如：<code>100,200</code>，至少需要3个点</li>
                                <li>线段：每行一个坐标点，格式为"x,y"，如：<code>100,200</code>，至少需要2个点</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" value="1" 
                                {% if (data and data.is_active) or (not data and obstacle.is_active) %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">启用障碍物</label>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">保存更改</button>
                    <a href="{{ url_for('map_obstacles.index') }}" class="btn btn-outline-secondary">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 地图预览 -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-map me-1"></i> 地图预览
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 提示：您可以在障碍物地图页面上更直观地创建和编辑障碍物。此表单适用于手动调整坐标点等精细操作。
        </div>
        <div class="map-preview-container" style="position: relative; overflow: auto;">
            <div style="position: relative; width: 1000px; height: 1000px; margin: 0 auto;">
                <img id="cityMapImage" src="{{ url_for('static', filename='images/') }}{{ obstacle.city_code }}.png" style="position: absolute; top: 0; left: 0; width: 1000px; height: 1000px; object-fit: cover; z-index: 10;">
                <div id="obstaclePreview" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 处理几何类型变更
        const geometryType = document.getElementById('geometry_type');
        const pointsHelp = document.getElementById('pointsHelp');
        const widthField = document.getElementById('widthField');
        
        function updateFormBasedOnGeometryType() {
            const isLine = geometryType.value === 'line';
            
            // 调整宽度字段的可见性
            widthField.style.display = isLine ? 'block' : 'none';
            
            // 更新帮助文本
            if (isLine) {
                pointsHelp.innerHTML = `
                    <p>线段格式说明：</p>
                    <ul>
                        <li>每行一个坐标点，格式为"x,y"，如：<code>100,200</code></li>
                        <li>至少需要2个点形成一条线</li>
                        <li>示例：<pre>100,100\n200,200\n300,300</pre></li>
                    </ul>
                `;
            } else {
                pointsHelp.innerHTML = `
                    <p>多边形格式说明：</p>
                    <ul>
                        <li>每行一个坐标点，格式为"x,y"，如：<code>100,200</code></li>
                        <li>至少需要3个点形成一个多边形</li>
                        <li>示例：<pre>100,100\n200,100\n200,200\n100,200</pre></li>
                    </ul>
                `;
            }
            
            // 更新预览
            updateObstaclePreview();
        }
        
        // 初始化表单
        updateFormBasedOnGeometryType();
        
        // 监听几何类型变更
        geometryType.addEventListener('change', updateFormBasedOnGeometryType);
        
        // 监听坐标点变更
        document.getElementById('polygon_points').addEventListener('input', updateObstaclePreview);
        document.getElementById('color').addEventListener('input', updateObstaclePreview);
        document.getElementById('width').addEventListener('input', updateObstaclePreview);
        
        // 更新预览
        function updateObstaclePreview() {
            const previewContainer = document.getElementById('obstaclePreview');
            const pointsText = document.getElementById('polygon_points').value;
            const color = document.getElementById('color').value;
            const width = document.getElementById('width').value;
            const type = geometryType.value;
            
            // 清除现有预览
            previewContainer.innerHTML = '';
            
            // 解析坐标点
            const points = pointsText.split(/[\n,]+/).map(p => parseInt(p.trim())).filter(p => !isNaN(p));
            
            if (points.length < 2) return;
            
            if (type === 'line') {
                // 绘制线段
                for (let i = 0; i < points.length - 2; i += 2) {
                    const x1 = points[i];
                    const y1 = points[i + 1];
                    const x2 = points[i + 2];
                    const y2 = points[i + 3];
                    
                    // 计算线段
                    const dx = x2 - x1;
                    const dy = y2 - y1;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx);
                    
                    // 创建线段
                    const line = document.createElement('div');
                    line.style.position = 'absolute';
                    line.style.left = `${x1}px`;
                    line.style.top = `${y1}px`;
                    line.style.width = `${length}px`;
                    line.style.height = `${width}px`;
                    line.style.backgroundColor = color;
                    line.style.transform = `rotate(${angle}rad)`;
                    line.style.transformOrigin = '0 50%';
                    line.style.zIndex = '100';
                    
                    previewContainer.appendChild(line);
                }
            } else {
                // 绘制多边形
                if (points.length < 6) return; // 至少需要3个点
                
                // 计算多边形的边界
                let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
                for (let i = 0; i < points.length; i += 2) {
                    minX = Math.min(minX, points[i]);
                    maxX = Math.max(maxX, points[i]);
                    minY = Math.min(minY, points[i + 1]);
                    maxY = Math.max(maxY, points[i + 1]);
                }
                
                // 创建多边形
                const polygon = document.createElement('div');
                polygon.style.position = 'absolute';
                polygon.style.left = `${minX}px`;
                polygon.style.top = `${minY}px`;
                polygon.style.width = `${maxX - minX}px`;
                polygon.style.height = `${maxY - minY}px`;
                polygon.style.backgroundColor = color.replace(/[^,]+(?=\))/, '0.3');
                polygon.style.border = `2px solid ${color.replace(/[^,]+(?=\))/, '0.7')}`;
                polygon.style.zIndex = '100';
                
                // 使用clip-path创建精确形状
                let clipPath = 'polygon(';
                for (let i = 0; i < points.length; i += 2) {
                    const x = points[i] - minX;
                    const y = points[i + 1] - minY;
                    clipPath += `${x}px ${y}px, `;
                }
                clipPath = clipPath.slice(0, -2) + ')';
                polygon.style.clipPath = clipPath;
                
                previewContainer.appendChild(polygon);
            }
        }
        
        // 初始化预览
        updateObstaclePreview();
    });
</script>
{% endblock %} 