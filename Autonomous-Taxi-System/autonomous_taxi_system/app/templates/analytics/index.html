{% extends "base.html" %}

{% block title %}数据分析 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications/notifications.css') }}">
<style>
    /* 标签页样式 */
    #analytics-tab .nav-link {
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        border-radius: 0;
        border-bottom: 3px solid transparent;
    }

    #analytics-tab .nav-link.active {
        border-bottom: 3px solid #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }

    #analytics-tab .nav-link:hover:not(.active) {
        background-color: rgba(0, 0, 0, 0.03);
        border-bottom: 3px solid #dee2e6;
    }

    /* 标签页内容区域样式 */
    .tab-content {
        padding-top: 20px;
    }

    /* 标签页图标样式 */
    #analytics-tab .nav-link i {
        font-size: 1.1rem;
    }

    /* 标签页特定颜色 */
    #vehicle-efficiency-tab.active { border-bottom-color: #0d6efd !important; background-color: rgba(13, 110, 253, 0.1) !important; color: #0d6efd !important; }
    #charging-battery-tab.active { border-bottom-color: #198754 !important; background-color: rgba(25, 135, 84, 0.1) !important; color: #198754 !important; }
    #vehicle-maintenance-tab.active { border-bottom-color: #dc3545 !important; background-color: rgba(220, 53, 69, 0.1) !important; color: #dc3545 !important; }
    #order-service-tab.active { border-bottom-color: #fd7e14 !important; background-color: rgba(253, 126, 20, 0.1) !important; color: #fd7e14 !important; }
    #service-quality-tab.active { border-bottom-color: #6610f2 !important; background-color: rgba(102, 16, 242, 0.1) !important; color: #6610f2 !important; }
    #user-marketing-tab.active { border-bottom-color: #6f42c1 !important; background-color: rgba(111, 66, 193, 0.1) !important; color: #6f42c1 !important; }
    #finance-health-tab.active { border-bottom-color: #20c997 !important; background-color: rgba(32, 201, 151, 0.1) !important; color: #20c997 !important; }
    
    /* 保留原有卡片样式 */
    .metric-card {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        height: 100%;
        cursor: help;
    }
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .metric-card-content {
        display: flex;
        padding: 15px;
    }
    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .metric-icon i {
        font-size: 1.8rem;
        color: white;
    }
    .metric-info {
        flex-grow: 1;
    }
    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .metric-trend {
        font-size: 0.8rem;
        margin-top: 5px;
    }
    .metric-tooltip {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0,0,0,0.85);
        color: white;
        padding: 10px;
        font-size: 0.85rem;
        transform: translateY(101%); /* 改为101%确保完全隐藏 */
        transition: transform 0.3s;
        z-index: 100;
        visibility: hidden; /* 完全隐藏元素 */
        opacity: 0; /* 设置透明度为0 */
        transition: transform 0.3s, visibility 0.3s, opacity 0.3s; /* 添加过渡效果 */
    }
    .metric-card:hover .metric-tooltip {
        transform: translateY(0);
        visibility: visible; /* 悬停时显示 */
        opacity: 1; /* 悬停时完全不透明 */
    }
    .category-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    /* 日期范围选择器样式 */
    .date-range-container {
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .date-range-container label {
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    .date-btn {
        min-width: 100px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="mb-4">数据分析</h2>
            <p class="text-muted mb-3">分析平台运营数据，挖掘业务洞察，提供决策支持</p>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group" aria-label="数据分析导航">
                <a href="{{ url_for('analytics.finance_statistics') }}" class="btn btn-outline-primary">
                    <i class="bi bi-currency-exchange"></i> 财务统计
                </a>
                <a href="{{ url_for('analytics.vehicle_statistics') }}" class="btn btn-outline-primary">
                    <i class="bi bi-taxi-front-fill"></i> 车辆统计
                </a>
                <a href="{{ url_for('analytics.user_statistics') }}" class="btn btn-outline-primary">
                    <i class="bi bi-people"></i> 用户统计
                </a>
            </div>
        </div>
    </div>

    <!-- Toast容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container"></div>

    <!-- 日期范围选择器 -->
    <div class="date-range-container">
        <form id="date-range-form" method="get" class="row g-3 align-items-end">
            <div class="col-md-3 col-sm-6">
                <label for="date-range">日期范围</label>
                <select class="form-select" id="date-range" name="date_range">
                    <option value="last_3_days">最近3天</option>
                    <option value="last_7_days">最近7天</option>
                    <option value="last_30_days" selected>最近30天</option>
                    <option value="last_90_days">最近90天</option>
                    <option value="last_180_days">最近180天</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <div class="col-md-3 col-sm-6">
                <label for="start-date">开始日期</label>
                <input type="date" class="form-control" id="start-date" name="start_date" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-3 col-sm-6">
                <label for="end-date">结束日期</label>
                <input type="date" class="form-control" id="end-date" name="end_date" value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-3 col-sm-6 d-flex gap-2">
                <button type="submit" class="btn btn-primary date-btn">应用筛选</button>
                <button type="button" id="reset-date" class="btn btn-secondary date-btn">重置</button>
            </div>
        </form>
    </div>

    <!-- 标签页导航 -->
    <ul class="nav nav-pills mb-4" id="analytics-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="vehicle-efficiency-tab" href="{{ url_for('analytics.vehicle_efficiency', start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', ''), date_range=request.args.get('date_range', 'last_30_days')) }}">
                <i class="bi bi-speedometer2 me-2"></i>车辆运营效率
            </a>
        </li>
        
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="charging-battery-tab" href="{{ url_for('analytics.charging_battery', start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', ''), date_range=request.args.get('date_range', 'last_30_days')) }}">
                <i class="bi bi-battery-charging me-2"></i>充电和电池管理
            </a>
        </li>

        <li class="nav-item" role="presentation">
            <a class="nav-link" id="vehicle-maintenance-tab" href="{{ url_for('analytics.vehicle_maintenance', start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', ''), date_range=request.args.get('date_range', 'last_30_days')) }}">
                <i class="bi bi-tools me-2"></i>车辆维护
            </a>
        </li>
        
        
        
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="service-quality-tab" href="{{ url_for('analytics.service_quality', start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', ''), date_range=request.args.get('date_range', 'last_30_days')) }}">
                <i class="bi bi-award me-2"></i>服务质量分析
            </a>
        </li>
        
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="user-marketing-tab" href="{{ url_for('analytics.user_marketing', start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', ''), date_range=request.args.get('date_range', 'last_30_days')) }}">
                <i class="bi bi-graph-up-arrow me-2"></i>用户行为和营销
            </a>
        </li>
        
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="finance-health-tab" href="{{ url_for('analytics.finance_health', start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', ''), date_range=request.args.get('date_range', 'last_30_days')) }}">
                <i class="bi bi-heart-pulse me-2"></i>财务和整体健康
            </a>
        </li>
    </ul>

    <!-- 标签页内容 -->
    <div class="tab-content p-4 bg-white rounded shadow-sm" id="analytics-tabContent">
        <!-- 主内容区域 -->
        <div class="p-3">
            {% block content_area %}
            <!-- 此处将被继承的模板替换 -->
            {% endblock %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 显示Toast消息
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'warning' ? 'bg-warning' : 'bg-danger';
        
        const toast = `
            <div id="${toastId}" class="toast align-items-center ${bgClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toast);
        const toastElement = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastElement, {
            animation: true,
            autohide: true,
            delay: 3000
        });
        bsToast.show();
    }

    // 设置当前页面的标签高亮
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // 根据当前URL路径来判断哪个标签应该高亮
            const currentPath = window.location.pathname;
            
            // 默认激活车辆运营效率标签
            let activeTabId = 'vehicle-efficiency-tab';
            
            // 根据URL路径判断激活哪个标签
            if (currentPath.includes('/charging_battery')) {
                activeTabId = 'charging-battery-tab';
            } else if (currentPath.includes('/vehicle_maintenance')) {
                activeTabId = 'vehicle-maintenance-tab';
            } else if (currentPath.includes('/order_service')) {
                activeTabId = 'order-service-tab';
            } else if (currentPath.includes('/service_quality') || currentPath.includes('/service-quality')) {
                activeTabId = 'service-quality-tab';
            } else if (currentPath.includes('/user_marketing') || currentPath.includes('/user-marketing')) {
                activeTabId = 'user-marketing-tab';
            } else if (currentPath.includes('/finance_health') || currentPath.includes('/financial-health')) {
                activeTabId = 'finance-health-tab';
            }
            
            // 移除所有标签的active类
            document.querySelectorAll('#analytics-tab .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 为当前激活的标签添加active类
            const activeTab = document.getElementById(activeTabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // 日期范围选择器逻辑
            const dateRangeSelect = document.getElementById('date-range');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const resetButton = document.getElementById('reset-date');
            const dateForm = document.getElementById('date-range-form');
            
            // 根据URL参数设置初始值
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('date_range')) {
                dateRangeSelect.value = urlParams.get('date_range');
                
                // 如果是自定义日期范围，确保显示日期输入框
                if (urlParams.get('date_range') === 'custom') {
                    startDateInput.parentElement.style.display = 'block';
                    endDateInput.parentElement.style.display = 'block';
                }
            }
            
            if (urlParams.has('start_date') && urlParams.has('end_date')) {
                startDateInput.value = urlParams.get('start_date');
                endDateInput.value = urlParams.get('end_date');
                
                // 如果URL中明确指定了date_range参数，则使用该值
                if (urlParams.has('date_range')) {
                    dateRangeSelect.value = urlParams.get('date_range');
                } else {
                    // 否则尝试根据日期差值判断
                    const start = new Date(urlParams.get('start_date'));
                    const end = new Date(urlParams.get('end_date'));
                    const diffDays = Math.round((end - start) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 2) { // 3天范围（因为包含开始和结束日，所以差值是2）
                        dateRangeSelect.value = 'last_3_days';
                    } else if (diffDays === 6) { // 7天范围
                        dateRangeSelect.value = 'last_7_days';
                    } else if (diffDays === 29) { // 30天范围
                        dateRangeSelect.value = 'last_30_days';
                    } else if (diffDays === 89) { // 90天范围
                        dateRangeSelect.value = 'last_90_days';
                    } else if (diffDays === 179) { // 180天范围
                        dateRangeSelect.value = 'last_180_days';
                    } else {
                        dateRangeSelect.value = 'custom';
                    }
                }
            } else {
                // 默认设置日期为最近30天
                if (!startDateInput.value || !endDateInput.value) {
                    const today = new Date();
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    
                    endDateInput.value = today.toISOString().split('T')[0];
                    startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                }
            }
            
            // 日期范围选择变化时更新日期输入框
            dateRangeSelect.addEventListener('change', function() {
                const today = new Date();
                let startDate = new Date(today);
                
                switch(this.value) {
                    case 'last_3_days':
                        startDate.setDate(today.getDate() - 3);
                        break;
                    case 'last_7_days':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'last_30_days':
                        startDate.setDate(today.getDate() - 30);
                        break;
                    case 'last_90_days':
                        startDate.setDate(today.getDate() - 90);
                        break;
                    case 'last_180_days':
                        startDate.setDate(today.getDate() - 180);
                        break;
                    case 'custom':
                        // 自定义模式下不修改日期
                        return;
                }
                
                endDateInput.value = today.toISOString().split('T')[0];
                startDateInput.value = startDate.toISOString().split('T')[0];
            });
            
            // 表单提交前处理
            dateForm.addEventListener('submit', function(e) {
                // 无需额外处理，保留用户在界面上选择的日期范围类型
                // 删除之前可能导致日期范围变为"自定义"的逻辑
            });
            
            // 重置按钮点击事件
            resetButton.addEventListener('click', function() {
                dateRangeSelect.value = 'last_30_days';
                
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                endDateInput.value = today.toISOString().split('T')[0];
                startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                
                // 可选：自动提交表单
                document.getElementById('date-range-form').submit();
            });
            
        } catch (error) {
            console.error('Error in tab initialization:', error);
        }
    });
</script>
{% endblock %} 