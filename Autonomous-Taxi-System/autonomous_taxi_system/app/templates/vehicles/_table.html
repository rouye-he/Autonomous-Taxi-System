<!-- 车辆列表表格 -->
<div id="vehicles-table-container">
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="vehicles-table" style="text-align: center;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>车牌号</th>
                    <th>车辆型号</th>
                    <th>状态</th>
                    <th>当前位置</th>
                    <th>电量</th>
                    <th>上次维护</th>
                    <th>累计公里</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="vehicles-table-body">
                <!-- 表格内容 -->
                {% if vehicles %}
                    {% for vehicle in vehicles %}
                    <tr>
                        <td>{{ vehicle.vehicle_id }}</td>
                        <td>{{ vehicle.plate_number }}</td>
                        <td>{{ vehicle.model }}</td>
                        <td>
                            <span class="badge {{ 'bg-success' if vehicle.current_status == '空闲中' else 
                                                 'bg-primary' if vehicle.current_status == '运行中' else 
                                                 'bg-info' if vehicle.current_status == '充电中' else 
                                                 'bg-danger' if vehicle.current_status == '电量不足' else 
                                                 'bg-warning' }}">
                                {{ vehicle.current_status }}
                            </span>
                        </td>
                        <td>{{ vehicle.current_location_name or '未知' }}</td>
                        <td>
                            <div class="progress" style="height: 15px; position: relative;">
                                <div class="progress-bar {{ 'bg-danger' if vehicle.battery_level < 20 else 
                                                           'bg-warning' if vehicle.battery_level < 50 else 
                                                           'bg-success' }}" 
                                     role="progressbar" 
                                     style="width: {{ vehicle.battery_level|default(0)|int }}%;" 
                                     aria-valuenow="{{ vehicle.battery_level|default(0)|int }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                                <span style="color: #000; position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center;">{{ vehicle.battery_level|default(0)|int }}%</span>
                            </div>
                        </td>
                        <td>{{ vehicle.last_maintenance_date or '暂无记录' }}</td>
                        <td>{{ vehicle.mileage_formatted }}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm view-vehicle-btn" data-vehicle-id="{{ vehicle.vehicle_id }}" type="button">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                                <button class="btn btn-warning btn-sm edit-vehicle-btn" data-vehicle-id="{{ vehicle.vehicle_id }}" type="button">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-vehicle-btn" data-vehicle-id="{{ vehicle.vehicle_id }}" type="button">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% if vehicle.current_status == '电量不足' %}
                                <button class="btn btn-primary btn-sm rescue-vehicle-btn" data-vehicle-id="{{ vehicle.vehicle_id }}" type="button">
                                    <i class="bi bi-lightning-charge"></i>
                                </button>
                                {% endif %}
                                
                                {% if vehicle.current_status == '维护中' %}
                                <button class="btn btn-secondary btn-sm end-maintenance-btn" data-vehicle-id="{{ vehicle.vehicle_id }}" type="button">
                                    <i class="bi bi-wrench-adjustable"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-secondary btn-sm start-maintenance-btn" data-vehicle-id="{{ vehicle.vehicle_id }}" type="button">
                                    <i class="bi bi-wrench"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" class="text-center">
                        {% if search_params %}
                        <p>没有找到符合条件的车辆</p>
                        {% else %}
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载车辆数据...</p>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    {% if total_count and per_page and total_count > per_page %}
    <nav aria-label="车辆分页">
        <div class="d-flex justify-content-between align-items-center">
            <div id="vehicle-count-info">
                显示 {{ offset + 1 }} 到 {% if offset + per_page > total_count %}{{ total_count }}{% else %}{{ offset + per_page }}{% endif %} 条，共 {{ total_count }} 条
            </div>
            
            <div class="d-flex align-items-center">
                {% set current_page = current_page|default(1)|int %}
                {% set total_pages = ((total_count + per_page - 1) // per_page) %}
                
                <ul class="pagination pagination-sm mb-0" id="vehicle-pagination">
                    <!-- 复制查询参数，但不包括page参数 -->
                    {% set args = request.args.copy() %}
                    {% if 'page' in args %}
                        {% set _ = args.pop('page') %}
                    {% endif %}
                    
                    <!-- 首页 -->
                    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=1, **args) }}" aria-label="首页">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    
                    <!-- 上一页 -->
                    <li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=current_page-1, **args) if current_page > 1 else '#' }}" aria-label="上一页">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    <!-- 页码 -->
                    {% for page_num in range(1, total_pages + 1) %}
                        {% if page_num == 1 or page_num == total_pages or (page_num >= current_page-1 and page_num <= current_page+1) %}
                            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for(request.endpoint, page=page_num, **args) }}">{{ page_num }}</a>
                            </li>
                        {% elif page_num == 2 or page_num == total_pages - 1 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 下一页 -->
                    <li class="page-item {% if current_page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=current_page+1, **args) if current_page < total_pages else '#' }}" aria-label="下一页">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    
                    <!-- 末页 -->
                    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=total_pages, **args) }}" aria-label="末页">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                </ul>
                
                <!-- 页码跳转 -->
                <div class="input-group input-group-sm ms-2" style="width: 120px;">
                    <input type="number" class="form-control" id="pageJumpInput" min="1" max="{{ total_pages }}" placeholder="{{ current_page }}/{{ total_pages }}">
                    <button class="btn btn-outline-secondary" type="button" onclick="pageTableJump()">跳转</button>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- 搜索结果统计 -->
    {% if search_params and total_count %}
    <div class="mt-3 text-center text-muted">
        <p><i class="bi bi-filter-circle"></i> 共筛选出 <strong>{{ total_count }}</strong> 条符合条件的车辆记录</p>
    </div>
    {% endif %}
</div>

<style>
    /* 隐藏进度条中的原始文本 */
    .progress-bar {
        color: transparent !important;
        font-size: 0 !important;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    .action-buttons .btn {
        padding: 3px 7px;
        font-size: 12px;
    }
</style> 