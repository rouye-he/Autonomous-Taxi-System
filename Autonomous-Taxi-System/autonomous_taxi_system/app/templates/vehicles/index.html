{% extends "base.html" %}

{% block title %}车辆管理 - 无人驾驶出租车管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/vehicles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications/notifications.css') }}">
<style>
    /* 确保紫色背景样式 */
    .bg-purple {
        background-color: #6f42c1 !important;
        color: #ffffff !important;
    }
    
    /* 紫色按钮样式 */
    .btn-purple {
        background-color: #6f42c1 !important;
        color: #ffffff !important;
        border-color: #6f42c1 !important;
    }
    
    .btn-purple:hover, .btn-purple:focus {
        background-color: #5a37a0 !important;
        border-color: #5a37a0 !important;
        color: #ffffff !important;
    }
    
    /* 分页控件修复样式 */
    .pagination-sm {
        display: flex !important;
    }
    
    .page-item {
        margin: 0 2px;
    }
    
    .page-link {
        border-radius: 3px;
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    
    .vehicles-table-container nav {
        margin-top: 15px;
    }
    
    /* 搜索标签样式 */
    .search-tags {
        margin-bottom: 15px;
    }
    
    .search-tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 4px;
        padding: 4px 10px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 13px;
    }
    
    .search-tag .badge {
        margin-left: 5px;
        cursor: pointer;
    }
    
    /* 搜索区域样式 */
    .search-section {
        margin-bottom: 20px;
    }
    
    .search-toggle {
        cursor: pointer;
        user-select: none;
    }
    
    .search-form {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
        margin-top: 10px;
    }
    
    .highlight-update {
        animation: highlight-fade 1s;
    }
    
    @keyframes highlight-fade {
        0% {
            background-color: rgba(255, 243, 205, 0.5);
        }
        100% {
            background-color: transparent;
        }
    }
    
    .vehicles-table-container {
        transition: background-color 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 添加Toast消息容器在页面顶部 -->
    <div id="toast-container"></div>
    
    <div class="row mb-4">
        <div class="col">
            <h2>车辆管理</h2>
            <p class="text-muted">监控和管理无人驾驶车辆的运行状态和维护情况</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('vehicles.add_vehicle') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 添加车辆
            </a>
            
            <a href="{{ url_for('vehicles.add_charging_station') }}" class="btn btn-success">
                <i class="bi bi-lightning-charge"></i> 添加充电站
            </a>
            
            <a href="{{ url_for('vehicles.map_view') }}" class="btn btn-info">
                <i class="bi bi-map"></i> 地图视图
            </a>
            
            <a href="{{ url_for('vehicles.vehicle_logs') }}" class="btn btn-secondary">
                <i class="bi bi-journal-text"></i> 车辆操作记录
            </a>
            
            <a href="{{ url_for('vehicles.data_analysis') }}" class="btn btn-purple">
                <i class="bi bi-bar-chart-line"></i> 数据分析
            </a>
        </div>
    </div>

    <!-- 车辆状态统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-primary">
                        <i class="bi bi-taxi-front-fill"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count" id="totalVehicleCount">{{ status_counts.all }}</div>
                        <div class="notification-label">全部车辆</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-success">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count" id="idleVehicleCount">{{ status_counts.idle }}</div>
                        <div class="notification-label">空闲车辆</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-info">
                        <i class="bi bi-arrow-right-circle"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count" id="busyVehicleCount">{{ status_counts.busy }}</div>
                        <div class="notification-label">运行中</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card notification-card">
                <div class="notification-card-content">
                    <div class="notification-icon bg-warning">
                        <i class="bi bi-battery-charging"></i>
                    </div>
                    <div class="notification-info">
                        <div class="notification-count">
                            <span id="chargingVehicleCount">{{ status_counts.charging }}</span> / 
                            <span id="lowBatteryVehicleCount">{{ status_counts.low_battery }}</span> /
                            <span id="maintenanceVehicleCount">{{ status_counts.maintenance }}</span>
                        </div>
                        <div class="notification-label">充电/电量不足/维护</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏元素存储URL和搜索参数 -->
    <div style="display: none;">
        <div id="indexUrl" data-url="{{ url_for('vehicles.index') }}"></div>
        <div id="searchUrl" data-url="{{ url_for('vehicles.advanced_search') }}"></div>
        {% if search_params %}
            {% for key, value in search_params.items() %}
                <div data-search-param data-param-key="{{ key }}" data-param-value="{{ value }}"></div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- 高级搜索区域 -->
    <div class="search-section">
        <div class="d-flex align-items-center mb-2 search-toggle" id="searchToggle" data-bs-toggle="collapse" data-bs-target="#searchForm" aria-expanded="false">
            <i class="bi bi-chevron-down me-2"></i>
            <h5 class="mb-0">高级搜索</h5>
        </div>
        
        <!-- 搜索条件标签 -->
        {% if search_params %}
        <div class="search-tags">
            {% for field, value in search_params.items() %}
                {% if value and field != 'page' %}
                <span class="search-tag" data-search-param data-param-key="{{ field }}" data-param-value="{{ value }}">
                    {% if field == 'current_city' %}
                        {% set city_map = {'shenyang': '沈阳市','shanghai': '上海市', 'beijing': '北京市', 'guangzhou': '广州市', 'shenzhen': '深圳市',
                                         'hangzhou': '杭州市', 'nanjing': '南京市', 'chengdu': '成都市', 'chongqing': '重庆市',
                                         'wuhan': '武汉市', 'xian': '西安市'} %}
                        {{ field_names.get(field, field) }}: {{ city_map.get(value, value) }}
                    {% else %}
                        {{ field_names.get(field, field) }}: {{ value }}
                    {% endif %}
                    <span class="badge bg-secondary" onclick="removeSearchParam('{{ field }}')">×</span>
                </span>
                {% endif %}
            {% endfor %}
            {% if search_params %}
            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllSearchParams()">
                <i class="bi bi-x-circle"></i> 清除所有筛选
            </button>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="collapse" id="searchForm">
            <div class="search-form">
                <form id="vehicleSearchForm" method="GET" action="{{ url_for('vehicles.advanced_search') }}">
                    <div class="row g-3">
                        <!-- 添加城市和状态筛选字段 -->
                        <div class="col-md-3">
                            <label for="current_city" class="form-label">城市</label>
                            <select class="form-select" id="current_city" name="current_city">
                                <option value="">所有城市</option>
                                <option value="沈阳市" {% if search_params and search_params.current_city == '沈阳市' %}selected{% endif %}>沈阳市</option>
                                <option value="上海市" {% if search_params and search_params.current_city == '上海市' %}selected{% endif %}>上海市</option>
                                <option value="北京市" {% if search_params and search_params.current_city == '北京市' %}selected{% endif %}>北京市</option>
                                <option value="广州市" {% if search_params and search_params.current_city == '广州市' %}selected{% endif %}>广州市</option>
                                <option value="深圳市" {% if search_params and search_params.current_city == '深圳市' %}selected{% endif %}>深圳市</option>
                                <option value="杭州市" {% if search_params and search_params.current_city == '杭州市' %}selected{% endif %}>杭州市</option>
                                <option value="南京市" {% if search_params and search_params.current_city == '南京市' %}selected{% endif %}>南京市</option>
                                <option value="成都市" {% if search_params and search_params.current_city == '成都市' %}selected{% endif %}>成都市</option>
                                <option value="重庆市" {% if search_params and search_params.current_city == '重庆市' %}selected{% endif %}>重庆市</option>
                                <option value="武汉市" {% if search_params and search_params.current_city == '武汉市' %}selected{% endif %}>武汉市</option>
                                <option value="西安市" {% if search_params and search_params.current_city == '西安市' %}selected{% endif %}>西安市</option>
                                
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="current_status" class="form-label">状态</label>
                            <select class="form-select" id="current_status" name="current_status">
                                <option value="">全部状态</option>
                                <option value="空闲中" {% if search_params and search_params.current_status == '空闲中' %}selected{% endif %}>空闲中</option>
                                <option value="运行中" {% if search_params and search_params.current_status == '运行中' %}selected{% endif %}>运行中</option>
                                <option value="充电中" {% if search_params and search_params.current_status == '充电中' %}selected{% endif %}>充电中</option>
                                <option value="电量不足" {% if search_params and search_params.current_status == '电量不足' %}selected{% endif %}>电量不足</option>
                                <option value="维护中" {% if search_params and search_params.current_status == '维护中' %}selected{% endif %}>维护中</option>
                                <option value="等待充电" {% if search_params and search_params.current_status == '等待充电' %}selected{% endif %}>等待充电</option>
                                <option value="前往充电" {% if search_params and search_params.current_status == '前往充电' %}selected{% endif %}>前往充电</option>
                            </select>
                        </div>
                        <!-- 原有字段 -->
                        <div class="col-md-3">
                            <label for="vehicle_id" class="form-label">车辆ID</label>
                            <input type="text" class="form-control" id="vehicle_id" name="vehicle_id" value="{{ search_params.vehicle_id if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="plate_number" class="form-label">车牌号</label>
                            <input type="text" class="form-control" id="plate_number" name="plate_number" value="{{ search_params.plate_number if search_params else '' }}">
                        </div>
                        <!-- 其他字段保持不变 -->
                        <div class="col-md-3">
                            <label for="vin" class="form-label">车辆识别号(VIN)</label>
                            <input type="text" class="form-control" id="vin" name="vin" value="{{ search_params.vin if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="model" class="form-label">车辆型号</label>
                            <select class="form-select" id="model" name="model">
                                <option value="">全部</option>
                               
                                <option value="Alpha-X1" {% if search_params and search_params.model == 'Alpha-X1' %}selected{% endif %}>Alpha-X1</option>
                                <option value="Alpha-Nexus" {% if search_params and search_params.model == 'Alpha-Nexus' %}selected{% endif %}>Alpha-Nexus</option>
                                <option value="Alpha-Voyager" {% if search_params and search_params.model == 'Alpha-Voyager' %}selected{% endif %}>Alpha-Voyager</option>
                                <option value="Nova-S1" {% if search_params and search_params.model == 'Nova-S1' %}selected{% endif %}>Nova-S1</option>
                                <option value="Nova-Quantum" {% if search_params and search_params.model == 'Nova-Quantum' %}selected{% endif %}>Nova-Quantum</option>
                                <option value="Nova-Pulse" {% if search_params and search_params.model == 'Nova-Pulse' %}selected{% endif %}>Nova-Pulse</option>
                                <option value="Neon-500" {% if search_params and search_params.model == 'Neon-500' %}selected{% endif %}>Neon-500</option>
                                <option value="Neon-Zero" {% if search_params and search_params.model == 'Neon-Zero' %}selected{% endif %}>Neon-Zero</option>

                                
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="battery_level_min" class="form-label">最低电量(%)</label>
                            <input type="number" class="form-control" id="battery_level_min" name="battery_level_min" min="0" max="100" value="{{ search_params.battery_level_min if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="battery_level_max" class="form-label">最高电量(%)</label>
                            <input type="number" class="form-control" id="battery_level_max" name="battery_level_max" min="0" max="100" value="{{ search_params.battery_level_max if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="mileage_min" class="form-label">最低距离</label>
                            <input type="number" class="form-control" id="mileage_min" name="mileage_min" min="0" value="{{ search_params.mileage_min if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="mileage_max" class="form-label">最高距离</label>
                            <input type="number" class="form-control" id="mileage_max" name="mileage_max" min="0" value="{{ search_params.mileage_max if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="rating_min" class="form-label">最低评分</label>
                            <input type="number" class="form-control" id="rating_min" name="rating_min" min="0" max="5" step="0.1" value="{{ search_params.rating_min if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="rating_max" class="form-label">最高评分</label>
                            <input type="number" class="form-control" id="rating_max" name="rating_max" min="0" max="5" step="0.1" value="{{ search_params.rating_max if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="total_orders_min" class="form-label">最少订单数</label>
                            <input type="number" class="form-control" id="total_orders_min" name="total_orders_min" min="0" value="{{ search_params.total_orders_min if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="total_orders_max" class="form-label">最多订单数</label>
                            <input type="number" class="form-control" id="total_orders_max" name="total_orders_max" min="0" value="{{ search_params.total_orders_max if search_params else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="is_available" class="form-label">可用状态</label>
                            <select class="form-select" id="is_available" name="is_available">
                                <option value="">全部</option>
                                <option value="1" {% if search_params and search_params.is_available == '1' %}selected{% endif %}>可用</option>
                                <option value="0" {% if search_params and search_params.is_available == '0' %}selected{% endif %}>不可用</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="manufacture_date_start" class="form-label">生产日期(开始)</label>
                            <input type="date" class="form-control" id="manufacture_date_start" name="manufacture_date_start" value="{{ search_params.manufacture_date_start if search_params else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="manufacture_date_end" class="form-label">生产日期(结束)</label>
                            <input type="date" class="form-control" id="manufacture_date_end" name="manufacture_date_end" value="{{ search_params.manufacture_date_end if search_params else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="last_maintenance_date_start" class="form-label">上次维护日期(开始)</label>
                            <input type="date" class="form-control" id="last_maintenance_date_start" name="last_maintenance_date_start" value="{{ search_params.last_maintenance_date_start if search_params else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="last_maintenance_date_end" class="form-label">上次维护日期(结束)</label>
                            <input type="date" class="form-control" id="last_maintenance_date_end" name="last_maintenance_date_end" value="{{ search_params.last_maintenance_date_end if search_params else '' }}">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <i class="bi bi-eraser"></i> 清空条件
                        </button>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">车辆列表</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            {% if vehicles %}
                                <span class="text-muted">显示 {{ offset + 1 }} - {{ (offset + vehicles|length)|int }} 项，共 <span id="totalVehicleCount">{{ total_count|int }}</span> 项</span>
                            {% else %}
                                <span class="text-muted">暂无数据</span>
                            {% endif %}
                        </div>

                        {% if search_params %}
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#searchForm" aria-expanded="false">
                                <i class="bi bi-funnel"></i> 已应用筛选条件
                            </button>
                        {% endif %}
                    </div>
                    
                    <!-- 表格容器 -->
                    <div class="vehicles-table-container">
                        {% include 'vehicles/_table.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-lightning-charge"></i> 充电站状态
                    </div>
                    <div>
                        <select id="chargingStationCityFilter" class="form-select form-select-sm" style="width: auto;">
                            <option value="all">全部城市</option>
                            <!-- 城市选项将通过JavaScript动态填充 -->
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 添加记录显示统计信息 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div id="chargingStationStats">
                            <span class="text-muted">显示 <span id="csOffset">1</span> 到 <span id="csLimit">10</span> 条，共 <span id="csTotalCount">0</span> 条</span>
                        </div>
                    </div>
                    
                    <div id="chargingStationsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在加载充电站数据...</p>
                        </div>
                    </div>
                    
                    <!-- 添加分页控件 -->
                    <div class="mt-3 d-flex justify-content-end align-items-center" id="chargingStationPagination" style="display: none;">
                        <nav>
                            <div class="d-flex align-items-center">
                                <ul class="pagination mb-0 me-3" id="csPaginationList">
                                    <!-- 分页按钮将通过JavaScript动态填充 -->
                                </ul>
                                
                                <!-- 页面跳转控件 -->
                                <div class="input-group" style="width: 180px;">
                                    <span class="input-group-text">跳至</span>
                                    <input type="number" class="form-control" id="csJumpToPage" min="1" max="1" placeholder="1/1">
                                    <button class="btn btn-outline-primary" type="button" id="csJumpButton">
                                        <i class="bi bi-arrow-right-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
                </div>

<!-- 车辆详情模态框 -->
<div class="modal fade" id="vehicleDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">车辆详细信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="vehicleDetailsContent">
                    <div class="col-12 text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                确定要删除这辆车辆吗？此操作不可撤销。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 添加车辆模态框 -->
<div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVehicleModalLabel">添加新车辆</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVehicleForm" method="POST">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input class="form-control" id="plateNumber" name="plate_number" type="text" required />
                                <label for="plateNumber">车牌号</label>
                                <div class="invalid-feedback">请输入有效的车牌号</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input class="form-control" id="vin" name="vin" type="text" required />
                                <label for="vin">车辆识别号(VIN)</label>
                                <div class="invalid-feedback">请输入有效的车辆识别号</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="model" name="model" required>
                                    <option value="" selected disabled>请选择车型</option>
                                    <option value="Alpha-X1">Alpha-X1</option>
                                    <option value="Alpha-Nexus">Alpha-Nexus</option>
                                    <option value="Alpha-Voyager">Alpha-Voyager</option>
                                    <option value="Nova-S1">Nova-S1</option>
                                    <option value="Nova-Quantum">Nova-Quantum</option>
                                    <option value="Nova-Pulse">Nova-Pulse</option>
                                    <option value="Neon-500">Neon-500</option>
                                    <option value="Neon-Zero">Neon-Zero</option>

                            
                                </select>
                                <label for="model">车辆型号</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="currentCity" name="current_city" required>
                                    <option value="" selected disabled>请选择城市</option>
                                    <option value="沈阳市">沈阳市</option>
                                    <option value="上海市">上海市</option>
                                    <option value="北京市">北京市</option>
                                    <option value="广州市">广州市</option>
                                    <option value="深圳市">深圳市</option>
                                    <option value="杭州市">杭州市</option>
                                    <option value="南京市">南京市</option>
                                    <option value="成都市">成都市</option>
                                    <option value="重庆市">重庆市</option>
                                    <option value="武汉市">武汉市</option>
                                    <option value="西安市">西安市</option>
                                </select>
                                <label for="currentCity">运营城市</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input class="form-control" id="manufactureDate" name="manufacture_date" type="date" required />
                                <label for="manufactureDate">生产日期</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="currentStatus" name="current_status" required>
                                    <option value="空闲中" selected>空闲中</option>
                                    <option value="运行中">运行中</option>
                                    <option value="充电中">充电中</option>
                                    <option value="电量不足">电量不足</option>
                                    <option value="维护中">维护中</option>
                                </select>
                                <label for="currentStatus">当前状态</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input class="form-control" id="batteryLevel" name="battery_level" type="number" min="0" max="100" value="100" required />
                                <label for="batteryLevel">电量(%)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input class="form-control" id="mileage" name="mileage" type="number" min="0" step="0.1" value="0" required />
                                <label for="mileage">累计距离(公里)</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submitAddVehicle">添加车辆</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/components/dataTable.js') }}"></script>
<script src="{{ url_for('static', filename='js/vehicles/vehicle_table.js') }}"></script>
<script src="{{ url_for('static', filename='js/vehicles/vehicles.js') }}"></script>
<script>
    // 检查localStorage中是否有添加车辆或充电站成功的消息
    document.addEventListener('DOMContentLoaded', function() {
        // 检查添加车辆的成功消息
        const vehicleSuccessMessage = localStorage.getItem('vehicleAddSuccess');
        if (vehicleSuccessMessage) {
            // 显示提示消息
            showToast(vehicleSuccessMessage, 'success');
            // 删除本地存储中的消息，防止再次刷新页面时显示
            localStorage.removeItem('vehicleAddSuccess');
        }
        
        // 检查添加充电站的成功消息
        const stationSuccessMessage = localStorage.getItem('stationAddSuccess');
        if (stationSuccessMessage) {
            // 显示提示消息
            showToast(stationSuccessMessage, 'success');
            // 删除本地存储中的消息，防止再次刷新页面时显示
            localStorage.removeItem('stationAddSuccess');
        }
        
        // 确保bindTableEvents函数存在再调用
        if (typeof window.bindTableEvents === 'function') {
            // 初始化表格事件绑定
            window.bindTableEvents();
        } else {
            console.warn('bindTableEvents函数未定义，使用传统的事件绑定');
            bindTableEvents(); // 使用传统的局部函数
        }
        
        // 监听浏览器前进/后退按钮
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                // 将由vehicle_table.js中的popstate事件处理程序处理
                console.log("浏览器导航: 页码变化", event.state.page);
            } else if (event.state && event.state.cs_page) {
                // 处理充电站部分的历史记录
                if (typeof loadChargingStations === 'function') {
                    const url = new URL(window.location.href);
                    const page = url.searchParams.get('cs_page') || 1;
                    const city = url.searchParams.get('cs_city') || 'all';
                    
                    // 记住充电站容器的位置
                    const stationContainer = document.getElementById('chargingStationsContainer');
                    const currentPosition = stationContainer ? stationContainer.getBoundingClientRect().top + window.scrollY : 0;
                    
                    loadChargingStations(city, parseInt(page)).then(() => {
                        // 还原滚动位置
                        if (currentPosition) {
                            setTimeout(() => {
                                const cardElement = stationContainer.closest('.card');
                                if (cardElement) {
                                    const cardOffset = cardElement.getBoundingClientRect().top + window.scrollY;
                                    window.scrollTo({
                                        top: cardOffset,
                                        behavior: 'instant'
                                    });
                                } else {
                                    window.scrollTo({
                                        top: currentPosition,
                                        behavior: 'instant'
                                    });
                                }
                            }, 10);
                        }
                    });
                }
            }
        });

        // 初始化车辆搜索条件记忆功能
        initializeSearchMemory();
    });

    // 表格分页跳转功能现在由vehicle_table.js处理

    // 绑定表格相关事件
    function bindTableEvents() {
        // 绑定查看详情按钮事件
        const viewButtons = document.querySelectorAll('.view-vehicle-btn');
        viewButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const vehicleId = this.getAttribute('data-vehicle-id');
                showVehicleDetails(vehicleId);
            });
        });
        
        // 绑定删除按钮事件
        const deleteButtons = document.querySelectorAll('.delete-vehicle-btn');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const vehicleId = this.getAttribute('data-vehicle-id');
                // 如果存在confirmDeleteVehicle函数则调用
                if (typeof window.confirmDeleteVehicle === 'function') {
                    window.confirmDeleteVehicle(vehicleId);
                } else {
                    const deleteForm = document.getElementById('deleteForm');
                    if (deleteForm) {
                        deleteForm.action = `/vehicles/delete/${vehicleId}`;
                        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                        deleteModal.show();
                    }
                }
            });
        });
        
        // 绑定编辑按钮事件
        const editButtons = document.querySelectorAll('.edit-vehicle-btn');
        editButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const vehicleId = this.getAttribute('data-vehicle-id');
                // 从URL获取当前页码和搜索参数
                const currentUrl = new URL(window.location.href);
                const page = currentUrl.searchParams.get('page') || 1;
                
                // 构建编辑URL，保留当前页码和所有搜索参数
                let editUrl = `/vehicles/edit_vehicle/${vehicleId}?page=${page}`;
                
                // 添加其他所有查询参数（除了页码、ajax和include_stats）
                currentUrl.searchParams.forEach((value, key) => {
                    if (key !== 'page' && key !== 'ajax' && key !== 'include_stats') {
                        editUrl += `&${key}=${value}`;
                    }
                });
                
                // 在localStorage中存储当前页码，以便编辑完成后可以返回
                localStorage.setItem('vehicleCurrentPage', page);
                
                // 跳转到编辑页面
                window.location.href = editUrl;
            });
        });
        
        // 绑定开始维护按钮事件
        const startMaintenanceButtons = document.querySelectorAll('.start-maintenance-btn');
        startMaintenanceButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const vehicleId = this.getAttribute('data-vehicle-id');
                console.log('点击了开始维护按钮，车辆ID:', vehicleId);
                
                if (!confirm('确定要将车辆设置为维护状态吗？')) {
                    return;
                }
                
                fetch(`/vehicles/api/start_maintenance/${vehicleId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast(data.message, 'success');
                        // 刷新页面显示最新状态
                        window.location.reload();
                    } else if (data.status === 'info') {
                        showToast(data.message, 'info');
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('开始维护操作失败:', error);
                    showToast('操作失败，请稍后重试', 'danger');
                });
            });
        });
        
        // 绑定结束维护按钮事件
        const endMaintenanceButtons = document.querySelectorAll('.end-maintenance-btn');
        endMaintenanceButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const vehicleId = this.getAttribute('data-vehicle-id');
                console.log('点击了结束维护按钮，车辆ID:', vehicleId);
                
                if (!confirm('确定要结束车辆维护吗？车辆电量将恢复到100%。')) {
                    return;
                }
                
                fetch(`/vehicles/api/end_maintenance/${vehicleId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast(data.message, 'success');
                        // 刷新页面显示最新状态
                        window.location.reload();
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('结束维护操作失败:', error);
                    showToast('操作失败，请稍后重试', 'danger');
                });
            });
        });
    }

    // 显示Toast提示消息
    function showToast(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        $('#toast-container').append(toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {delay: 3000});
        toast.show();
        
        // 自动移除
        toastElement.addEventListener('hidden.bs.toast', function() {
            $(this).remove();
        });
    }

    // 初始化搜索条件记忆功能
    function initializeSearchMemory() {
        // 搜索表单相关元素
        const searchForm = document.getElementById('vehicleSearchForm');
        if (!searchForm) return;

        // 绑定搜索表单提交事件，保存搜索条件
        searchForm.addEventListener('submit', function(e) {
            const formData = new FormData(this);
            const searchParams = {};
            
            // 收集非空搜索参数
            for (const [key, value] of formData.entries()) {
                if (value) {
                    searchParams[key] = value;
                }
            }
            
            // 保存到localStorage
            localStorage.setItem('vehicleSearchParams', JSON.stringify(searchParams));
            // 不阻止表单提交
        });

        // 从URL加载搜索参数并保存到localStorage
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString()) {
            const searchParams = {};
            for (const [key, value] of urlParams.entries()) {
                if (value && key !== 'page' && key !== 'ajax' && key !== 'include_stats') {
                    searchParams[key] = value;
                }
            }
            
            // 如果URL中有搜索参数，保存到localStorage
            if (Object.keys(searchParams).length > 0) {
                localStorage.setItem('vehicleSearchParams', JSON.stringify(searchParams));
            }
        }
        
        // 检查localStorage中是否有保存的页码
        if (urlParams.has('page')) {
            localStorage.setItem('vehicleCurrentPage', urlParams.get('page'));
        }
        
        // 清除所有搜索参数时，同时清除localStorage
        const clearButton = document.querySelector('button[onclick="clearAllSearchParams()"]');
        if (clearButton) {
            const originalClearFunc = clearAllSearchParams;
            window.clearAllSearchParams = function() {
                localStorage.removeItem('vehicleSearchParams');
                localStorage.removeItem('vehicleCurrentPage');
                originalClearFunc();
            };
        }
        
        // 移除单个搜索参数时更新localStorage
        const originalRemoveFunc = removeSearchParam;
        window.removeSearchParam = function(field) {
            const searchParams = JSON.parse(localStorage.getItem('vehicleSearchParams') || '{}');
            delete searchParams[field];
            localStorage.setItem('vehicleSearchParams', JSON.stringify(searchParams));
            originalRemoveFunc(field);
        };
    }

    // 修改移除单个搜索参数的函数
    function removeSearchParam(field) {
        // 获取当前URL
        const currentUrl = new URL(window.location.href);
        // 删除指定的搜索参数
        currentUrl.searchParams.delete(field);
        // 跳转到新的URL
        window.location.href = currentUrl.toString();
    }

    // 清除所有搜索参数
    function clearAllSearchParams() {
        // 获取当前URL的基础部分（不包含查询参数）
        const baseUrl = window.location.href.split('?')[0];
        // 跳转到没有任何查询参数的页面
        window.location.href = baseUrl;
    }

    // 在页面加载时应用已保存的搜索条件（如果不是从搜索页面过来）
    document.addEventListener('DOMContentLoaded', function() {
        // 只有当URL中没有搜索参数时，才从localStorage加载
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.toString() && window.location.pathname === '/vehicles/') {
            const savedParams = localStorage.getItem('vehicleSearchParams');
            const savedPage = localStorage.getItem('vehicleCurrentPage');
            
            if (savedParams) {
                try {
                    const searchParams = JSON.parse(savedParams);
                    if (Object.keys(searchParams).length > 0) {
                        // 构建带有搜索条件的URL
                        const url = new URL(window.location.origin + '/vehicles/advanced_search');
                        
                        // 添加所有搜索参数
                        for (const [key, value] of Object.entries(searchParams)) {
                            url.searchParams.append(key, value);
                        }
                        
                        // 添加页码
                        if (savedPage) {
                            url.searchParams.append('page', savedPage);
                        }
                        
                        // 跳转到带有搜索条件的URL
                        window.location.href = url.toString();
                    }
                } catch (e) {
                    console.error('解析保存的搜索参数出错:', e);
                }
            }
        }
    });

    // ... 其余的脚本保持不变 ...
</script>
{% endblock %} 